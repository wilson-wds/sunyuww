<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å·¥å» å”ä½œç®¡ç†ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: { extend: { fontFamily: { sans: ['Noto Sans TC', 'sans-serif'] } } }
        }
    </script>
    <style>
        /* è‡ªå®šç¾©æ»¾å‹•æ¢ */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        
        /* ç”˜ç‰¹åœ–ä½ˆå±€è®Šæ•¸ */
        :root {
            --name-width: 220px; /* ä»»å‹™åç¨±æ¬„ä½é è¨­å¯¬åº¦ */
            --grid-cols: 620px; /* å·¦å´åˆ—è¡¨ç¸½å¯¬åº¦ */
            --timeline-width: 1200px;
        }

        /* Gantt Layout */
        .gantt-container { overflow: auto; height: 100%; position: relative; }
        .gantt-grid-layout { 
            display: grid; 
            grid-template-columns: var(--grid-cols) 1fr; 
            min-width: calc(var(--grid-cols) + var(--timeline-width)); 
        }

        /* å‡çµçª—æ ¼ */
        .sticky-left { position: sticky; left: 0; z-index: 20; background: white; border-right: 2px solid #64748b; }
        .sticky-header { position: sticky; top: 0; z-index: 30; background: #f1f5f9; border-bottom: 2px solid #64748b; }
        .sticky-corner { position: sticky; left: 0; top: 0; z-index: 40; background: #f1f5f9; border-right: 2px solid #64748b; border-bottom: 2px solid #64748b; }

        /* å¼·åŒ–è¡¨æ ¼ç·šæ¢ */
        .gantt-row { border-bottom: 1px solid #94a3b8; transition: background-color 0.2s, border-top 0.1s; }
        .gantt-cell-border { border-right: 1px solid #94a3b8; }
        .gantt-timeline-cell { flex-shrink: 0; border-right: 1px solid #cbd5e1; text-align: center; position: relative; }

        /* Task Bars */
        .gantt-bar { position: absolute; height: 20px; top: 10px; border-radius: 4px; cursor: grab; transition: all 0.2s; box-shadow: 0 1px 2px rgba(0,0,0,0.1); font-size: 11px; display: flex; items-center; padding-left: 8px; color: white; overflow: hidden; z-index: 10; white-space: nowrap; }
        .gantt-bar:hover { filter: brightness(110%); transform: translateY(-1px); z-index: 25; box-shadow: 0 4px 6px rgba(0,0,0,0.2); }
        .gantt-bar:active { cursor: grabbing; }
        
        /* Parent Task Bar */
        .gantt-bar.is-parent { height: 12px; top: 14px; border-radius: 6px; background: #334155; opacity: 0.95; cursor: default; }
        .gantt-bar.is-parent::before, .gantt-bar.is-parent::after { content: ''; position: absolute; top: 100%; width: 0; height: 0; border-style: solid; }
        .gantt-bar.is-parent::before { left: 0; border-width: 6px 6px 0 0; border-color: #334155 transparent transparent transparent; }
        .gantt-bar.is-parent::after { right: 0; border-width: 6px 0 0 6px; border-color: #334155 transparent transparent transparent; }

        /* Parent Row Styling - Screen (Darker Slate-300) */
        .gantt-row.is-parent-row { background-color: #cbd5e1 !important; font-weight: 700; color: #0f172a; border-bottom: 1px solid #64748b; }
        .gantt-row.is-parent-row:hover { background-color: #94a3b8 !important; }

        /* Today Marker */
        .today-line { position: absolute; top: 0; bottom: 0; left: 50%; transform: translateX(-50%); width: 2px; background-color: rgba(239, 68, 68, 0.8); z-index: 15; pointer-events: none; }
        .today-label { position: absolute; top: 0; background: #ef4444; color: white; font-size: 10px; padding: 0 4px; border-radius: 0 0 4px 4px; left: 50%; transform: translateX(-50%); z-index: 16; white-space: nowrap; }

        .gantt-row:hover { background-color: #f1f5f9; }
        .gantt-timeline-row:hover { background-color: #f8fafc; }

        /* Drag & Drop Styles */
        .draggable-handle { cursor: move; user-select: none; }
        .gantt-row.dragging { opacity: 0.5; background: #f0f9ff; }
        .gantt-row.drag-over-top { border-top: 2px solid #3b82f6 !important; }
        .gantt-row.drag-over-bottom { border-bottom: 2px solid #3b82f6 !important; }

        /* Column Resizer */
        .col-resizer {
            position: absolute; right: 0; top: 0; bottom: 0; width: 6px;
            cursor: col-resize; z-index: 50; opacity: 0; transition: opacity 0.2s;
        }
        .header-cell-resizable:hover .col-resizer, .col-resizer:hover, .col-resizer.resizing {
            opacity: 1; background: rgba(59, 130, 246, 0.5);
        }

        @media print {
            .no-print { display: none !important; }
            .print-show { display: block !important; }
            body { height: auto !important; overflow: visible !important; -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
            .gantt-container { overflow: visible; }
            /* Parent Row Styling - Print (Even Darker Slate-400 for contrast) */
            .gantt-row.is-parent-row { background-color: #94a3b8 !important; -webkit-print-color-adjust: exact; }
            .gantt-bar { -webkit-print-color-adjust: exact; }
            .gantt-row, .gantt-cell-border, .gantt-timeline-cell, .sticky-left, .sticky-header, .sticky-corner { border-color: #000 !important; }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans h-screen flex overflow-hidden">

    <!-- å´é‚Šå°èˆª -->
    <aside class="w-64 bg-slate-800 text-white flex-shrink-0 flex flex-col no-print transition-all duration-300 z-30" id="sidebar">
        <div class="p-6 text-xl font-bold border-b border-slate-700 flex items-center gap-2">
            <span>ğŸ­</span> å·¥å» å”ä½œç³»çµ±
        </div>
        <nav class="flex-1 p-4 space-y-2">
            <button onclick="window.app.switchTab('todo')" class="nav-btn w-full text-left px-4 py-3 rounded hover:bg-slate-700 bg-slate-700 transition-colors" data-tab="todo">ğŸ“‹ å¾…ä¿®æ”¹æ˜ç´°</button>
            <button onclick="window.app.switchTab('event')" class="nav-btn w-full text-left px-4 py-3 rounded hover:bg-slate-700 transition-colors" data-tab="event">ğŸ“… äº‹ä»¶è¿½è¹¤</button>
            <button onclick="window.app.switchTab('feedback')" class="nav-btn w-full text-left px-4 py-3 rounded hover:bg-slate-700 transition-colors" data-tab="feedback">ğŸ’¬ å•é¡Œåé¥‹</button>
            <button onclick="window.app.switchTab('gantt')" class="nav-btn w-full text-left px-4 py-3 rounded hover:bg-slate-700 transition-colors" data-tab="gantt">ğŸ“Š å‘¨è¨ˆç•«æ’ç¨‹</button>
        </nav>
        <div class="p-4 text-xs text-slate-400 border-t border-slate-700" id="auth-status">é€£ç·šä¸­...</div>
    </aside>

    <!-- ä¸»å…§å®¹å€ -->
    <main class="flex-1 flex flex-col min-w-0 bg-white relative">
        <!-- é ‚éƒ¨å·¥å…·åˆ— -->
        <header class="h-16 border-b-2 border-slate-300 flex items-center justify-between px-6 bg-white no-print flex-shrink-0 z-20 shadow-sm">
            <h1 id="page-title" class="text-2xl font-bold text-slate-800">å¾…ä¿®æ”¹æ˜ç´°</h1>
            <div class="flex gap-2" id="header-actions">
                <!-- å‹•æ…‹æ³¨å…¥æŒ‰éˆ• -->
            </div>
        </header>

        <!-- å…§å®¹å®¹å™¨ -->
        <div id="app-container" class="flex-1 overflow-hidden relative bg-gray-50 flex flex-col">
            <!-- Loading -->
            <div id="loading" class="absolute inset-0 flex items-center justify-center bg-white/80 z-50 backdrop-blur-sm">
                <div class="flex flex-col items-center">
                    <div class="animate-spin rounded-full h-12 w-12 border-4 border-indigo-200 border-t-indigo-600 mb-3"></div>
                    <div class="text-indigo-600 font-medium animate-pulse">è³‡æ–™è¼‰å…¥ä¸­...</div>
                </div>
            </div>

            <!-- Views -->
            <div id="view-todo" class="view-section space-y-4 hidden p-6 overflow-auto h-full"></div>
            <div id="view-event" class="view-section space-y-4 hidden p-6 overflow-auto h-full"></div>
            <div id="view-feedback" class="view-section space-y-4 hidden p-6 overflow-auto h-full"></div>
            <!-- Gantt View -->
            <div id="view-gantt" class="view-section hidden h-full flex flex-col"></div>
        </div>
    </main>

    <!-- çµ±ä¸€ Modal -->
    <div id="uni-modal" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center p-4 no-print backdrop-blur-sm transition-opacity">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col transform transition-transform scale-100 border border-slate-300">
            <div class="p-5 border-b border-slate-300 flex justify-between items-center bg-gray-100 rounded-t-xl">
                <h3 id="modal-title" class="text-xl font-bold text-gray-800"></h3>
                <button onclick="window.modal.close()" class="text-gray-500 hover:text-red-500 text-2xl w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-200 transition-colors">&times;</button>
            </div>
            <div id="modal-body" class="p-6 overflow-y-auto"></div>
            <div id="modal-footer" class="p-4 border-t border-slate-300 flex justify-end gap-3 bg-gray-50 rounded-b-xl"></div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-6 right-6 bg-slate-800 text-white px-6 py-4 rounded-lg shadow-xl transform translate-y-32 transition-transform duration-300 z-50 flex items-center gap-3">
        <span id="toast-icon">âœ…</span>
        <span id="toast-msg" class="font-medium">Notification</span>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, serverTimestamp, query, orderBy, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Config & Utils ---
        const CONFIG = {
            firebase: JSON.parse(`{"apiKey":"AIzaSyA7IeOz4EJ-yMUccDTPOSaDm33fLChVD8Q","authDomain":"sunyu-check.firebaseapp.com","projectId":"sunyu-check","storageBucket":"sunyu-check.appspot.com","messagingSenderId":"627211744361","appId":"1:627211744361:web:58bce4b5009f0c9d5bdef8"}`),
            appId: "sunyu-check",
            cols: {
                todo: [
                    { k: 'status', l: 'ç‹€æ…‹', w: '100px', render: r => r.completed ? '<span class="px-2 py-1 rounded text-xs font-medium bg-gray-100 text-gray-600 border border-gray-400">å·²å®Œæˆ</span>' : '<span class="px-2 py-1 rounded text-xs font-medium bg-blue-50 text-blue-700 border border-blue-300">å¾…è™•ç†</span>' },
                    { k: 'productionId', l: 'ç”Ÿç”¢ç·¨è™Ÿ', w: '120px' }, 
                    { k: 'partNumber', l: 'æ–™è™Ÿ', w: '120px' }, 
                    { k: 'content', l: 'ä¿®æ”¹å…§å®¹', w: 'auto' },
                    { k: 'date', l: 'æ—¥æœŸ', w: '120px' },
                    { k: 'actions', l: 'æ“ä½œ', type: 'actions', w: '140px' }
                ],
                event: [
                    { k: 'priority', l: 'å„ªå…ˆ', w: '80px', render: r => `<div class="flex justify-center"><span class="w-6 h-6 rounded-full flex items-center justify-center text-white text-xs font-bold shadow-sm ${r.priority==='high'?'bg-red-600 ring-1 ring-red-800':r.priority==='low'?'bg-green-600 ring-1 ring-green-800':'bg-amber-500 ring-1 ring-amber-700'}">${r.priority==='high'?'1':r.priority==='low'?'3':'2'}</span></div>` },
                    { k: 'date', l: 'æ—¥æœŸ', w: '120px' }, 
                    { k: 'matter', l: 'äº‹é …å…§å®¹', w: 'auto' }, 
                    { k: 'personnel', l: 'ç›¸é—œäººå“¡', w: '150px' },
                    { k: 'closed', l: 'ç‹€æ…‹', w: '100px', render: r => r.closed ? '<span class="text-gray-500 font-bold">âœ… å·²çµæ¡ˆ</span>' : '<span class="text-emerald-700 font-bold">âš¡ é€²è¡Œä¸­</span>' },
                    { k: 'actions', l: 'æ“ä½œ', type: 'actions', w: '180px' }
                ],
                feedback: [
                    { k: 'feedbackType', l: 'é¡å‹', w: '120px', render: r => `<span class="px-2 py-1 rounded text-xs bg-slate-200 text-slate-800 font-bold border border-slate-400">${r.feedbackType}</span>` }, 
                    { k: 'problem', l: 'å•é¡Œæè¿°', w: '40%' }, 
                    { k: 'solution', l: 'è§£æ±ºæ–¹æ¡ˆ', w: 'auto' },
                    { k: 'status', l: 'ç‹€æ…‹', w: '100px', render: r => r.status === 'å·²çµæ¡ˆ' ? '<span class="text-green-700 font-bold">å·²çµæ¡ˆ</span>' : '<span class="text-amber-600 font-bold">è™•ç†ä¸­</span>' }, 
                    { k: 'actions', l: 'æ“ä½œ', type: 'actions', w: '100px' }
                ]
            }
        };

        const utils = {
            $: (s) => document.querySelector(s),
            date: (d = new Date()) => d.toISOString().split('T')[0],
            toast: (msg, icon='âœ…') => {
                const t = utils.$('#toast'); 
                utils.$('#toast-msg').textContent = msg;
                utils.$('#toast-icon').textContent = icon;
                t.classList.remove('translate-y-32');
                setTimeout(() => t.classList.add('translate-y-32'), 3000);
            },
            badge: 'px-2 py-1 rounded text-xs font-medium',
            addWorkingDays: (startDateStr, days) => {
                if (!startDateStr || !days) return '-';
                let current = new Date(startDateStr);
                let remaining = parseInt(days);
                while (remaining > 0) {
                    const day = current.getDay();
                    if (day !== 0 && day !== 6) { remaining--; }
                    if (remaining > 0) { current.setDate(current.getDate() + 1); }
                }
                return current.toISOString().split('T')[0];
            },
            countWorkingDays: (startStr, endStr) => {
                let start = new Date(startStr);
                let end = new Date(endStr);
                let count = 0;
                let cur = new Date(start);
                while(cur <= end) {
                    const day = cur.getDay();
                    if(day !== 0 && day !== 6) count++;
                    cur.setDate(cur.getDate() + 1);
                }
                return count;
            },
            addDays: (dateStr, days) => {
                const d = new Date(dateStr);
                d.setDate(d.getDate() + days);
                return d.toISOString().split('T')[0];
            }
        };

        // --- Firebase Service ---
        class FirestoreService {
            constructor() {
                const app = initializeApp(CONFIG.firebase);
                this.auth = getAuth(app);
                this.db = getFirestore(app);
                this.coll = collection(this.db, `/artifacts/${CONFIG.appId}/public/data/sharedTodoItems`);
                this.user = null;
            }
            async init() {
                return new Promise(resolve => {
                    onAuthStateChanged(this.auth, async (u) => {
                        this.user = u || await signInAnonymously(this.auth).then(c => c.user);
                        utils.$('#auth-status').textContent = `ä½¿ç”¨è€… ID: ${this.user.uid.slice(0,6)}...`;
                        resolve(this.user);
                    });
                });
            }
            sub(cb) {
                return onSnapshot(query(this.coll, orderBy("createdAt", "desc")), (snap) => {
                    const data = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    cb(data);
                });
            }
            async add(data) { await addDoc(this.coll, { ...data, createdAt: serverTimestamp() }); utils.toast('æ–°å¢æˆåŠŸ'); }
            async update(id, data) { await updateDoc(doc(this.coll, id), data); utils.toast('æ›´æ–°æˆåŠŸ'); }
            async del(id) { 
                if(confirm('ç¢ºå®šè¦åˆªé™¤æ­¤é …ç›®å—ï¼Ÿå¦‚æœé€™æ˜¯çˆ¶ä»»å‹™ï¼Œå»ºè­°å…ˆç§»é™¤å­ä»»å‹™çš„é—œè¯ã€‚')) { 
                    await deleteDoc(doc(this.coll, id)); 
                    utils.toast('å·²åˆªé™¤', 'ğŸ—‘ï¸'); 
                    return true;
                }
                return false;
            }
            async batchUpdateOrders(updates) {
                const batch = writeBatch(this.db);
                updates.forEach(({id, order}) => {
                    const ref = doc(this.coll, id);
                    batch.update(ref, { order });
                });
                await batch.commit();
                utils.toast('æ’åºå·²æ›´æ–°');
            }
        }
        const db = new FirestoreService();

        // --- UI Components ---
        const modal = {
            el: utils.$('#uni-modal'),
            open(title, bodyHtml, footerHtml = '') {
                utils.$('#modal-title').textContent = title;
                utils.$('#modal-body').innerHTML = bodyHtml;
                utils.$('#modal-footer').innerHTML = footerHtml;
                this.el.classList.remove('hidden');
                this.el.classList.add('flex');
                setTimeout(() => utils.$('#uni-modal > div').classList.remove('scale-95', 'opacity-0'), 10);
            },
            close() { 
                utils.$('#uni-modal > div').classList.add('scale-95', 'opacity-0');
                setTimeout(() => {
                    this.el.classList.add('hidden'); 
                    this.el.classList.remove('flex');
                }, 200);
            }
        };
        window.modal = modal;

        const renderer = {
            table(items, cols, type) {
                if (!items.length) return `
                    <div class="flex flex-col items-center justify-center py-16 bg-white rounded-lg border-2 border-dashed border-slate-300">
                        <div class="text-4xl mb-3">ğŸ“­</div>
                        <div class="text-gray-500 font-medium">ç›®å‰å°šç„¡è³‡æ–™</div>
                    </div>`;
                return `
                <div class="overflow-x-auto border border-slate-400 rounded-lg shadow-sm bg-white">
                    <table class="min-w-full divide-y divide-slate-400">
                        <thead class="bg-slate-100"><tr>${cols.map(c => `<th class="px-6 py-4 text-left text-xs font-bold text-slate-700 uppercase tracking-wider border-b-2 border-slate-400">${c.l}</th>`).join('')}</tr></thead>
                        <tbody class="divide-y divide-slate-300 bg-white">
                            ${items.map(item => `
                                <tr class="hover:bg-indigo-50/30 transition-colors group">
                                    ${cols.map(c => {
                                        if (c.type === 'actions') return `
                                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium opacity-0 group-hover:opacity-100 transition-opacity border-r border-slate-200">
                                                <div class="flex items-center gap-3">
                                                    <button onclick="window.app.handlers.edit('${type}', '${item.id}')" class="text-indigo-700 hover:text-indigo-900 flex items-center gap-1 font-bold"><span class="text-lg">âœ</span> ç·¨è¼¯</button>
                                                    <button onclick="window.app.handlers.del('${item.id}')" class="text-red-700 hover:text-red-900 flex items-center gap-1 font-bold"><span class="text-lg">Ã—</span> åˆªé™¤</button>
                                                    ${type === 'event' ? `<button onclick="window.app.handlers.toGantt('${item.id}')" class="text-blue-700 hover:text-blue-900 ml-2 font-bold bg-blue-100 px-2 py-1 rounded border border-blue-300">ï¼‹æ’ç¨‹</button>` : ''}
                                                </div>
                                            </td>`;
                                        return `<td class="px-6 py-4 text-sm text-slate-800 border-r border-slate-200" style="${c.w ? `min-width:${c.w}`:''}">${c.render ? c.render(item) : (item[c.k] || '-')}</td>`;
                                    }).join('')}
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>`;
            },
            form(fields, type) {
                return fields.map(f => `
                    <div class="mb-5">
                        <label class="block text-sm font-bold text-slate-700 mb-2">${f.label}</label>
                        ${f.type === 'select' 
                            ? `<div class="relative"><select name="${f.name}" class="w-full border-2 border-slate-300 rounded-lg p-2.5 bg-white focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none appearance-none font-medium text-slate-700">${f.opts.map(o => {
                                const val = typeof o === 'object' ? o.v : o;
                                const lbl = typeof o === 'object' ? o.l : o;
                                return `<option value="${val}" ${f.val == val ? 'selected' : ''}>${lbl}</option>`;
                            }).join('')}</select><div class="absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none text-gray-600">â–¼</div></div>`
                            : f.type === 'textarea' 
                                ? `<textarea name="${f.name}" rows="4" class="w-full border-2 border-slate-300 rounded-lg p-2.5 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none font-medium text-slate-700" placeholder="è«‹è¼¸å…¥${f.label}...">${f.val||''}</textarea>`
                                : `<input type="${f.type||'text'}" name="${f.name}" class="w-full border-2 border-slate-300 rounded-lg p-2.5 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none font-medium text-slate-700" value="${f.val||''}" placeholder="${f.placeholder||''}">`
                        }
                    </div>
                `).join('');
            }
        };

        // --- Enhanced Gantt Manager ---
        class GanttManager {
            constructor() {
                this.zoom = 40; 
                this.viewStart = new Date();
                this.viewStart.setDate(this.viewStart.getDate() - 3); 
                this.daysToShow = 45; 
                this.filterAssignee = '';
                this.hideCompleted = false;
                this.showProgressCol = true;
                
                this.nameColWidth = 180;
                this.isResizing = false;
                
                // Drag Drop State
                this.draggedId = null;
                this.dragOverId = null;
                this.dragPosition = null; 
            }

            setView(mode) {
                const d = new Date(this.viewStart);
                if (mode === 'prev') d.setDate(d.getDate() - 7);
                if (mode === 'next') d.setDate(d.getDate() + 7);
                if (mode === 'today') {
                    const now = new Date();
                    now.setDate(now.getDate() - 2); 
                    this.viewStart = now;
                    app.render();
                    return;
                }
                this.viewStart = d;
                app.render();
            }

            setZoom(delta) {
                const oldZoom = this.zoom;
                this.zoom = Math.max(20, Math.min(100, this.zoom + delta));
                if (this.zoom < oldZoom) {
                    this.daysToShow += 5;
                } else {
                    this.daysToShow = Math.max(14, this.daysToShow - 2);
                }
                app.render();
            }

            setFilter(assignee) {
                this.filterAssignee = assignee;
                app.render();
            }
            
            toggleCompleted(checked) {
                this.hideCompleted = checked;
                app.render();
            }

            toggleProgressCol(checked) {
                this.showProgressCol = checked;
                this.updateLayout(); 
                app.render();
            }
            
            startResize(e) {
                e.preventDefault();
                e.stopPropagation();
                this.isResizing = true;
                this.startX = e.pageX;
                this.startWidth = this.nameColWidth;
                
                const moveHandler = (e) => {
                    if (!this.isResizing) return;
                    const diff = e.pageX - this.startX;
                    const newWidth = Math.max(120, this.startWidth + diff); 
                    this.nameColWidth = newWidth;
                    this.updateLayout();
                    app.render(); 
                };
                
                const upHandler = () => {
                    this.isResizing = false;
                    document.removeEventListener('mousemove', moveHandler);
                    document.removeEventListener('mouseup', upHandler);
                };
                
                document.addEventListener('mousemove', moveHandler);
                document.addEventListener('mouseup', upHandler);
            }
            
            updateLayout() {
                const container = utils.$('#view-gantt');
                if (!container) return;
                const fixedWidths = 60 + 80 + 80 + 50 + 70 + (this.showProgressCol ? 60 : 0);
                const totalGridWidth = this.nameColWidth + fixedWidths;
                container.style.setProperty('--name-width', `${this.nameColWidth}px`);
                container.style.setProperty('--grid-cols', `${totalGridWidth}px`);
            }

            // --- Drag & Drop Handlers (Row Reorder) ---
            handleDragStart(e, id) {
                this.draggedId = id;
                e.dataTransfer.effectAllowed = 'move';
                e.target.closest('.gantt-row').classList.add('dragging');
            }

            handleDragOver(e, id) {
                e.preventDefault();
                if (this.draggedId === id) return;
                
                const row = e.target.closest('.gantt-row');
                const rect = row.getBoundingClientRect();
                const mid = rect.top + rect.height / 2;
                
                this.dragOverId = id;
                this.dragPosition = e.clientY < mid ? 'top' : 'bottom';
                
                document.querySelectorAll('.gantt-row').forEach(r => r.classList.remove('drag-over-top', 'drag-over-bottom'));
                if (this.dragPosition === 'top') row.classList.add('drag-over-top');
                else row.classList.add('drag-over-bottom');
            }

            async handleDrop(e, targetId) {
                e.preventDefault();
                document.querySelectorAll('.gantt-row').forEach(r => r.classList.remove('dragging', 'drag-over-top', 'drag-over-bottom'));
                
                if (!this.draggedId || this.draggedId === targetId) return;

                const draggedTask = app.data.find(t => t.id === this.draggedId);
                const targetTask = app.data.find(t => t.id === targetId);

                if (!draggedTask || !targetTask) return;

                if (draggedTask.parentId !== targetTask.parentId) {
                    utils.toast('âŒ åªèƒ½åœ¨åŒä¸€å±¤ç´šå…§æ’åº', 'âš ï¸');
                    return;
                }

                const siblings = app.data.filter(t => t.type === 'gantt' && t.parentId === draggedTask.parentId)
                                         .sort((a,b) => (a.order||0) - (b.order||0));
                
                const draggedIdx = siblings.findIndex(t => t.id === this.draggedId);
                siblings.splice(draggedIdx, 1); 
                const targetIdx = siblings.findIndex(t => t.id === targetId);
                
                const insertIdx = this.dragPosition === 'top' ? targetIdx : targetIdx + 1;
                siblings.splice(insertIdx, 0, draggedTask);

                const updates = siblings.map((t, idx) => ({ id: t.id, order: idx }));
                await db.batchUpdateOrders(updates);
                
                this.draggedId = null;
            }

            // --- Bar Drag Handler (Date Modify) ---
            handleBarDragStart(e, id, isSummary) {
                e.preventDefault(); 
                e.stopPropagation(); 

                if (isSummary) {
                    utils.toast('âš ï¸ æ‘˜è¦ä»»å‹™ç„¡æ³•ç§»å‹•', 'ğŸ”’');
                    return;
                }

                const task = app.data.find(t => t.id === id);
                if (!task) return;

                const barEl = e.currentTarget;
                const startX = e.pageX;
                let isDragging = false;

                // Visual feedback
                barEl.style.cursor = 'grabbing';
                barEl.style.transition = 'none';

                const moveHandler = (e) => {
                    const diff = e.pageX - startX;
                    if (Math.abs(diff) > 5) isDragging = true;
                    barEl.style.transform = `translateX(${diff}px)`;
                };

                const upHandler = async (e) => {
                    document.removeEventListener('mousemove', moveHandler);
                    document.removeEventListener('mouseup', upHandler);
                    
                    barEl.style.cursor = 'grab';
                    barEl.style.transition = ''; 
                    barEl.style.transform = ''; 

                    if (!isDragging) {
                        window.app.handlers.edit('gantt', id);
                    } else {
                        const diff = e.pageX - startX;
                        const daysDiff = Math.round(diff / this.zoom);
                        
                        if (daysDiff !== 0) {
                            const newStart = utils.addDays(task.start, daysDiff);
                            await db.update(id, { start: newStart });
                            utils.toast(`ğŸ“… æ—¥æœŸå·²æ›´æ–°`);
                        }
                    }
                };

                document.addEventListener('mousemove', moveHandler);
                document.addEventListener('mouseup', upHandler);
            }

            processTasks(tasks) {
                const taskMap = new Map();
                tasks.forEach(t => taskMap.set(t.id, { ...t, children: [] }));

                const roots = [];
                tasks.forEach(t => {
                    const task = taskMap.get(t.id);
                    if (t.parentId && taskMap.has(t.parentId)) {
                        taskMap.get(t.parentId).children.push(task);
                    } else {
                        roots.push(task);
                    }
                });

                const sortFn = (a, b) => (a.order || 0) - (b.order || 0);
                const flatList = [];
                
                const processNode = (node, level, prefix) => {
                    node.wbs = prefix; 

                    if (node.children.length > 0) {
                        node.children.sort(sortFn);
                        const childTimes = node.children.map(c => {
                            if (c.suspended) return null; 
                            const start = new Date(c.start);
                            const endStr = utils.addWorkingDays(c.start, c.duration);
                            return { start: start.getTime(), end: new Date(endStr).getTime() };
                        }).filter(t => t && !isNaN(t.start));
                        
                        if (childTimes.length) {
                            const minStart = Math.min(...childTimes.map(t => t.start));
                            const maxEnd = Math.max(...childTimes.map(t => t.end));
                            node.start = new Date(minStart).toISOString().split('T')[0];
                            const endDateStr = new Date(maxEnd).toISOString().split('T')[0];
                            node.duration = utils.countWorkingDays(node.start, endDateStr);
                            
                            let totalDur = 0;
                            let weightedProg = 0;
                            node.children.forEach(c => {
                                if(!c.suspended) {
                                    const dur = parseInt(c.duration)||1;
                                    totalDur += dur;
                                    weightedProg += dur * (parseInt(c.progress)||0);
                                }
                            });
                            node.progress = totalDur ? Math.round(weightedProg / totalDur) : 0;
                            node.isSummary = true;
                        }
                    }

                    node.endDate = utils.addWorkingDays(node.start, node.duration);
                    if (this.hideCompleted && parseInt(node.progress) === 100) return;

                    flatList.push({ ...node, level });
                    node.children.forEach((c, i) => processNode(c, level + 1, `${prefix}.${i + 1}`));
                };

                roots.sort(sortFn).forEach((root, i) => processNode(root, 0, (i + 1).toString()));
                return flatList;
            }

            render(allTasks) {
                const container = utils.$('#view-gantt');
                const assignees = [...new Set(allTasks.map(t => t.assignee).filter(Boolean))].sort();
                
                let filteredTasks = [...allTasks];
                if (this.filterAssignee) {
                    filteredTasks = filteredTasks.filter(t => t.assignee === this.filterAssignee);
                }

                const displayTasks = this.processTasks(filteredTasks);
                const today = new Date();
                const viewStart = new Date(this.viewStart);
                
                const timelinePixelWidth = this.daysToShow * this.zoom;
                container.style.setProperty('--timeline-width', `${timelinePixelWidth}px`);
                this.updateLayout();

                let headerTimeline = '';
                let rowsHTML = '';
                
                for(let i=0; i<this.daysToShow; i++) {
                    const d = new Date(viewStart); d.setDate(d.getDate() + i);
                    const isToday = d.toDateString() === today.toDateString();
                    const isWeekend = d.getDay() === 0 || d.getDay() === 6;
                    const dayLabel = d.getDate();
                    const weekday = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][d.getDay()];

                    headerTimeline += `
                        <div class="gantt-timeline-cell ${isWeekend ? 'bg-slate-100' : ''} ${isToday ? 'bg-red-50' : ''}" style="width:${this.zoom}px">
                            <div class="text-[10px] leading-tight pt-1 ${isToday ? 'text-red-700 font-bold' : 'text-slate-600 font-bold'}">${weekday}</div>
                            <div class="text-sm font-bold ${isToday ? 'text-red-700' : 'text-slate-800'}">${dayLabel}</div>
                            ${isToday ? `<div class="today-label" title="ä»Šå¤©æ˜¯: ${today.toLocaleDateString()}">Today</div><div class="today-line"></div>` : ''}
                        </div>`;
                }

                const gridTemplate = `60px var(--name-width) 80px 80px 50px 70px ${this.showProgressCol ? '60px' : '0px'}`;

                if(!displayTasks.length) {
                    rowsHTML = `<div class="p-12 text-center text-gray-500 font-bold col-span-2 bg-white border border-slate-300 rounded m-4">æ²’æœ‰ç¬¦åˆçš„æ’ç¨‹ä»»å‹™</div>`;
                } else {
                    displayTasks.forEach(t => {
                        const start = new Date(t.start);
                        const dayDiff = Math.ceil((start - viewStart) / (1000 * 60 * 60 * 24));
                        const endDateObj = new Date(t.endDate);
                        const calendarDuration = Math.ceil((endDateObj - start) / (1000 * 60 * 60 * 24)) + 1;
                        const width = Math.max(1, calendarDuration) * this.zoom;
                        const left = dayDiff * this.zoom;
                        
                        const isOverdue = t.progress < 100 && new Date(t.endDate) < today && !t.isSummary && !t.suspended;
                        let barClass = t.isSummary ? 'is-parent' : (t.progress == 100 ? 'bg-emerald-600' : (isOverdue ? 'bg-red-600' : 'bg-indigo-600'));
                        let rowClass = t.isSummary ? 'is-parent-row' : '';

                        let barHTML = '';
                        if (!t.suspended) {
                            barHTML = `
                                <div class="gantt-bar ${barClass} shadow-sm"
                                     style="left:${left}px; width:${width}px;"
                                     onmousedown="window.app.gantt.handleBarDragStart(event, '${t.id}', ${!!t.isSummary})">
                                    ${!t.isSummary ? `<span class="truncate pr-1 drop-shadow-md font-bold">${t.progress}%</span>` : ''}
                                    ${isOverdue ? '<span class="absolute right-1 top-1 w-2 h-2 bg-white rounded-full animate-ping"></span>' : ''}
                                </div>
                            `;
                        }

                        rowsHTML += `
                        <div class="contents group hover:bg-gray-50">
                            <!-- Left Grid -->
                            <div class="gantt-row grid bg-white transition-colors items-center h-[40px] sticky-left cursor-pointer ${rowClass}" 
                                 style="grid-template-columns: ${gridTemplate};"
                                 onclick="window.app.handlers.edit('gantt', '${t.id}')"
                                 draggable="true"
                                 ondragstart="window.app.gantt.handleDragStart(event, '${t.id}')"
                                 ondragover="window.app.gantt.handleDragOver(event, '${t.id}')"
                                 ondrop="window.app.gantt.handleDrop(event, '${t.id}')">
                                <div class="px-2 text-xs text-center font-bold text-slate-600 h-full flex items-center justify-center gantt-cell-border draggable-handle" title="æ‹–æ›³ä»¥æ’åº">${t.wbs}</div>
                                <div class="px-3 ${t.isSummary ? 'text-base font-bold' : 'text-sm font-medium'} truncate gantt-cell-border flex items-center h-full" title="${t.name}">
                                    <span style="width:${t.level * 16}px" class="flex-shrink-0 inline-block"></span>
                                    ${t.level > 0 ? '<span class="text-slate-400 mr-1">â†³</span>' : ''}
                                    <span class="${t.isSummary ? 'text-slate-900' : 'text-slate-700'}">${t.name}</span>
                                    ${t.suspended ? '<span class="ml-2 text-xs bg-red-100 text-red-600 px-1 rounded border border-red-200">æš«ç·©</span>' : ''}
                                </div>
                                <div class="px-2 text-xs text-center gantt-cell-border text-slate-700 h-full flex items-center justify-center font-medium">${t.suspended ? '<span class="text-red-500 font-bold">æš«ç·©</span>' : t.start.slice(5)}</div>
                                <div class="px-2 text-xs text-center gantt-cell-border text-slate-700 h-full flex items-center justify-center font-medium">${t.suspended ? '<span class="text-red-500 font-bold">æš«ç·©</span>' : (t.endDate ? t.endDate.slice(5) : '-')}</div>
                                <div class="px-2 text-xs text-center gantt-cell-border text-slate-700 h-full flex items-center justify-center font-medium">${t.suspended ? '-' : t.duration + 'å¤©'}</div>
                                <div class="px-2 text-xs text-center gantt-cell-border truncate text-slate-700 h-full flex items-center justify-center font-medium">${t.assignee||'-'}</div>
                                ${this.showProgressCol ? `
                                <div class="px-2 text-xs text-center flex items-center justify-center gantt-cell-border h-full">
                                    <span class="px-1.5 rounded font-bold ${t.progress==100?'bg-green-100 text-green-800':'bg-slate-100 text-slate-700'}">${t.progress}%</span>
                                </div>` : ''}
                            </div>
                            
                            <!-- Timeline Row -->
                            <div class="relative h-[40px] border-b border-slate-400 bg-white group-hover:bg-indigo-50/20 gantt-timeline-row">
                                ${Array.from({length: this.daysToShow}).map((_, i) => {
                                    const d = new Date(viewStart); d.setDate(d.getDate() + i);
                                    const isWk = d.getDay() === 0 || d.getDay() === 6;
                                    const isT = d.toDateString() === today.toDateString();
                                    return `<div class="absolute top-0 bottom-0 border-r border-slate-300 ${isWk ? 'bg-slate-100' : ''} ${isT ? 'bg-red-50/30' : ''}" style="left:${i * this.zoom}px; width:${this.zoom}px; z-index: 0;"></div>`
                                }).join('')}
                                ${barHTML}
                            </div>
                        </div>`;
                    });
                }

                container.innerHTML = `
                    <div class="flex flex-col h-full bg-white rounded-lg shadow-sm border-2 border-slate-400">
                        <!-- Toolbar -->
                        <div class="p-3 border-b-2 border-slate-400 bg-white flex flex-wrap gap-3 items-center justify-between no-print flex-shrink-0">
                            <div class="flex items-center gap-4">
                                <div class="flex bg-slate-100 rounded-lg p-1 border border-slate-300">
                                    <button onclick="window.app.gantt.setView('prev')" class="px-3 py-1 text-sm text-slate-700 hover:bg-white hover:shadow rounded transition-all font-bold">â—€</button>
                                    <button onclick="window.app.gantt.setView('today')" class="px-3 py-1 text-sm text-indigo-700 font-bold hover:bg-white hover:shadow rounded transition-all">ä»Šå¤©</button>
                                    <button onclick="window.app.gantt.setView('next')" class="px-3 py-1 text-sm text-slate-700 hover:bg-white hover:shadow rounded transition-all font-bold">â–¶</button>
                                </div>
                                <div class="flex items-center gap-1 text-sm text-slate-700 border border-slate-300 px-2 py-1 rounded bg-slate-50 font-bold">
                                    <span>ğŸ”</span>
                                    <button onclick="window.app.gantt.setZoom(-10)" class="w-6 h-6 flex items-center justify-center rounded hover:bg-slate-200" title="ç¸®å°">-</button>
                                    <button onclick="window.app.gantt.setZoom(10)" class="w-6 h-6 flex items-center justify-center rounded hover:bg-slate-200" title="æ”¾å¤§">+</button>
                                </div>
                                <div class="flex items-center gap-3 text-sm text-slate-800 font-medium">
                                    <label class="flex items-center gap-1 cursor-pointer select-none">
                                        <input type="checkbox" onchange="window.app.gantt.toggleCompleted(this.checked)" ${this.hideCompleted?'checked':''} class="rounded text-indigo-600 focus:ring-indigo-500 border-gray-400">
                                        éš±è—å·²å®Œæˆ
                                    </label>
                                    <label class="flex items-center gap-1 cursor-pointer select-none">
                                        <input type="checkbox" onchange="window.app.gantt.toggleProgressCol(this.checked)" ${this.showProgressCol?'checked':''} class="rounded text-indigo-600 focus:ring-indigo-500 border-gray-400">
                                        é¡¯ç¤ºé€²åº¦æ¬„
                                    </label>
                                </div>
                            </div>
                            
                            <div class="flex items-center gap-3">
                                <select onchange="window.app.gantt.setFilter(this.value)" class="text-sm border-2 border-slate-300 rounded-md px-2 py-1.5 bg-gray-50 focus:ring-2 focus:ring-indigo-500 outline-none font-medium text-slate-700">
                                    <option value="">ğŸ‘¤ æ‰€æœ‰äººå“¡</option>
                                    ${assignees.map(p => `<option value="${p}" ${this.filterAssignee===p?'selected':''}>${p}</option>`).join('')}
                                </select>
                                <button onclick="window.print()" class="flex items-center gap-1 bg-slate-800 text-white px-3 py-1.5 rounded-md text-sm hover:bg-slate-700 transition-colors shadow font-bold">
                                    ğŸ–¨ï¸ åˆ—å°
                                </button>
                            </div>
                        </div>

                        <div class="gantt-container bg-slate-50">
                            <div class="gantt-grid-layout">
                                <div class="sticky-corner h-14 grid divide-x divide-slate-400 bg-slate-100 z-40 border-b-2 border-slate-400" style="grid-template-columns: ${gridTemplate};">
                                    <div class="flex items-center justify-center text-xs font-bold text-slate-700">WBS</div>
                                    <div class="flex items-center justify-center text-xs font-bold text-slate-700 header-cell-resizable relative">
                                        ä»»å‹™åç¨±
                                        <div class="col-resizer" onmousedown="window.app.gantt.startResize(event)"></div>
                                    </div>
                                    <div class="flex items-center justify-center text-xs font-bold text-slate-700">é–‹å§‹</div>
                                    <div class="flex items-center justify-center text-xs font-bold text-slate-700">çµæŸ</div>
                                    <div class="flex items-center justify-center text-xs font-bold text-slate-700">å·¥æœŸ</div>
                                    <div class="flex items-center justify-center text-xs font-bold text-slate-700">è² è²¬äºº</div>
                                    ${this.showProgressCol ? '<div class="flex items-center justify-center text-xs font-bold text-slate-700">é€²åº¦</div>' : ''}
                                </div>
                                <div class="sticky-header h-14 flex relative overflow-hidden bg-white z-30 border-b-2 border-slate-400">
                                    ${headerTimeline}
                                </div>
                                ${rowsHTML}
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        // --- Application Logic ---
        const app = {
            data: [],
            currentTab: 'todo',
            gantt: new GanttManager(),
            
            init() {
                db.init().then(() => {
                    db.sub(data => {
                        this.data = data;
                        utils.$('#loading').classList.add('hidden');
                        this.render();
                    });
                });
                
                window.app = this;
                this.handlers = {
                    del: async (id) => {
                        const success = await db.del(id);
                        if(success) window.modal.close();
                    },
                    edit: (type, id) => this.openEditModal(type, id),
                    toGantt: (id) => this.addToGantt(id),
                    save: async (id, type) => {
                        const form = utils.$('#edit-form');
                        const payload = Object.fromEntries(new FormData(form));
                        
                        if(type === 'gantt') {
                            payload.duration = parseInt(payload.duration) || 1;
                            payload.progress = parseInt(payload.progress) || 0;
                            payload.order = parseInt(payload.order) || 0;
                            if (payload.parentId === "") payload.parentId = null;
                            const suspendedEl = form.querySelector('[name=suspended]');
                            payload.suspended = suspendedEl ? suspendedEl.checked : false;
                        }
                        
                        if(type==='todo') { 
                            const el = form.querySelector('[name=completed]');
                            payload.completed = el ? el.checked : false; 
                        }
                        if(type==='event') { 
                            const el = form.querySelector('[name=closed]');
                            payload.closed = el ? el.checked : false; 
                        }
                        
                        id ? await db.update(id, payload) : await db.add({ type, ...payload });
                        window.modal.close();
                    }
                };
            },

            switchTab(tab) {
                this.currentTab = tab;
                document.querySelectorAll('.nav-btn').forEach(b => {
                    b.classList.remove('bg-slate-700', 'shadow-inner');
                    b.classList.add('hover:bg-slate-700');
                });
                const activeBtn = utils.$(`button[data-tab="${tab}"]`);
                activeBtn.classList.add('bg-slate-700', 'shadow-inner');
                utils.$('#page-title').textContent = activeBtn.textContent.slice(2);
                const actions = utils.$('#header-actions');
                actions.innerHTML = tab === 'gantt' 
                    ? `<button onclick="window.app.openEditModal('gantt')" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 shadow-md transform hover:scale-105 transition-all flex items-center gap-2 font-bold"><span>ï¼‹</span> æ–°å¢ä»»å‹™</button>`
                    : `<button onclick="window.app.openEditModal('${tab}')" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 shadow-md transform hover:scale-105 transition-all flex items-center gap-2 font-bold"><span>ï¼‹</span> æ–°å¢é …ç›®</button>`;
                this.render();
            },

            render() {
                document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
                const view = utils.$(`#view-${this.currentTab}`);
                view.classList.remove('hidden');
                const items = this.data.filter(i => i.type === this.currentTab);
                if (['todo', 'event', 'feedback'].includes(this.currentTab)) {
                    view.innerHTML = renderer.table(items, CONFIG.cols[this.currentTab], this.currentTab);
                } else if (this.currentTab === 'gantt') {
                    this.gantt.render(items);
                }
            },

            openEditModal(type, id = null) {
                const item = id ? this.data.find(i => i.id === id) : {};
                let fields = [];
                if (type === 'todo') fields = [
                    { label: 'ç”Ÿç”¢ç·¨è™Ÿ', name: 'productionId', val: item.productionId },
                    { label: 'æ–™è™Ÿ', name: 'partNumber', val: item.partNumber },
                    { label: 'ä¿®æ”¹å…§å®¹', name: 'content', type: 'textarea', val: item.content },
                    { label: 'å»ºç«‹æ—¥æœŸ', name: 'date', type: 'date', val: item.date || utils.date() }
                ];
                if (type === 'event') fields = [
                    { label: 'äº‹ä»¶æ—¥æœŸ', name: 'date', type: 'date', val: item.date || utils.date() },
                    { label: 'äº‹é …å…§å®¹', name: 'matter', val: item.matter },
                    { label: 'ç›¸é—œäººå“¡', name: 'personnel', val: item.personnel },
                    { label: 'å„ªå…ˆç¨‹åº¦', name: 'priority', type: 'select', opts: ['high','medium','low'], val: item.priority || 'medium' }
                ];
                if (type === 'feedback') fields = [
                    { label: 'åé¥‹é¡å‹', name: 'feedbackType', type: 'select', opts: ['ç¡¬é«”','è»Ÿé«”','å…¶ä»–'], val: item.feedbackType },
                    { label: 'å•é¡Œæè¿°', name: 'problem', type: 'textarea', val: item.problem },
                    { label: 'è§£æ±ºæ–¹æ¡ˆ', name: 'solution', type: 'textarea', val: item.solution }
                ];
                if (type === 'gantt') {
                    const potentialParents = this.data.filter(i => i.type === 'gantt' && i.id !== id);
                    const parentOpts = [{v: '', l: 'ç„¡ (è¨­ç‚ºé ‚å±¤ä»»å‹™)'}, ...potentialParents.map(p => ({v: p.id, l: p.name}))];
                    fields = [
                        { label: 'ä»»å‹™åç¨±', name: 'name', val: item.name },
                        { label: 'çˆ¶ä»»å‹™', name: 'parentId', type: 'select', opts: parentOpts, val: item.parentId || '' },
                        { label: 'è² è²¬äºº', name: 'assignee', val: item.assignee },
                        { label: 'é–‹å§‹æ—¥æœŸ', name: 'start', type: 'date', val: item.start || utils.date() },
                        { label: 'å·¥æœŸ (å¤©)', name: 'duration', type: 'number', val: item.duration || 1 },
                        { label: 'ç•¶å‰é€²åº¦ (%)', name: 'progress', type: 'number', val: item.progress || 0 },
                        { label: 'æ’åºæ¬Šé‡', name: 'order', type: 'number', val: item.order || 0 }
                    ];
                }

                let extraHtml = '';
                if(type === 'todo' && id) extraHtml = `<div class="mt-4 p-3 bg-gray-100 rounded border-2 border-slate-300"><label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" name="completed" ${item.completed?'checked':''} class="w-5 h-5 text-indigo-600 rounded border-gray-400"> <span class="font-bold text-slate-700">å·²å®Œæˆæ­¤é …ç›®</span></label></div>`;
                if(type === 'event' && id) extraHtml = `<div class="mt-4 p-3 bg-gray-100 rounded border-2 border-slate-300"><label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" name="closed" ${item.closed?'checked':''} class="w-5 h-5 text-indigo-600 rounded border-gray-400"> <span class="font-bold text-slate-700">æ¨™è¨˜ç‚ºå·²çµæ¡ˆ</span></label></div>`;
                if(type === 'gantt') extraHtml = `<div class="mt-4 p-3 bg-red-50 rounded border-2 border-red-200"><label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" name="suspended" ${item.suspended?'checked':''} class="w-5 h-5 text-red-600 rounded border-gray-400"> <span class="font-bold text-red-700">â¸ï¸ æš«ç·©å¯¦æ–½ (ä¸é¡¯ç¤ºæ–¼æ’ç¨‹)</span></label></div>`;

                const deleteBtn = id ? `<button type="button" onclick="window.app.handlers.del('${id}')" class="px-5 py-2.5 text-red-700 font-bold hover:bg-red-50 rounded-lg transition-colors mr-auto flex items-center gap-2 border border-transparent hover:border-red-200"><span class="text-lg">ğŸ—‘ï¸</span> åˆªé™¤</button>` : '';

                window.modal.open(
                    id ? `âœï¸ ç·¨è¼¯${this.getTypeName(type)}` : `â• æ–°å¢${this.getTypeName(type)}`,
                    `<form id="edit-form">${renderer.form(fields, type)}${extraHtml}</form>`,
                    `${deleteBtn}
                     <button onclick="window.modal.close()" class="px-5 py-2.5 text-gray-600 font-bold hover:bg-gray-100 rounded-lg transition-colors border border-gray-300">å–æ¶ˆ</button>
                     <button onclick="window.app.handlers.save('${id||''}', '${type}')" class="px-5 py-2.5 bg-indigo-600 text-white font-bold rounded-lg hover:bg-indigo-700 shadow-lg hover:shadow-xl transition-all">å„²å­˜è®Šæ›´</button>`
                );
            },
            
            getTypeName(type) {
                return { 'todo': 'å¾…è¾¦', 'event': 'äº‹ä»¶', 'feedback': 'åé¥‹', 'gantt': 'æ’ç¨‹' }[type] || 'é …ç›®';
            },

            async addToGantt(eventId) {
                const event = this.data.find(i => i.id === eventId);
                const duration = event.priority === 'high' ? 3 : (event.priority === 'medium' ? 5 : 7);
                await db.add({
                    type: 'gantt', 
                    name: `[${event.priority === 'high' ? 'æ€¥' : 'ä¸€èˆ¬'}] ${event.matter}`, 
                    assignee: event.personnel,
                    start: event.date, 
                    duration: duration, 
                    progress: 0, 
                    order: 99
                });
                utils.toast('âœ… å·²å°‡äº‹ä»¶åŠ å…¥æ’ç¨‹è¡¨');
                this.switchTab('gantt');
            }
        };

        app.init();
    </script>
</body>
</html>
