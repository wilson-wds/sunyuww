<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>待修改事項管理 (公開版)</title>
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 Google Fonts 的 Inter 字體 -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* 自訂樣式 */
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
        }
        /* 當項目完成時，添加刪除線樣式 */
        .completed > td:not(:first-child):not(:last-child) {
            text-decoration: line-through;
            color: #9ca3af; /* gray-400 */
        }
        /* 讓表格在小螢幕上可以水平滾動 */
        .table-container {
            overflow-x: auto;
        }
        /* 編輯模式下的輸入框樣式 */
        .edit-input {
            width: 100%;
            padding: 0.25rem 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            background-color: #f9fafb;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <main class="container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-900">待修改事項管理系統 (公開共享版)</h1>
            <p class="text-gray-600 mt-2">所有訪客將看到並編輯同一份清單</p>
            <div id="auth-status" class="mt-4 text-sm text-gray-500">正在連接到 Firebase...</div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
            <!-- 左側：建立表單 -->
            <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg">
                <h2 class="text-2xl font-bold mb-6 border-b pb-3">建立新項目</h2>
                <form id="addItemForm" class="space-y-4">
                    <div>
                        <label for="productionId" class="block text-sm font-medium text-gray-700">生產編號</label>
                        <input type="text" id="productionId" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" required>
                    </div>
                    <div>
                        <label for="assemblyId" class="block text-sm font-medium text-gray-700">組裝編號</label>
                        <input type="text" id="assemblyId" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" required>
                    </div>
                    <div>
                        <label for="partNumber" class="block text-sm font-medium text-gray-700">料號</label>
                        <input type="text" id="partNumber" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" required>
                    </div>
                    <div>
                        <label for="content" class="block text-sm font-medium text-gray-700">修改內容</label>
                        <textarea id="content" name="content" rows="4" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" required></textarea>
                    </div>
                    <div>
                        <label for="imageUpload" class="block text-sm font-medium text-gray-700">上傳圖片 (小於 750KB)</label>
                        <input type="file" id="imageUpload" name="imageUpload" accept="image/*" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                    </div>
                    <div>
                        <label for="date" class="block text-sm font-medium text-gray-700">日期</label>
                        <input type="date" id="date" name="date" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" required>
                    </div>
                    <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors duration-300 disabled:bg-gray-400" disabled>
                        新增項目
                    </button>
                </form>
            </div>

            <!-- 右側：查詢與列表 -->
            <div class="lg:col-span-3 bg-white p-6 rounded-xl shadow-lg">
                <h2 class="text-2xl font-bold mb-6 border-b pb-3">待修改明細</h2>
                <div class="mb-4">
                    <label for="searchInput" class="block text-sm font-medium text-gray-700">查詢 (生產/組裝編號/料號)</label>
                    <input type="text" id="searchInput" placeholder="輸入關鍵字進行模糊搜尋..." class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div class="table-container">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">狀態</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">生產編號</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">組裝編號</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">料號</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">修改內容</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">圖片</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">日期</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                            </tr>
                        </thead>
                        <tbody id="itemsList" class="bg-white divide-y divide-gray-200"></tbody>
                    </table>
                </div>
                <p id="no-results" class="text-center text-gray-500 py-8 hidden">找不到符合條件的項目。</p>
            </div>
        </div>
    </main>

    <!-- Modals (圖片預覽, 通知, 確認) -->
    <div id="imageModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden"><div class="bg-white p-4 rounded-lg max-w-3xl max-h-full overflow-auto"><img id="modalImage" src="" alt="預覽圖片" class="max-w-full max-h-[80vh] rounded"><button id="closeModal" class="absolute top-4 right-4 text-white text-3xl font-bold">&times;</button></div></div>
    <div id="notificationModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden"><div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full mx-4"><p id="notificationMessage" class="text-gray-800 text-base mb-4"></p><button id="closeNotificationModal" class="w-full bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700">確定</button></div></div>
    <div id="confirmationModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden"><div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full mx-4"><p id="confirmationMessage" class="text-gray-800 text-lg mb-6"></p><div class="flex justify-end space-x-4"><button id="confirmCancel" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">取消</button><button id="confirmOk" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">確定</button></div></div></div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, addDoc, onSnapshot, updateDoc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // DOM 元素
        const addItemForm = document.getElementById('addItemForm');
        const itemsList = document.getElementById('itemsList');
        const searchInput = document.getElementById('searchInput');
        const dateInput = document.getElementById('date');
        const authStatus = document.getElementById('auth-status');
        const submitButton = addItemForm.querySelector('button[type="submit"]');
        const noResults = document.getElementById('no-results');
        
        // Modal 元素
        const imageModal = document.getElementById('imageModal');
        const modalImage = document.getElementById('modalImage');
        const closeModal = document.getElementById('closeModal');
        const notificationModal = document.getElementById('notificationModal');
        const notificationMessage = document.getElementById('notificationMessage');
        const closeNotificationModal = document.getElementById('closeNotificationModal');
        const confirmationModal = document.getElementById('confirmationModal');
        const confirmationMessage = document.getElementById('confirmationMessage');
        const confirmCancel = document.getElementById('confirmCancel');
        const confirmOk = document.getElementById('confirmOk');

        let allItems = [];
        let unsubscribe = null;
        let confirmCallback = null;
        let editingItemId = null;

        // 將今天的日期設置為預設值
        dateInput.valueAsDate = new Date();

        // --- Modal 輔助函數 ---
        const showNotification = (message) => { notificationMessage.textContent = message; notificationModal.classList.remove('hidden'); };
        const showConfirmation = (message, callback) => { confirmationMessage.textContent = message; confirmCallback = callback; confirmationModal.classList.remove('hidden'); };
        closeNotificationModal.addEventListener('click', () => notificationModal.classList.add('hidden'));
        confirmCancel.addEventListener('click', () => { confirmationModal.classList.add('hidden'); confirmCallback = null; });
        confirmOk.addEventListener('click', () => { confirmationModal.classList.add('hidden'); if (confirmCallback) confirmCallback(); confirmCallback = null; });

        // --- Firebase 設定 ---
        let firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const manualFirebaseConfig = { apiKey: "AIzaSyA7IeOz4EJ-yMUccDTPOSaDm33fLChVD8Q", authDomain: "sunyu-check.firebaseapp.com", projectId: "sunyu-check", storageBucket: "sunyu-check.firebasestorage.app", messagingSenderId: "627211744361", appId: "1:627211744361:web:58bce4b5009f0c9d5bdef8" };
        if (!firebaseConfig || Object.keys(firebaseConfig).length === 0) { firebaseConfig = manualFirebaseConfig; }
        const appId = typeof __app_id !== 'undefined' ? __app_id : (firebaseConfig.projectId || 'default-app-id');

        // --- Firebase 初始化與驗證 ---
        if (!firebaseConfig || !firebaseConfig.apiKey) {
            authStatus.textContent = "錯誤：找不到 Firebase 設定。";
        } else {
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);
            const collectionPath = `/artifacts/${appId}/public/data/sharedTodoItems`;
            const itemsCollectionRef = collection(db, collectionPath);

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    authStatus.textContent = `已連線 | 公開共享模式`;
                    submitButton.disabled = false;
                    listenForItems(itemsCollectionRef);
                } else {
                    authStatus.textContent = '正在驗證身份...';
                    try {
                        if (typeof __initial_auth_token !== 'undefined') await signInWithCustomToken(auth, __initial_auth_token);
                        else await signInAnonymously(auth);
                    } catch (error) {
                        authStatus.textContent = '錯誤：無法連接。請檢查 Firebase 設定與匿名登入狀態。';
                    }
                }
            });

            // 監聽 Firestore 資料變更
            const listenForItems = (collectionRef) => {
                if (unsubscribe) unsubscribe();
                unsubscribe = onSnapshot(collectionRef, (snapshot) => {
                    allItems = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    allItems.sort((a, b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0));
                    renderItems(searchInput.value);
                });
            };

            // 新增項目
            addItemForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const imageFile = document.getElementById('imageUpload').files[0];
                if (imageFile && imageFile.size > 750 * 1024) {
                    showNotification("圖片檔案過大，請選擇小於 750KB 的圖片。");
                    return;
                }
                const reader = new FileReader();
                reader.onloadend = async () => {
                    await addDoc(itemsCollectionRef, {
                        productionId: document.getElementById('productionId').value,
                        assemblyId: document.getElementById('assemblyId').value,
                        partNumber: document.getElementById('partNumber').value,
                        content: document.getElementById('content').value,
                        date: dateInput.value,
                        image: reader.result || null,
                        completed: false,
                        createdAt: serverTimestamp()
                    });
                    addItemForm.reset();
                    dateInput.valueAsDate = new Date();
                };
                if (imageFile) reader.readAsDataURL(imageFile);
                else reader.onloadend();
            });

            // 列表點擊事件代理
            itemsList.addEventListener('click', async (e) => {
                const target = e.target;
                const tr = target.closest('tr');
                if (!tr) return;
                const id = tr.dataset.id;
                const docRef = doc(itemsCollectionRef, id);

                if (target.classList.contains('toggle-complete')) {
                    const item = allItems.find(i => i.id === id);
                    await updateDoc(docRef, { completed: !item.completed });
                } else if (target.classList.contains('delete-item')) {
                    showConfirmation('您確定要刪除這個項目嗎？', () => deleteDoc(docRef));
                } else if (target.classList.contains('view-image')) {
                     const item = allItems.find(i => i.id === id);
                    if (item && item.image) {
                        modalImage.src = item.image;
                        imageModal.classList.remove('hidden');
                    }
                } else if (target.classList.contains('edit-item')) {
                    editingItemId = id;
                    renderItems(searchInput.value);
                } else if (target.classList.contains('cancel-edit')) {
                    editingItemId = null;
                    renderItems(searchInput.value);
                } else if (target.classList.contains('save-item')) {
                    await updateDoc(docRef, {
                        productionId: tr.querySelector('.edit-productionId').value,
                        assemblyId: tr.querySelector('.edit-assemblyId').value,
                        partNumber: tr.querySelector('.edit-partNumber').value,
                        content: tr.querySelector('.edit-content').value,
                        date: tr.querySelector('.edit-date').value,
                    });
                    editingItemId = null;
                }
            });
        }

        // 渲染項目列表
        const renderItems = (filter = '') => {
            const lowerCaseFilter = filter.toLowerCase();
            const filteredItems = allItems.filter(item =>
                item.productionId.toLowerCase().includes(lowerCaseFilter) ||
                (item.assemblyId && item.assemblyId.toLowerCase().includes(lowerCaseFilter)) ||
                item.partNumber.toLowerCase().includes(lowerCaseFilter)
            );
            itemsList.innerHTML = '';
            noResults.classList.toggle('hidden', filteredItems.length > 0);
            
            filteredItems.forEach(item => {
                const isEditing = item.id === editingItemId;
                const tr = document.createElement('tr');
                tr.dataset.id = item.id;
                if (item.completed) tr.classList.add('completed');

                tr.innerHTML = isEditing ? `
                    <td class="px-4 py-3"><input type="checkbox" class="h-5 w-5 toggle-complete" ${item.completed ? 'checked' : ''}></td>
                    <td class="px-4 py-3"><input type="text" class="edit-input edit-productionId" value="${item.productionId}"></td>
                    <td class="px-4 py-3"><input type="text" class="edit-input edit-assemblyId" value="${item.assemblyId || ''}"></td>
                    <td class="px-4 py-3"><input type="text" class="edit-input edit-partNumber" value="${item.partNumber}"></td>
                    <td class="px-4 py-3"><textarea class="edit-input edit-content">${item.content}</textarea></td>
                    <td class="px-4 py-3 text-sm text-gray-500">無法編輯</td>
                    <td class="px-4 py-3"><input type="date" class="edit-input edit-date" value="${item.date || ''}"></td>
                    <td class="px-4 py-3 whitespace-nowrap"><button class="text-green-600 hover:text-green-800 save-item">儲存</button><button class="text-gray-600 hover:text-gray-900 cancel-edit ml-2">取消</button></td>
                ` : `
                    <td class="px-4 py-3"><input type="checkbox" class="h-5 w-5 toggle-complete" ${item.completed ? 'checked' : ''}></td>
                    <td class="px-4 py-3">${item.productionId}</td>
                    <td class="px-4 py-3">${item.assemblyId || '-'}</td>
                    <td class="px-4 py-3">${item.partNumber}</td>
                    <td class="px-4 py-3 max-w-xs truncate" title="${item.content}">${item.content}</td>
                    <td class="px-4 py-3">${item.image ? `<button class="text-indigo-600 hover:text-indigo-900 view-image">預覽</button>` : '無'}</td>
                    <td class="px-4 py-3">${item.date || 'N/A'}</td>
                    <td class="px-4 py-3 whitespace-nowrap"><button class="text-indigo-600 hover:text-indigo-900 edit-item">編輯</button><button class="text-red-600 hover:text-red-700 delete-item ml-2">刪除</button></td>
                `;
                itemsList.appendChild(tr);
            });
        };

        // 搜尋功能
        searchInput.addEventListener('input', () => renderItems(searchInput.value));
        closeModal.addEventListener('click', () => imageModal.classList.add('hidden'));
        imageModal.addEventListener('click', (e) => { if (e.target === imageModal) imageModal.classList.add('hidden'); });

    </script>
</body>
</html>
