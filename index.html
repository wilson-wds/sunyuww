<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>待辦事項管理系統</title>
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 Google Fonts 的 Inter 字體 -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* 自訂樣式 */
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
        }
        .completed > td:not(:first-child):not(:last-child) {
            text-decoration: line-through;
            color: #9ca3af;
        }
        .table-container {
            overflow-x: auto;
        }
        .edit-input {
            width: 100%;
            padding: 0.25rem 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            background-color: #f9fafb;
        }
        .new-item-highlight {
            background-color: #fef9c3; /* yellow-100 */
            transition: background-color 1.5s ease-out;
        }
        
        /* --- START: 優化後的列印專用樣式 --- */
        @media print {
            /* 隱藏主內容中除了明細視窗以外的所有元素 */
            body > *:not(#detailModal) {
                display: none;
            }
            /* 重設 html 和 body 以獲得乾淨的列印背景 */
            html, body {
                height: auto;
                margin: 0 !important;
                padding: 0 !important;
                background: #fff;
            }
            /* 讓明細視窗容器充滿頁面，並移除固定定位 */
            #detailModal {
                position: static;
                display: block !important;
                width: 100%;
                height: auto;
                background: transparent; /* 移除灰色遮罩 */
                overflow: visible;
            }
            /* 讓可列印內容區塊正常流動，移除陰影和邊框 */
            #printable-content {
                position: static;
                width: 100%;
                height: 98vh; /* 使用幾乎整個頁面高度 */
                margin: 0;
                padding: 1rem;
                border: none;
                box-shadow: none;
                max-height: none;
                overflow: visible;
            }
            /* 移除螢幕檢視時的滾動條容器 */
            #printable-content > .flex-1.min-h-0.overflow-y-auto {
                overflow: visible;
                flex: 1;
            }
            /* 讓內容區塊變成 flex 佈局以控制內部元素 */
            #detail-content {
                display: flex;
                flex-direction: column;
                height: 100%;
            }
            /* 讓圖片容器可以伸縮 */
            #detail-image-container {
                flex: 1; /* 佔用所有剩餘空間 */
                min-height: 0; /* 允許縮小 */
                display: flex;
                flex-direction: column;
                justify-content: center;
            }
            /* 讓圖片本身填滿其容器 */
            #detail-image {
                page-break-inside: avoid;
                max-width: 100%;
                max-height: 100%;
                object-fit: contain;
            }
            /* 隱藏明細視窗中的按鈕 */
            #detailModal .flex.justify-end {
                display: none;
            }
        }
        /* --- END: 優化後的列印專用樣式 --- */
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <main class="container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-900">待辦事項管理系統</h1>
            <p class="text-gray-600 mt-2">一個簡單好用的待辦事項列表</p>
            <div id="auth-status" class="mt-4 text-sm text-gray-500">正在連接到 Firebase...</div>
        </header>
        
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
            <!-- 左側：新增表單 -->
            <div id="form-container" class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg">
                <div id="todo-form-view">
                    <h2 class="text-2xl font-bold mb-6 border-b pb-3">建立新待辦</h2>
                    <form id="addItemForm" class="space-y-4">
                        <input type="text" id="todo-productionId" placeholder="生產編號" class="w-full px-3 py-2 border rounded-md focus:ring-indigo-500 focus:border-indigo-500" required>
                        <input type="text" id="todo-assemblyId" placeholder="組裝編號" class="w-full px-3 py-2 border rounded-md focus:ring-indigo-500 focus:border-indigo-500" required>
                        <input type="text" id="todo-partNumber" placeholder="料號" class="w-full px-3 py-2 border rounded-md focus:ring-indigo-500 focus:border-indigo-500" required>
                        <textarea id="todo-content" placeholder="修改內容" rows="4" class="w-full px-3 py-2 border rounded-md focus:ring-indigo-500 focus:border-indigo-500" required></textarea>
                        <div><label class="text-sm">圖片 (小於 750KB)</label><input type="file" id="todo-imageUpload" class="w-full text-sm"></div>
                        <div><label class="text-sm">日期</label><input type="date" id="todo-date" class="w-full px-3 py-2 border rounded-md" required></div>
                        <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 disabled:bg-gray-400" disabled>新增項目</button>
                    </form>
                </div>
            </div>

            <!-- 右側：待辦列表 -->
            <div id="list-container" class="lg:col-span-3 bg-white p-6 rounded-xl shadow-lg">
                <div id="todo-list-view">
                    <h2 class="text-2xl font-bold mb-6 border-b pb-3">待修改明細</h2>
                    <input type="text" id="todo-searchInput" placeholder="查詢 (生產/組裝/料號)..." class="w-full mb-4 px-3 py-2 border rounded-md">
                    <div class="table-container">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">狀態</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">生產編號</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">組裝編號</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">料號</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">修改內容</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">圖片</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">日期</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                                </tr>
                            </thead>
                            <tbody id="todo-itemsList" class="bg-white divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                    <p id="todo-no-results" class="text-center py-8 hidden">找不到項目。</p>
                </div>
            </div>
        </div>
    </main>

    <!-- Modals -->
    <div id="imageModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden"><div class="bg-white p-4 rounded-lg max-w-3xl max-h-full overflow-auto"><img id="modalImage" src="" alt="預覽圖片" class="max-w-full max-h-[80vh] rounded"><button id="closeModal" class="absolute top-4 right-4 text-white text-3xl font-bold">&times;</button></div></div>
    <div id="notificationModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden"><div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full mx-4"><p id="notificationMessage" class="text-gray-800 text-base mb-4"></p><button id="closeNotificationModal" class="w-full bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700">確定</button></div></div>
    <div id="confirmationModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden"><div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full mx-4"><p id="confirmationMessage" class="text-gray-800 text-lg mb-6"></p><div class="flex justify-end space-x-4"><button id="confirmCancel" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">取消</button><button id="confirmOk" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">確定</button></div></div></div>
    
    <!-- Detail and Print Modal -->
    <div id="detailModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div id="printable-content" class="bg-white p-8 rounded-lg shadow-xl max-w-2xl w-full mx-4 relative flex flex-col max-h-[90vh]">
            <h2 class="text-2xl font-bold mb-6 border-b pb-3 flex-shrink-0">項目明細</h2>
            
            <div class="flex-1 min-h-0 overflow-y-auto"> <!-- Scrollable wrapper for on-screen view -->
                <div id="detail-content" class="space-y-4 text-gray-700">
                    <p><strong>生產編號:</strong> <span id="detail-productionId"></span></p>
                    <p><strong>組裝編號:</strong> <span id="detail-assemblyId"></span></p>
                    <p><strong>料號:</strong> <span id="detail-partNumber"></span></p>
                    <p><strong>日期:</strong> <span id="detail-date"></span></p>
                    <div>
                        <p><strong>修改內容:</strong></p>
                        <p id="detail-content-text" class="mt-1 p-2 border rounded bg-gray-50 whitespace-pre-wrap"></p>
                    </div>
                    <div id="detail-image-container" class="mt-4 hidden">
                        <p><strong>圖片預覽:</strong></p>
                        <img id="detail-image" src="" alt="項目圖片" class="mt-2 max-w-full h-auto rounded border">
                    </div>
                </div>
            </div>

            <div class="mt-8 pt-4 border-t flex justify-end space-x-4 flex-shrink-0">
                <button id="closeDetailModal" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">關閉</button>
                <button id="printDetail" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">列印</button>
            </div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, addDoc, onSnapshot, updateDoc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- DOM 元素 ---
        const addItemForm = document.getElementById('addItemForm');
        const todoItemsList = document.getElementById('todo-itemsList');
        const todoSearchInput = document.getElementById('todo-searchInput');
        const authStatus = document.getElementById('auth-status');
        const todoSubmitButton = addItemForm.querySelector('button[type="submit"]');
        const imageModal = document.getElementById('imageModal');
        const modalImage = document.getElementById('modalImage');
        const closeModal = document.getElementById('closeModal');
        const notificationModal = document.getElementById('notificationModal');
        const notificationMessage = document.getElementById('notificationMessage');
        const closeNotificationModal = document.getElementById('closeNotificationModal');
        const confirmationModal = document.getElementById('confirmationModal');
        const confirmationMessage = document.getElementById('confirmationMessage');
        const confirmCancel = document.getElementById('confirmCancel');
        const confirmOk = document.getElementById('confirmOk');
        // 新增的明細 Modal 元素
        const detailModal = document.getElementById('detailModal');
        const closeDetailModal = document.getElementById('closeDetailModal');
        const printDetail = document.getElementById('printDetail');
        const detailProductionId = document.getElementById('detail-productionId');
        const detailAssemblyId = document.getElementById('detail-assemblyId');
        const detailPartNumber = document.getElementById('detail-partNumber');
        const detailDate = document.getElementById('detail-date');
        const detailContentText = document.getElementById('detail-content-text');
        const detailImageContainer = document.getElementById('detail-image-container');
        const detailImage = document.getElementById('detail-image');

        // --- 狀態變數 ---
        let allTodoItems = [];
        let unsubscribeTodo = null;
        let confirmCallback = null;
        let editingItemId = null;

        // --- 日期初始化 ---
        document.getElementById('todo-date').valueAsDate = new Date();

        // --- Modal 輔助函數 ---
        const showNotification = (message) => { notificationMessage.textContent = message; notificationModal.classList.remove('hidden'); };
        const showConfirmation = (message, callback) => { confirmationMessage.textContent = message; confirmCallback = callback; confirmationModal.classList.remove('hidden'); };
        closeNotificationModal.addEventListener('click', () => notificationModal.classList.add('hidden'));
        confirmCancel.addEventListener('click', () => { confirmationModal.classList.add('hidden'); confirmCallback = null; });
        confirmOk.addEventListener('click', () => { confirmationModal.classList.add('hidden'); if (confirmCallback) confirmCallback(); confirmCallback = null; });
        closeModal.addEventListener('click', () => imageModal.classList.add('hidden'));
        imageModal.addEventListener('click', (e) => { if (e.target === imageModal) imageModal.classList.add('hidden'); });
        // 新增的明細 Modal 事件
        closeDetailModal.addEventListener('click', () => detailModal.classList.add('hidden'));
        printDetail.addEventListener('click', () => window.print());

        // --- Firebase 設定 ---
        let firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const manualFirebaseConfig = { apiKey: "AIzaSyA7IeOz4EJ-yMUccDTPOSaDm33fLChVD8Q", authDomain: "sunyu-check.firebaseapp.com", projectId: "sunyu-check", storageBucket: "sunyu-check.firebasestorage.app", messagingSenderId: "627211744361", appId: "1:627211744361:web:58bce4b5009f0c9d5bdef8" };
        if (!firebaseConfig || Object.keys(firebaseConfig).length === 0) { firebaseConfig = manualFirebaseConfig; }
        const appId = typeof __app_id !== 'undefined' ? __app_id : (firebaseConfig.projectId || 'default-app-id');

        // --- Firebase 初始化 ---
        if (!firebaseConfig || !firebaseConfig.apiKey) {
            authStatus.textContent = "錯誤：找不到 Firebase 設定。";
        } else {
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);
            const todoCollectionRef = collection(db, `/artifacts/${appId}/public/data/sharedTodoItems`);

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    authStatus.textContent = `已連線 | 公開共享模式`;
                    todoSubmitButton.disabled = false;
                    listenForTodoItems();
                } else {
                    authStatus.textContent = '正在驗證身份...';
                    try {
                        if (typeof __initial_auth_token !== 'undefined') await signInWithCustomToken(auth, __initial_auth_token);
                        else await signInAnonymously(auth);
                    } catch (error) {
                        authStatus.textContent = '錯誤：無法連接。';
                    }
                }
            });

            // --- 資料監聽 ---
            const listenForTodoItems = () => {
                if (unsubscribeTodo) unsubscribeTodo();
                unsubscribeTodo = onSnapshot(todoCollectionRef, (snapshot) => {
                    allTodoItems = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    allTodoItems.sort((a, b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0));
                    renderTodoItems(todoSearchInput.value);
                });
            };

            // --- 表單提交 ---
            addItemForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const imageFile = document.getElementById('todo-imageUpload').files[0];
                if (imageFile && imageFile.size > 750 * 1024) {
                    showNotification("圖片檔案過大，請選擇小於 750KB 的圖片。");
                    return;
                }
                const reader = new FileReader();
                reader.onloadend = async () => {
                    try {
                        await addDoc(todoCollectionRef, {
                            productionId: document.getElementById('todo-productionId').value,
                            assemblyId: document.getElementById('todo-assemblyId').value,
                            partNumber: document.getElementById('todo-partNumber').value,
                            content: document.getElementById('todo-content').value,
                            date: document.getElementById('todo-date').value,
                            image: reader.result || null,
                            completed: false,
                            createdAt: serverTimestamp()
                        });
                        addItemForm.reset();
                        document.getElementById('todo-date').valueAsDate = new Date();
                    } catch (error) {
                        showNotification(`新增待辦失敗: ${error.message}`);
                    }
                };
                if (imageFile) reader.readAsDataURL(imageFile);
                else reader.onloadend();
            });

            // --- 列表事件代理 ---
            document.getElementById('list-container').addEventListener('click', async (e) => {
                const target = e.target;
                const tr = target.closest('tr');
                if (!tr) return;

                const id = tr.dataset.id;
                const docRef = doc(todoCollectionRef, id);

                if (target.classList.contains('toggle-complete')) {
                    const item = allTodoItems.find(i => i.id === id);
                    await updateDoc(docRef, { completed: !item.completed });
                } else if (target.classList.contains('delete-item')) {
                    showConfirmation('您確定要刪除這個項目嗎？', () => deleteDoc(docRef));
                } else if (target.classList.contains('view-image')) {
                    const item = allTodoItems.find(i => i.id === id);
                    if (item && item.image) {
                        modalImage.src = item.image;
                        imageModal.classList.remove('hidden');
                    }
                } else if (target.classList.contains('view-detail')) { // 新增的事件處理
                    const item = allTodoItems.find(i => i.id === id);
                    if (item) {
                        populateAndShowDetailModal(item);
                    }
                } else if (target.classList.contains('edit-item')) {
                    editingItemId = id;
                    renderTodoItems();
                } else if (target.classList.contains('cancel-edit')) {
                    editingItemId = null;
                    renderTodoItems();
                } else if (target.classList.contains('save-item')) {
                    try {
                        const updatedData = {
                            productionId: tr.querySelector('.edit-productionId').value,
                            assemblyId: tr.querySelector('.edit-assemblyId').value,
                            partNumber: tr.querySelector('.edit-partNumber').value,
                            content: tr.querySelector('.edit-content').value,
                            date: tr.querySelector('.edit-date').value,
                        };
                        await updateDoc(docRef, updatedData);
                        editingItemId = null;
                    } catch(error) {
                        showNotification(`儲存失敗: ${error.message}`);
                    }
                }
            });
        }
        
        // --- 新增：填充並顯示明細 Modal 的函數 ---
        const populateAndShowDetailModal = (item) => {
            detailProductionId.textContent = item.productionId || '-';
            detailAssemblyId.textContent = item.assemblyId || '-';
            detailPartNumber.textContent = item.partNumber || '-';
            detailDate.textContent = item.date || '-';
            detailContentText.textContent = item.content || '-';

            if (item.image) {
                detailImage.src = item.image;
                detailImage.alt = `${item.partNumber} 的圖片`;
                detailImageContainer.classList.remove('hidden');
            } else {
                detailImageContainer.classList.add('hidden');
                detailImage.src = '';
            }

            detailModal.classList.remove('hidden');
        };

        // --- 渲染函數 ---
        const renderTodoItems = (filter = '') => {
            const lowerFilter = filter.toLowerCase();
            const list = allTodoItems.filter(item => 
                item.productionId?.toLowerCase().includes(lowerFilter) || 
                item.assemblyId?.toLowerCase().includes(lowerFilter) || 
                item.partNumber?.toLowerCase().includes(lowerFilter)
            );
            
            todoItemsList.innerHTML = '';
            document.getElementById('todo-no-results').classList.toggle('hidden', list.length > 0);

            list.forEach(item => {
                const isEditing = item.id === editingItemId;
                const tr = document.createElement('tr');
                tr.dataset.id = item.id;
                if (item.completed) tr.classList.add('completed');
                
                if (isEditing) {
                    tr.innerHTML = `
                        <td class="px-4 py-4 whitespace-nowrap"><input type="checkbox" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500 toggle-complete" ${item.completed ? 'checked' : ''}></td>
                        <td class="px-4 py-4"><input class="edit-input edit-productionId" value="${item.productionId}"></td>
                        <td class="px-4 py-4"><input class="edit-input edit-assemblyId" value="${item.assemblyId || ''}"></td>
                        <td class="px-4 py-4"><input class="edit-input edit-partNumber" value="${item.partNumber}"></td>
                        <td class="px-4 py-4"><textarea class="edit-input edit-content">${item.content}</textarea></td>
                        <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">無法編輯</td>
                        <td class="px-4 py-4"><input type="date" class="edit-input edit-date" value="${item.date}"></td>
                        <td class="px-4 py-4 whitespace-nowrap text-sm font-medium">
                            <button class="save-item text-green-600 hover:text-green-900">儲存</button>
                            <button class="cancel-edit text-gray-600 hover:text-gray-900 ml-4">取消</button>
                        </td>`;
                } else {
                    tr.innerHTML = `
                        <td class="px-4 py-4 whitespace-nowrap"><input type="checkbox" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500 toggle-complete" ${item.completed ? 'checked' : ''}></td>
                        <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">${item.productionId}</td>
                        <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">${item.assemblyId || '-'}</td>
                        <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">${item.partNumber}</td>
                        <td class="px-4 py-4 max-w-xs text-sm text-gray-500 truncate" title="${item.content}">${item.content}</td>
                        <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">${item.image ? `<button class="view-image text-indigo-600 hover:text-indigo-900">預覽</button>` : '無'}</td>
                        <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">${item.date}</td>
                        <td class="px-4 py-4 whitespace-nowrap text-sm font-medium">
                            <button class="view-detail text-blue-600 hover:text-blue-900">查看</button>
                            <button class="edit-item text-indigo-600 hover:text-indigo-900 ml-4">編輯</button>
                            <button class="delete-item text-red-600 hover:text-red-900 ml-4">刪除</button>
                        </td>`;
                }
                todoItemsList.appendChild(tr);
            });
        };

        // --- 搜尋 ---
        todoSearchInput.addEventListener('input', (e) => renderTodoItems(e.target.value.toLowerCase()));

    </script>
</body>
</html>
