<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>待辦事項管理系統</title>
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 Google Fonts 的 Inter 字體 -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* 自訂樣式 */
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
        }
        .completed > td:not(:first-child):not(:last-child) {
            text-decoration: line-through;
            color: #9ca3af; /* gray-400 */
        }
        .table-container {
            overflow-x: auto;
        }
        .edit-input {
            width: 100%;
            padding: 0.25rem 0.5rem;
            border: 1px solid #d1d5db; /* gray-300 */
            border-radius: 0.375rem;
            background-color: #f9fafb; /* gray-50 */
        }
        .new-item-highlight {
            background-color: #fef9c3; /* yellow-100 */
            transition: background-color 1.5s ease-out;
        }
        .filter-btn {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            border: 1px solid #d1d5db; /* gray-300 */
            background-color: #ffffff;
            color: #374151; /* gray-700 */
            font-weight: 500;
            transition: background-color 0.2s, color 0.2s, border-color 0.2s;
            cursor: pointer;
        }
        .filter-btn:hover {
            background-color: #f3f4f6; /* gray-100 */
        }
        .filter-btn.active {
            background-color: #4f46e5; /* indigo-600 */
            color: #ffffff;
            border-color: #4f46e5;
        }
        
        /* --- START: 優化後的列印專用樣式 --- */
        @media print {
            .print-hide {
                display: none !important;
            }

            /* --- PRINTING A SINGLE MODAL --- */
            body:not(.is-printing-list) > *:not(.printable-modal-container) {
                display: none;
            }
            body:not(.is-printing-list) .printable-modal-container {
                display: block !important;
                position: static;
                width: 100%;
                height: auto;
                background: transparent;
                overflow: visible;
            }
            body:not(.is-printing-list) .printable-content {
                position: static;
                width: 100%; margin: 0; padding: 1rem;
                border: none; box-shadow: none; max-height: none; overflow: visible;
            }
            body:not(.is-printing-list) #detailModal .printable-content { height: 98vh; }
            body:not(.is-printing-list) #detailModal .printable-content > .flex-1.min-h-0.overflow-y-auto { overflow: visible; flex: 1; }
            body:not(.is-printing-list) #detail-content { display: flex; flex-direction: column; height: 100%; }
            body:not(.is-printing-list) #detail-image-container { flex: 1; min-height: 0; display: flex; flex-direction: column; justify-content: center; }
            body:not(.is-printing-list) #detail-image { page-break-inside: avoid; max-width: 100%; max-height: 100%; object-fit: contain; }

            /* --- PRINTING THE EVENT LIST --- */
            body.is-printing-list #content-todo,
            body.is-printing-list #content-feedback {
                display: none !important;
            }

            body.is-printing-list main,
            body.is-printing-list #content-tracking {
                display: block !important;
            }

            body.is-printing-list #content-tracking .bg-white {
                box-shadow: none;
                border: none;
                padding: 0;
            }
            
            body.is-printing-list #event-print-header,
            body.is-printing-list #event-print-footer {
                display: block !important;
            }

            body.is-printing-list table {
                width: 100%;
                border-collapse: collapse;
            }
            body.is-printing-list th, body.is-printing-list td {
                border: 1px solid #e5e7eb;
                padding: 8px;
                font-size: 10pt;
                text-align: left;
            }
            body.is-printing-list thead {
                background-color: #f9fafb;
                display: table-header-group;
            }

            body.is-printing-list .toggle-event-closed,
            body.is-printing-list td:last-child,
            body.is-printing-list th:last-child {
                display: none;
            }
        }
        /* --- END: 優化後的列印專用樣式 --- */
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <main class="container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="text-center mb-8 print-hide">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-900">待辦事項管理系統</h1>
            <p class="text-gray-600 mt-2">一個簡單好用的待辦事項列表</p>
            <div id="auth-status" class="mt-4 text-sm text-gray-500">正在連接到 Firebase...</div>
        </header>
        
        <!-- START: Tab Navigation -->
        <div class="mb-6 border-b border-gray-200 print-hide">
            <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                <button id="tab-todo" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-indigo-500 text-indigo-600" aria-current="page">
                    待修改明細
                </button>
                <button id="tab-tracking" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
                    事件追蹤
                </button>
                <button id="tab-feedback" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
                    問題反饋紀錄
                </button>
            </nav>
        </div>
        <!-- END: Tab Navigation -->

        <!-- START: Tab Content -->
        <div id="content-todo">
            <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
                <!-- 左側：新增表單 -->
                <div id="form-container" class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg">
                    <div id="todo-form-view">
                        <h2 class="text-2xl font-bold mb-6 border-b pb-3">建立新待辦</h2>
                        <form id="addItemForm" class="space-y-4">
                            <input type="text" id="todo-productionId" placeholder="生產編號" class="w-full px-3 py-2 border rounded-md focus:ring-indigo-500 focus:border-indigo-500" required>
                            <input type="text" id="todo-assemblyId" placeholder="組裝編號" class="w-full px-3 py-2 border rounded-md focus:ring-indigo-500 focus:border-indigo-500" required>
                            <input type="text" id="todo-partNumber" placeholder="料號" class="w-full px-3 py-2 border rounded-md focus:ring-indigo-500 focus:border-indigo-500" required>
                            <textarea id="todo-content" placeholder="修改內容" rows="4" class="w-full px-3 py-2 border rounded-md focus:ring-indigo-500 focus:border-indigo-500" required></textarea>
                            <div><label class="text-sm">圖片 (小於 750KB)</label><input type="file" id="todo-imageUpload" class="w-full text-sm"></div>
                            <div><label class="text-sm">日期</label><input type="date" id="todo-date" class="w-full px-3 py-2 border rounded-md" required></div>
                            <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 disabled:bg-gray-400" disabled>新增項目</button>
                        </form>
                    </div>
                </div>

                <!-- 右側：待辦列表 -->
                <div id="list-container-todo" class="lg:col-span-3 bg-white p-6 rounded-xl shadow-lg">
                    <div id="todo-list-view">
                        <h2 class="text-2xl font-bold mb-6 border-b pb-3">待修改明細列表</h2>
                        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-4 gap-4">
                            <input type="text" id="todo-searchInput" placeholder="查詢 (生產/組裝/料號)..." class="w-full sm:w-auto flex-grow px-3 py-2 border rounded-md">
                            <div class="flex space-x-2 flex-shrink-0">
                                <button id="filter-all" class="filter-btn active">全部</button>
                                <button id="filter-pending" class="filter-btn">待處理</button>
                                <button id="filter-completed" class="filter-btn">已完成</button>
                            </div>
                        </div>
                        <div class="table-container">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">狀態</th>
                                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">生產編號</th>
                                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">組裝編號</th>
                                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">料號</th>
                                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">修改內容</th>
                                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">圖片</th>
                                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">日期</th>
                                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                                    </tr>
                                </thead>
                                <tbody id="todo-itemsList" class="bg-white divide-y divide-gray-200"></tbody>
                            </table>
                        </div>
                        <div id="pagination-container-todo" class="mt-6 flex justify-between items-center hidden">
                            <span id="page-info-todo" class="text-sm text-gray-700"></span>
                            <div id="pagination-buttons-todo" class="flex items-center space-x-1"></div>
                        </div>
                        <p id="todo-no-results" class="text-center py-8 hidden">找不到項目。</p>
                    </div>
                </div>
            </div>
        </div>
        <div id="content-tracking" class="hidden">
            <div class="bg-white p-8 rounded-xl shadow-lg">
                <form id="addEventForm" class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4 items-end mb-8 print-hide">
                    <h2 class="text-2xl font-bold md:col-span-2 border-b pb-3 mb-2">建立新事件</h2>
                    <div><label class="block text-sm font-medium text-gray-700">日期</label><input type="date" id="event-date" class="mt-1 w-full px-3 py-2 border rounded-md" required></div>
                    <div><label class="block text-sm font-medium text-gray-700">選擇上層任務 (可選)</label><select id="event-parentId" class="mt-1 w-full px-3 py-2 border rounded-md"><option value="">無 (設為頂層任務)</option></select></div>
                    <div class="md:col-span-2"><label class="block text-sm font-medium text-gray-700">事項</label><input type="text" id="event-matter" placeholder="事件內容" class="mt-1 w-full px-3 py-2 border rounded-md" required></div>
                    <div><label class="block text-sm font-medium text-gray-700">相關人員</label><input type="text" id="event-personnel" placeholder="相關人員" class="mt-1 w-full px-3 py-2 border rounded-md" required></div>
                    <div class="flex items-center pt-2"><input type="checkbox" id="event-closed" class="h-4 w-4 text-indigo-600 rounded mr-2"><label for="event-closed" class="text-sm font-medium text-gray-700">已結案</label></div>
                    <div class="md:col-span-2"><button type="submit" class="w-full md:w-auto bg-indigo-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-indigo-700 disabled:bg-gray-400">新增事件</button></div>
                </form>

                <div class="border-b pb-3 mb-6 print-hide">
                    <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
                        <h2 class="text-2xl font-bold">事件追蹤列表</h2>
                        <div class="flex items-center space-x-4">
                             <div>
                                <label for="event-sortSelect" class="sr-only">排序方式</label>
                                <select id="event-sortSelect" class="w-full sm:w-auto px-3 py-2 border rounded-md">
                                    <option value="createdAt-desc">最新建立</option>
                                    <option value="createdAt-asc">最舊建立</option>
                                    <option value="date-desc">日期 (新到舊)</option>
                                    <option value="date-asc">日期 (舊到新)</option>
                                    <option value="status-pending">狀態 (處理中優先)</option>
                                </select>
                            </div>
                            <input type="text" id="event-searchInput" placeholder="查詢事項或人員..." class="w-full sm:w-auto px-3 py-2 border rounded-md">
                            <button id="printEventListBtn" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 flex-shrink-0">列印列表</button>
                        </div>
                    </div>
                </div>
                <!-- Print Header -->
                <div id="event-print-header" class="hidden">
                    <div class="flex justify-between items-center mb-4">
                        <h1 class="text-2xl font-bold">廠務工作列表</h1>
                        <p id="event-print-date" class="text-sm"></p>
                    </div>
                </div>
                <div class="table-container">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50"><tr><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">日期</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">事項</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">相關人員</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">狀態</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th></tr></thead>
                        <tbody id="event-itemsList" class="bg-white divide-y divide-gray-200"></tbody>
                    </table>
                </div>
                <!-- Print Footer -->
                <div id="event-print-footer" class="hidden mt-12 pt-4 border-t text-center text-gray-500 text-sm">
                    <p>陸續更新中.....</p>
                </div>
                 <div id="pagination-container-event" class="mt-6 flex justify-between items-center hidden print-hide"><span id="page-info-event" class="text-sm text-gray-700"></span><div id="pagination-buttons-event" class="flex items-center space-x-1"></div></div>
                <p id="event-no-results" class="text-center py-8 hidden">找不到事件。</p>
            </div>
        </div>
        <div id="content-feedback" class="hidden">
             <div class="bg-white p-8 rounded-xl shadow-lg">
                <h2 class="text-2xl font-bold mb-6 border-b pb-3">建立新反饋</h2>
                <form id="addFeedbackForm" class="space-y-4 mb-8">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div><label class="block text-sm font-medium text-gray-700">類型</label><select id="feedback-type" class="mt-1 w-full px-3 py-2 border rounded-md"><option>硬體問題</option><option>軟體問題</option><option>操作問題</option><option>其他</option></select></div>
                        <div><label class="block text-sm font-medium text-gray-700">是否結案</label><select id="feedback-status" class="mt-1 w-full px-3 py-2 border rounded-md"><option>處理中</option><option>已結案</option></select></div>
                    </div>
                    <div><label class="block text-sm font-medium text-gray-700">問題內容</label><textarea id="feedback-problem" placeholder="詳細描述問題..." rows="3" class="mt-1 w-full px-3 py-2 border rounded-md" required></textarea></div>
                    <div><label class="block text-sm font-medium text-gray-700">解決方式</label><textarea id="feedback-solution" placeholder="記錄解決方式..." rows="3" class="mt-1 w-full px-3 py-2 border rounded-md"></textarea></div>
                    <div><button type="submit" class="w-full md:w-auto bg-indigo-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-indigo-700 disabled:bg-gray-400">新增反饋</button></div>
                </form>

                <h2 class="text-2xl font-bold mb-6 border-b pb-3">問題反饋列表</h2>
                <div class="flex justify-end mb-4">
                    <select id="feedback-filterType" class="w-full sm:w-1-3 px-3 py-2 border rounded-md">
                        <option value="">所有類型</option><option>硬體問題</option><option>軟體問題</option><option>操作問題</option><option>其他</option>
                    </select>
                </div>
                <div class="table-container">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50"><tr><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">類型</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">問題內容</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">解決方式</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">狀態</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th></tr></thead>
                        <tbody id="feedback-itemsList" class="bg-white divide-y divide-gray-200"></tbody>
                    </table>
                </div>
                 <div id="pagination-container-feedback" class="mt-6 flex justify-between items-center hidden"><span id="page-info-feedback" class="text-sm text-gray-700"></span><div id="pagination-buttons-feedback" class="flex items-center space-x-1"></div></div>
                <p id="feedback-no-results" class="text-center py-8 hidden">找不到反饋紀錄。</p>
            </div>
        </div>
        <!-- END: Tab Content -->
    </main>

    <!-- Modals -->
    <div id="imageModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden print-hide"><div class="bg-white p-4 rounded-lg max-w-3xl max-h-full overflow-auto"><img id="modalImage" src="" alt="預覽圖片" class="max-w-full max-h-[80vh] rounded"><button id="closeModal" class="absolute top-4 right-4 text-white text-3xl font-bold">&times;</button></div></div>
    <div id="notificationModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden print-hide"><div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full mx-4"><p id="notificationMessage" class="text-gray-800 text-base mb-4"></p><button id="closeNotificationModal" class="w-full bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700">確定</button></div></div>
    <div id="confirmationModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden print-hide"><div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full mx-4"><p id="confirmationMessage" class="text-gray-800 text-lg mb-6"></p><div class="flex justify-end space-x-4"><button id="confirmCancel" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">取消</button><button id="confirmOk" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">確定</button></div></div></div>
    
    <!-- Detail and Print Modal (Todo) -->
    <div id="detailModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden printable-modal-container">
        <div class="bg-white p-8 rounded-lg shadow-xl max-w-2xl w-full mx-4 relative flex flex-col max-h-[90vh] printable-content">
            <h2 class="text-2xl font-bold mb-6 border-b pb-3 flex-shrink-0">項目明細</h2>
            
            <div class="flex-1 min-h-0 overflow-y-auto"> <!-- Scrollable wrapper for on-screen view -->
                <div id="detail-content" class="space-y-4 text-gray-700">
                    <p><strong>生產編號:</strong> <span id="detail-productionId"></span></p>
                    <p><strong>組裝編號:</strong> <span id="detail-assemblyId"></span></p>
                    <p><strong>料號:</strong> <span id="detail-partNumber"></span></p>
                    <p><strong>日期:</strong> <span id="detail-date"></span></p>
                    <div>
                        <p><strong>修改內容:</strong></p>
                        <p id="detail-content-text" class="mt-1 p-2 border rounded bg-gray-50 whitespace-pre-wrap"></p>
                    </div>
                    <div id="detail-image-container" class="mt-4 hidden">
                        <p><strong>圖片預覽:</strong></p>
                        <img id="detail-image" src="" alt="項目圖片" class="mt-2 max-w-full h-auto rounded border">
                    </div>
                </div>
            </div>

            <div class="mt-8 pt-4 border-t flex justify-end space-x-4 flex-shrink-0 print-hide">
                <button id="closeDetailModal" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">關閉</button>
                <button id="printDetail" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">列印</button>
            </div>
        </div>
    </div>

    <!-- Detail and Print Modal (Event) -->
    <div id="eventDetailModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden printable-modal-container">
        <div class="bg-white p-8 rounded-lg shadow-xl max-w-2xl w-full mx-4 relative flex flex-col max-h-[90vh] printable-content">
            <h2 class="text-2xl font-bold mb-6 border-b pb-3 flex-shrink-0">事件明細</h2>
            <div class="space-y-4 text-gray-700">
                <p><strong>日期:</strong> <span id="detail-event-date"></span></p>
                <p><strong>事項:</strong> <span id="detail-event-matter"></span></p>
                <p><strong>相關人員:</strong> <span id="detail-event-personnel"></span></p>
                <p><strong>狀態:</strong> <span id="detail-event-status"></span></p>
            </div>
            <div class="mt-8 pt-4 border-t flex justify-end space-x-4 flex-shrink-0 print-hide">
                <button id="closeEventDetailModal" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">關閉</button>
                <button id="printEventDetail" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">列印</button>
            </div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, addDoc, onSnapshot, updateDoc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- DOM 元素 ---
        const tabTodo = document.getElementById('tab-todo');
        const tabTracking = document.getElementById('tab-tracking');
        const tabFeedback = document.getElementById('tab-feedback');
        const contentTodo = document.getElementById('content-todo');
        const contentTracking = document.getElementById('content-tracking');
        const contentFeedback = document.getElementById('content-feedback');
        
        // 待辦事項
        const addItemForm = document.getElementById('addItemForm');
        const todoItemsList = document.getElementById('todo-itemsList');
        const todoSearchInput = document.getElementById('todo-searchInput');
        const todoSubmitButton = addItemForm.querySelector('button[type="submit"]');
        const filterAllBtn = document.getElementById('filter-all');
        const filterPendingBtn = document.getElementById('filter-pending');
        const filterCompletedBtn = document.getElementById('filter-completed');
        const paginationContainerTodo = document.getElementById('pagination-container-todo');
        const pageInfoTodo = document.getElementById('page-info-todo');
        const paginationButtonsTodo = document.getElementById('pagination-buttons-todo');

        // 事件追蹤
        const addEventForm = document.getElementById('addEventForm');
        const eventItemsList = document.getElementById('event-itemsList');
        const eventSearchInput = document.getElementById('event-searchInput');
        const eventSortSelect = document.getElementById('event-sortSelect');
        const eventParentIdSelect = document.getElementById('event-parentId');
        const printEventListBtn = document.getElementById('printEventListBtn');
        const paginationContainerEvent = document.getElementById('pagination-container-event');
        const pageInfoEvent = document.getElementById('page-info-event');
        const paginationButtonsEvent = document.getElementById('pagination-buttons-event');
        const eventDetailModal = document.getElementById('eventDetailModal');
        const closeEventDetailModal = document.getElementById('closeEventDetailModal');
        const printEventDetail = document.getElementById('printEventDetail');
        const detailEventDate = document.getElementById('detail-event-date');
        const detailEventMatter = document.getElementById('detail-event-matter');
        const detailEventPersonnel = document.getElementById('detail-event-personnel');
        const detailEventStatus = document.getElementById('detail-event-status');

        // 問題反饋
        const addFeedbackForm = document.getElementById('addFeedbackForm');
        const feedbackItemsList = document.getElementById('feedback-itemsList');
        const feedbackFilterType = document.getElementById('feedback-filterType');
        const paginationContainerFeedback = document.getElementById('pagination-container-feedback');
        const pageInfoFeedback = document.getElementById('page-info-feedback');
        const paginationButtonsFeedback = document.getElementById('pagination-buttons-feedback');

        // 通用
        const authStatus = document.getElementById('auth-status');
        const imageModal = document.getElementById('imageModal');
        const modalImage = document.getElementById('modalImage');
        const closeModal = document.getElementById('closeModal');
        const notificationModal = document.getElementById('notificationModal');
        const notificationMessage = document.getElementById('notificationMessage');
        const closeNotificationModal = document.getElementById('closeNotificationModal');
        const confirmationModal = document.getElementById('confirmationModal');
        const confirmationMessage = document.getElementById('confirmationMessage');
        const confirmCancel = document.getElementById('confirmCancel');
        const confirmOk = document.getElementById('confirmOk');
        const detailModal = document.getElementById('detailModal');
        const closeDetailModal = document.getElementById('closeDetailModal');
        const printDetail = document.getElementById('printDetail');
        const detailProductionId = document.getElementById('detail-productionId');
        const detailAssemblyId = document.getElementById('detail-assemblyId');
        const detailPartNumber = document.getElementById('detail-partNumber');
        const detailDate = document.getElementById('detail-date');
        const detailContentText = document.getElementById('detail-content-text');
        const detailImageContainer = document.getElementById('detail-image-container');
        const detailImage = document.getElementById('detail-image');

        // --- 狀態變數 ---
        let allTodoItems = [], allEventItems = [], allFeedbackItems = [];
        let unsubscribeAllData = null;
        let confirmCallback = null;
        let editingItemId = null;
        let editingEventId = null;
        let currentFilter = 'all';
        let currentEventSort = 'createdAt-desc';
        let newItemsToHighlight = new Set();
        let currentPageTodo = 1, currentPageEvent = 1, currentPageFeedback = 1;
        const itemsPerPage = 8;

        // --- 日期初始化 ---
        document.getElementById('todo-date').valueAsDate = new Date();
        document.getElementById('event-date').valueAsDate = new Date();

        // --- Modal 輔助函數 ---
        const showNotification = (message) => { notificationMessage.textContent = message; notificationModal.classList.remove('hidden'); };
        const showConfirmation = (message, callback) => { confirmationMessage.textContent = message; confirmCallback = callback; confirmationModal.classList.remove('hidden'); };
        closeNotificationModal.addEventListener('click', () => notificationModal.classList.add('hidden'));
        confirmCancel.addEventListener('click', () => { confirmationModal.classList.add('hidden'); confirmCallback = null; });
        confirmOk.addEventListener('click', () => { confirmationModal.classList.add('hidden'); if (confirmCallback) confirmCallback(); confirmCallback = null; });
        closeModal.addEventListener('click', () => imageModal.classList.add('hidden'));
        imageModal.addEventListener('click', (e) => { if (e.target === imageModal) imageModal.classList.add('hidden'); });
        closeDetailModal.addEventListener('click', () => detailModal.classList.add('hidden'));
        printDetail.addEventListener('click', () => {
            detailModal.classList.add("printable-modal");
            window.print();
            detailModal.classList.remove("printable-modal");
        });
        closeEventDetailModal.addEventListener('click', () => eventDetailModal.classList.add('hidden'));
        printEventDetail.addEventListener('click', () => {
            window.print();
        });

        // --- Global Print Handlers ---
        window.addEventListener('afterprint', () => {
            document.body.classList.remove('is-printing-list');
            renderEventItems();
        });


        // --- Tab Switching ---
        const switchTab = (activeTab) => {
            const tabs = { todo: tabTodo, tracking: tabTracking, feedback: tabFeedback };
            const contents = { todo: contentTodo, tracking: contentTracking, feedback: contentFeedback };
            const activeClasses = 'whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-indigo-500 text-indigo-600';
            const inactiveClasses = 'whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300';
            
            for (const key in tabs) {
                if (key === activeTab) {
                    tabs[key].className = activeClasses;
                    tabs[key].setAttribute('aria-current', 'page');
                    contents[key].classList.remove('hidden');
                } else {
                    tabs[key].className = inactiveClasses;
                    tabs[key].removeAttribute('aria-current');
                    contents[key].classList.add('hidden');
                }
            }
        };

        tabTodo.addEventListener('click', () => switchTab('todo'));
        tabTracking.addEventListener('click', () => switchTab('tracking'));
        tabFeedback.addEventListener('click', () => switchTab('feedback'));

        // --- Firebase 設定 ---
        let firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const manualFirebaseConfig = { apiKey: "AIzaSyA7IeOz4EJ-yMUccDTPOSaDm33fLChVD8Q", authDomain: "sunyu-check.firebaseapp.com", projectId: "sunyu-check", storageBucket: "sunyu-check.firebasestorage.app", messagingSenderId: "627211744361", appId: "1:627211744361:web:58bce4b5009f0c9d5bdef8" };
        if (!firebaseConfig || Object.keys(firebaseConfig).length === 0) { firebaseConfig = manualFirebaseConfig; }
        const appId = typeof __app_id !== 'undefined' ? __app_id : (firebaseConfig.projectId || 'default-app-id');

        // --- Firebase 初始化 ---
        if (!firebaseConfig || !firebaseConfig.apiKey) {
            authStatus.textContent = "錯誤：找不到 Firebase 設定。";
        } else {
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);
            
            const appDataCollectionRef = collection(db, `/artifacts/${appId}/public/data/sharedTodoItems`);

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    authStatus.textContent = `已連線 | 公開共享模式`;
                    todoSubmitButton.disabled = false;
                    listenForAllData();
                } else {
                    authStatus.textContent = '正在驗證身份...';
                    try {
                        if (typeof __initial_auth_token !== 'undefined') await signInWithCustomToken(auth, __initial_auth_token);
                        else await signInAnonymously(auth);
                    } catch (error) { authStatus.textContent = '錯誤：無法連接。'; }
                }
            });

            // =================================================================
            // --- Unified Data Listener ---
            // =================================================================
            const listenForAllData = () => {
                if (unsubscribeAllData) unsubscribeAllData();
                unsubscribeAllData = onSnapshot(appDataCollectionRef, (snapshot) => {
                    allTodoItems = [];
                    allEventItems = [];
                    allFeedbackItems = [];

                    snapshot.docs.forEach(doc => {
                        const data = { id: doc.id, ...doc.data() };
                        switch(data.type) {
                            case 'event':
                                allEventItems.push(data);
                                break;
                            case 'feedback':
                                allFeedbackItems.push(data);
                                break;
                            case 'todo':
                            default:
                                allTodoItems.push(data);
                                break;
                        }
                    });
                    
                    updateParentTaskDropdown();
                    renderTodoItems();
                    renderEventItems();
                    renderFeedbackItems();
                });
            };


            // =================================================================
            // --- 待修改明細 (Todo) Section ---
            // =================================================================
            addItemForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const imageFile = document.getElementById('todo-imageUpload').files[0];
                if (imageFile && imageFile.size > 750 * 1024) { return showNotification("圖片檔案過大，請選擇小於 750KB 的圖片。"); }
                const reader = new FileReader();
                reader.onloadend = async () => {
                    try {
                        const docRef = await addDoc(appDataCollectionRef, {
                            type: 'todo',
                            productionId: document.getElementById('todo-productionId').value, assemblyId: document.getElementById('todo-assemblyId').value,
                            partNumber: document.getElementById('todo-partNumber').value, content: document.getElementById('todo-content').value,
                            date: document.getElementById('todo-date').value, image: reader.result || null,
                            completed: false, createdAt: serverTimestamp()
                        });
                        newItemsToHighlight.add(docRef.id);
                        addItemForm.reset();
                        document.getElementById('todo-date').valueAsDate = new Date();
                    } catch (error) { showNotification(`新增待辦失敗: ${error.message}`); }
                };
                if (imageFile) reader.readAsDataURL(imageFile); else reader.onloadend();
            });

            document.getElementById('list-container-todo').addEventListener('click', async (e) => {
                const target = e.target; const tr = target.closest('tr'); if (!tr) return;
                const id = tr.dataset.id; const docRef = doc(appDataCollectionRef, id);
                if (target.classList.contains('toggle-complete')) {
                    const item = allTodoItems.find(i => i.id === id); await updateDoc(docRef, { completed: !item.completed });
                } else if (target.classList.contains('delete-item')) {
                    showConfirmation('您確定要刪除這個項目嗎？', () => deleteDoc(docRef));
                } else if (target.classList.contains('view-image')) {
                    const item = allTodoItems.find(i => i.id === id); if (item && item.image) { modalImage.src = item.image; imageModal.classList.remove('hidden'); }
                } else if (target.classList.contains('view-detail')) { 
                    const item = allTodoItems.find(i => i.id === id); if (item) { populateAndShowDetailModal(item); }
                } else if (target.classList.contains('edit-item')) {
                    editingItemId = id; renderTodoItems();
                } else if (target.classList.contains('cancel-edit')) {
                    editingItemId = null; renderTodoItems();
                } else if (target.classList.contains('save-item')) {
                    try {
                        await updateDoc(docRef, {
                            productionId: tr.querySelector('.edit-productionId').value, assemblyId: tr.querySelector('.edit-assemblyId').value,
                            partNumber: tr.querySelector('.edit-partNumber').value, content: tr.querySelector('.edit-content').value,
                            date: tr.querySelector('.edit-date').value,
                        });
                        editingItemId = null;
                    } catch(error) { showNotification(`儲存失敗: ${error.message}`); }
                }
            });

            const renderTodoItems = () => {
                const searchTerm = todoSearchInput.value.toLowerCase();
                let filteredList = allTodoItems.filter(item => item.productionId?.toLowerCase().includes(searchTerm) || item.assemblyId?.toLowerCase().includes(searchTerm) || item.partNumber?.toLowerCase().includes(searchTerm));
                if (currentFilter === 'pending') { filteredList = filteredList.filter(item => !item.completed); } else if (currentFilter === 'completed') { filteredList = filteredList.filter(item => item.completed); }
                const paginatedItems = filteredList.slice((currentPageTodo - 1) * itemsPerPage, currentPageTodo * itemsPerPage);
                todoItemsList.innerHTML = ''; document.getElementById('todo-no-results').classList.toggle('hidden', filteredList.length > 0);
                paginatedItems.forEach(item => {
                    const isEditing = item.id === editingItemId; const tr = document.createElement('tr'); tr.dataset.id = item.id; if (item.completed) tr.classList.add('completed');
                    if (newItemsToHighlight.has(item.id)) { tr.classList.add('new-item-highlight'); setTimeout(() => tr.classList.remove('new-item-highlight'), 1500); newItemsToHighlight.delete(item.id); }
                    if (isEditing) {
                        tr.innerHTML = `<td class="px-4 py-4 whitespace-nowrap"><input type="checkbox" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500 toggle-complete" ${item.completed ? 'checked' : ''}></td><td class="px-4 py-4"><input class="edit-input edit-productionId" value="${item.productionId}"></td><td class="px-4 py-4"><input class="edit-input edit-assemblyId" value="${item.assemblyId || ''}"></td><td class="px-4 py-4"><input class="edit-input edit-partNumber" value="${item.partNumber}"></td><td class="px-4 py-4"><textarea class="edit-input edit-content">${item.content}</textarea></td><td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">無法編輯</td><td class="px-4 py-4"><input type="date" class="edit-input edit-date" value="${item.date}"></td><td class="px-4 py-4 whitespace-nowrap text-sm font-medium"><button class="save-item text-green-600 hover:text-green-900">儲存</button><button class="cancel-edit text-gray-600 hover:text-gray-900 ml-4">取消</button></td>`;
                    } else {
                        tr.innerHTML = `<td class="px-4 py-4 whitespace-nowrap"><input type="checkbox" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500 toggle-complete" ${item.completed ? 'checked' : ''}></td><td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">${item.productionId}</td><td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">${item.assemblyId || '-'}</td><td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">${item.partNumber}</td><td class="px-4 py-4 max-w-xs text-sm text-gray-500 truncate" title="${item.content}">${item.content}</td><td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">${item.image ? `<img src="${item.image}" alt="縮圖" class="view-image h-10 w-10 object-cover rounded cursor-pointer">` : '無'}</td><td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">${item.date}</td><td class="px-4 py-4 whitespace-nowrap text-sm font-medium"><button class="view-detail text-blue-600 hover:text-blue-900">查看</button><button class="edit-item text-indigo-600 hover:text-indigo-900 ml-4">編輯</button><button class="delete-item text-red-600 hover:text-red-900 ml-4">刪除</button></td>`;
                    }
                    todoItemsList.appendChild(tr);
                });
                setupPagination(filteredList.length, currentPageTodo, paginationContainerTodo, pageInfoTodo, paginationButtonsTodo, (page) => { currentPageTodo = page; renderTodoItems(); });
            };
            
            const setFilter = (filter) => { currentPageTodo = 1; currentFilter = filter; renderTodoItems(); updateFilterButtons(); };
            const updateFilterButtons = () => { filterAllBtn.classList.toggle('active', currentFilter === 'all'); filterPendingBtn.classList.toggle('active', currentFilter === 'pending'); filterCompletedBtn.classList.toggle('active', currentFilter === 'completed'); };
            filterAllBtn.addEventListener('click', () => setFilter('all')); filterPendingBtn.addEventListener('click', () => setFilter('pending')); filterCompletedBtn.addEventListener('click', () => setFilter('completed'));
            todoSearchInput.addEventListener('input', () => { currentPageTodo = 1; renderTodoItems(); });

            // =================================================================
            // --- 事件追蹤 (Event) Section ---
            // =================================================================
            addEventForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                try {
                    await addDoc(appDataCollectionRef, {
                        type: 'event',
                        date: document.getElementById('event-date').value, 
                        matter: document.getElementById('event-matter').value,
                        personnel: document.getElementById('event-personnel').value, 
                        closed: document.getElementById('event-closed').checked,
                        parentId: document.getElementById('event-parentId').value || null,
                        createdAt: serverTimestamp()
                    });
                    addEventForm.reset(); 
                    document.getElementById('event-date').valueAsDate = new Date();
                } catch (error) { showNotification(`新增事件失敗: ${error.message}`); }
            });

            contentTracking.addEventListener('click', async (e) => {
                const target = e.target;
                const id = target.dataset.id;
                const tr = target.closest('tr');

                if (target.classList.contains('delete-event')) {
                    showConfirmation('您確定要刪除這個事件嗎？其子任務將變為頂層任務。', () => deleteDoc(doc(appDataCollectionRef, id)));
                } else if (target.classList.contains('toggle-event-closed')) {
                    const item = allEventItems.find(i => i.id === id);
                    if (item) {
                        try {
                            await updateDoc(doc(appDataCollectionRef, id), { closed: !item.closed });
                        } catch (error) { showNotification(`更新狀態失敗: ${error.message}`); }
                    }
                } else if (target.classList.contains('view-event-detail')) {
                    const item = allEventItems.find(i => i.id === id);
                    if(item) populateAndShowEventDetailModal(item);
                } else if (target.classList.contains('edit-event')) {
                    editingEventId = id;
                    renderEventItems();
                } else if (target.classList.contains('cancel-edit-event')) {
                    editingEventId = null;
                    renderEventItems();
                } else if (target.classList.contains('save-event')) {
                     if (tr) {
                        try {
                            const updatedData = {
                                date: tr.querySelector('.edit-event-date').value,
                                matter: tr.querySelector('.edit-event-matter').value,
                                personnel: tr.querySelector('.edit-event-personnel').value,
                                parentId: tr.querySelector('.edit-event-parentId').value || null
                            };
                            await updateDoc(doc(appDataCollectionRef, id), updatedData);
                            editingEventId = null;
                        } catch (error) {
                            showNotification(`儲存失敗: ${error.message}`);
                            editingEventId = null;
                            renderEventItems();
                        }
                    }
                }
            });

            printEventListBtn.addEventListener('click', () => {
                const today = new Date();
                const yyyy = today.getFullYear();
                const mm = String(today.getMonth() + 1).padStart(2, '0');
                const dd = String(today.getDate()).padStart(2, '0');
                document.getElementById('event-print-date').textContent = `日期：${yyyy}/${mm}/${dd}`;
                
                document.body.classList.add('is-printing-list');
                renderEventItems();
                window.print();
            });
            
            eventSortSelect.addEventListener('change', (e) => {
                currentEventSort = e.target.value;
                currentPageEvent = 1;
                renderEventItems();
            });

            const updateParentTaskDropdown = (currentId = null) => {
                const options = allEventItems
                    .filter(item => item.id !== currentId) // Prevent self-selection
                    .map(item => `<option value="${item.id}">${item.matter}</option>`)
                    .join('');
                eventParentIdSelect.innerHTML = `<option value="">無 (設為頂層任務)</option>${options}`;
            };
            
            const renderEventItems = () => {
                const isPrinting = document.body.classList.contains('is-printing-list');
                const searchTerm = eventSearchInput.value.toLowerCase();
                
                let sortedList = [...allEventItems];
                switch (currentEventSort) {
                    case 'createdAt-asc': sortedList.sort((a, b) => (a.createdAt?.toMillis() || 0) - (b.createdAt?.toMillis() || 0)); break;
                    case 'date-desc': sortedList.sort((a, b) => new Date(b.date) - new Date(a.date)); break;
                    case 'date-asc': sortedList.sort((a, b) => new Date(a.date) - new Date(b.date)); break;
                    case 'status-pending': sortedList.sort((a, b) => a.closed - b.closed); break;
                    case 'createdAt-desc': default: sortedList.sort((a, b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0)); break;
                }

                const filteredList = searchTerm ? sortedList.filter(item => item.matter?.toLowerCase().includes(searchTerm) || item.personnel?.toLowerCase().includes(searchTerm)) : sortedList;
                
                const itemsById = new Map(filteredList.map(item => [item.id, item]));
                const childrenMap = new Map();
                filteredList.forEach(item => {
                    if (item.parentId && itemsById.has(item.parentId)) {
                        const parentChildren = childrenMap.get(item.parentId) || [];
                        parentChildren.push(item);
                        childrenMap.set(item.parentId, parentChildren);
                    }
                });

                const topLevelItems = filteredList.filter(item => !item.parentId || !itemsById.has(item.parentId));
                
                const paginatedTopLevel = isPrinting ? topLevelItems : topLevelItems.slice((currentPageEvent - 1) * itemsPerPage, currentPageEvent * itemsPerPage);

                if (!isPrinting) {
                    setupPagination(topLevelItems.length, currentPageEvent, paginationContainerEvent, pageInfoEvent, paginationButtonsEvent, (page) => { currentPageEvent = page; renderEventItems(); });
                }

                eventItemsList.innerHTML = ''; 
                document.getElementById('event-no-results').classList.toggle('hidden', filteredList.length > 0);
                
                const renderNodeAndChildren = (item, level) => {
                    const tr = document.createElement('tr');
                    const isEditing = item.id === editingEventId && !isPrinting;
                    
                    if (isEditing) {
                        const parentOptions = allEventItems
                            .filter(i => i.id !== item.id) // Prevent self-selection
                            .map(i => `<option value="${i.id}" ${i.id === item.parentId ? 'selected' : ''}>${i.matter}</option>`)
                            .join('');
                        tr.innerHTML = `
                            <td class="px-4 py-4"><input type="date" class="edit-input edit-event-date" value="${item.date}"></td>
                            <td class="px-4 py-4" colspan="2">
                                <input type="text" class="edit-input edit-event-matter mb-2" value="${item.matter || ''}">
                                <select class="w-full edit-input edit-event-parentId"><option value="">無 (設為頂層任務)</option>${parentOptions}</select>
                            </td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm"><span class="ml-2 align-middle ${item.closed ? 'text-gray-500' : 'text-gray-900'}">${item.closed ? '已結案' : '處理中'}</span></td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm font-medium">
                                <button data-id="${item.id}" class="save-event text-green-600 hover:text-green-900 mr-4">儲存</button>
                                <button data-id="${item.id}" class="cancel-edit-event text-gray-600 hover:text-gray-900">取消</button>
                            </td>`;
                    } else {
                         tr.innerHTML = `
                            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">${item.date}</td>
                            <td class="px-4 py-4 text-sm text-gray-900" style="padding-left: ${level * 1.5 + 1}rem;">${level > 0 ? '<span class="mr-2 text-gray-400">└</span>' : ''}${item.matter}</td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">${item.personnel}</td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm">
                                <input type="checkbox" data-id="${item.id}" class="toggle-event-closed align-middle h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500" ${item.closed ? 'checked' : ''}>
                                <span class="ml-2 align-middle ${item.closed ? 'text-gray-500 line-through' : 'text-gray-900'}">${item.closed ? '已結案' : '處理中'}</span>
                            </td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm font-medium">
                                <button data-id="${item.id}" class="view-event-detail text-blue-600 hover:text-blue-900 mr-4">查看</button>
                                <button data-id="${item.id}" class="edit-event text-indigo-600 hover:text-indigo-900 mr-4">編輯</button>
                                <button data-id="${item.id}" class="delete-event text-red-600 hover:text-red-900">刪除</button>
                            </td>`;
                    }
                    eventItemsList.appendChild(tr);

                    const children = childrenMap.get(item.id);
                    if (children) {
                        children.forEach(child => renderNodeAndChildren(child, level + 1));
                    }
                };
                
                paginatedTopLevel.forEach(item => renderNodeAndChildren(item, 0));
            };
            eventSearchInput.addEventListener('input', () => { currentPageEvent = 1; renderEventItems(); });

            // =================================================================
            // --- 問題反饋 (Feedback) Section ---
            // =================================================================
             addFeedbackForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const solution = document.getElementById('feedback-solution').value;
                const status = document.getElementById('feedback-status').value;
                if (status === '已結案' && !solution.trim()) { return showNotification('必須填寫解決方式才能結案。'); }
                try {
                    await addDoc(appDataCollectionRef, {
                        type: 'feedback',
                        feedbackType: document.getElementById('feedback-type').value,
                        problem: document.getElementById('feedback-problem').value,
                        solution: solution, status: status, createdAt: serverTimestamp()
                    });
                    addFeedbackForm.reset();
                } catch (error) { showNotification(`新增反饋失敗: ${error.message}`); }
            });

            contentFeedback.addEventListener('click', async (e) => {
                if (e.target.classList.contains('delete-feedback')) {
                    const id = e.target.dataset.id;
                    showConfirmation('您確定要刪除這條反饋嗎？', () => deleteDoc(doc(appDataCollectionRef, id)));
                }
            });

            const renderFeedbackItems = () => {
                const filterType = feedbackFilterType.value;
                const filteredList = allFeedbackItems.filter(item => !filterType || item.feedbackType === filterType);
                const paginatedItems = filteredList.slice((currentPageFeedback - 1) * itemsPerPage, currentPageFeedback * itemsPerPage);
                feedbackItemsList.innerHTML = ''; document.getElementById('feedback-no-results').classList.toggle('hidden', filteredList.length > 0);
                paginatedItems.forEach(item => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">${item.feedbackType}</td><td class="px-4 py-4 text-sm text-gray-900 max-w-xs truncate" title="${item.problem}">${item.problem}</td><td class="px-4 py-4 text-sm text-gray-500 max-w-xs truncate" title="${item.solution}">${item.solution || '-'}</td><td class="px-4 py-4 whitespace-nowrap text-sm ${item.status === '已結案' ? 'text-green-600' : 'text-yellow-600'}">${item.status}</td><td class="px-4 py-4 whitespace-nowrap text-sm font-medium"><button data-id="${item.id}" class="delete-feedback text-red-600 hover:text-red-900">刪除</button></td>`;
                    feedbackItemsList.appendChild(tr);
                });
                setupPagination(filteredList.length, currentPageFeedback, paginationContainerFeedback, pageInfoFeedback, paginationButtonsFeedback, (page) => { currentPageFeedback = page; renderFeedbackItems(); });
            };
            feedbackFilterType.addEventListener('change', () => { currentPageFeedback = 1; renderFeedbackItems(); });
        }
        
        // --- 通用分頁控制 ---
        const setupPagination = (totalItems, currentPage, container, infoEl, buttonsEl, onPageClick) => {
            buttonsEl.innerHTML = '';
            const pageCount = Math.ceil(totalItems / itemsPerPage);
            if (pageCount <= 1) { return container.classList.add('hidden'); }
            container.classList.remove('hidden');
            const startItem = (currentPage - 1) * itemsPerPage + 1;
            const endItem = Math.min(currentPage * itemsPerPage, totalItems);
            infoEl.textContent = `顯示 ${totalItems} 個項目中的 ${startItem}-${endItem} 項`;
            const createBtn = (text, onClick, enabled = true) => {
                const btn = document.createElement('button');
                btn.textContent = text;
                btn.disabled = !enabled;
                btn.className = `px-3 py-1 text-sm font-medium border rounded-md ${!enabled ? 'opacity-50 cursor-not-allowed' : 'hover:bg-gray-50'} ${text === currentPage ? 'bg-indigo-600 text-white border-indigo-600' : 'text-gray-700 bg-white border-gray-300'}`;
                btn.addEventListener('click', onClick);
                return btn;
            };
            buttonsEl.appendChild(createBtn('«', () => onPageClick(currentPage - 1), currentPage > 1));
            for (let i = 1; i <= pageCount; i++) { buttonsEl.appendChild(createBtn(i, () => onPageClick(i), true)); }
            buttonsEl.appendChild(createBtn('»', () => onPageClick(currentPage + 1), currentPage < pageCount));
        };

        // --- 填充並顯示明細 Modal 的函數 ---
        const populateAndShowDetailModal = (item) => {
            detailProductionId.textContent = item.productionId || '-'; detailAssemblyId.textContent = item.assemblyId || '-';
            detailPartNumber.textContent = item.partNumber || '-'; detailDate.textContent = item.date || '-';
            detailContentText.textContent = item.content || '-';
            if (item.image) {
                detailImage.src = item.image; detailImage.alt = `${item.partNumber} 的圖片`;
                detailImageContainer.classList.remove('hidden');
            } else { detailImageContainer.classList.add('hidden'); detailImage.src = ''; }
            detailModal.classList.remove('hidden');
        };

        const populateAndShowEventDetailModal = (item) => {
            detailEventDate.textContent = item.date || '-';
            detailEventMatter.textContent = item.matter || '-';
            detailEventPersonnel.textContent = item.personnel || '-';
            detailEventStatus.textContent = item.closed ? '已結案' : '處理中';
            eventDetailModal.classList.remove('hidden');
        };

    </script>
</body>
</html>

