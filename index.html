<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>待辦事項管理系統</title>
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 Google Fonts 的 Inter 字體 -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* 自訂樣式 */
        :root {
            --header-height: 50px;
            --timeline-header-height: 50px;
            --row-height: 40px;
            --border-color: #d1d5db; /* gray-300 */
            --sidebar-width: 630px; /* 初始側邊欄寬度 */
        }
        body {
            font-family: 'Inter', 'Noto Sans TC', '微軟正黑體', sans-serif;
        }
        .completed > td:not(:first-child):not(:last-child) {
            text-decoration: line-through;
            color: #9ca3af; /* gray-400 */
        }
        .table-container {
            overflow-x: auto;
        }
        .edit-input {
            width: 100%;
            padding: 0.25rem 0.5rem;
            border: 1px solid #d1d5db; /* gray-300 */
            border-radius: 0.375rem;
            background-color: #f9fafb; /* gray-50 */
        }
        .new-item-highlight {
            background-color: #fef9c3; /* yellow-100 */
            transition: background-color 1.5s ease-out;
        }
        .filter-btn {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            border: 1px solid #d1d5db; /* gray-300 */
            background-color: #ffffff;
            color: #374151; /* gray-700 */
            font-weight: 500;
            transition: background-color 0.2s, color 0.2s, border-color 0.2s;
            cursor: pointer;
        }
        .filter-btn:hover {
            background-color: #f3f4f6; /* gray-100 */
        }
        .filter-btn.active {
            background-color: #4f46e5; /* indigo-600 */
            color: #ffffff;
            border-color: #4f46e5;
        }
        
        .gantt-grid {
            display: grid;
            grid-template-columns: var(--sidebar-width) 1fr;
            height: calc(100vh - var(--header-height) - 150px); /* Approx header + tabs height */
        }
        .gantt-task-grid {
            border-right: 1px solid var(--border-color);
            overflow-x: auto;
            overflow-y: hidden;
        }
        .gantt-timeline {
            overflow-x: auto;
        }
        .gantt-task-row, .task-header {
            display: flex;
            height: var(--row-height);
            border-bottom: 1px solid var(--border-color);
            box-sizing: border-box;
        }
        .task-header {
            height: var(--timeline-header-height);
            border-bottom: 2px solid var(--border-color);
        }
        .task-header-cell, .task-cell {
            padding: 0.5rem;
            border-right: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            box-sizing: border-box;
            flex-shrink: 0;
        }
        .task-header-cell:last-child, .task-cell:last-child {
            border-right: none;
        }
        .task-header-cell {
            position: relative;
            font-weight: 600;
            font-size: 0.875rem;
            color: #4b5563;
            background-color: #f9fafb;
        }
        .col-resizer {
            position: absolute;
            right: -3px;
            top: 0;
            height: 100%;
            width: 6px;
            cursor: col-resize;
            z-index: 10;
        }
        .col-resizer:hover {
            background-color: rgba(59, 130, 246, 0.3);
        }
        .task-bar {
            position: absolute;
            height: 8px; /* 統一粗細 */
            border-radius: 4px; /* 統一圓角 */
            cursor: pointer;
            overflow: visible;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            padding: 0; /* 移除內距 */
        }
        .task-bar.parent-bar {
            overflow: visible;
            box-shadow: none;
        }
        .task-progress-fill {
            height: 100%;
            border-radius: 4px; /* 匹配外部圓角 */
        }
        .task-bar-label {
            position: absolute;
            left: calc(100% + 8px);
            top: 50%;
            transform: translateY(-50%);
            white-space: nowrap;
            font-size: 0.75rem;
            color: #4b5563;
        }
        .parent-cap {
            position: absolute;
            top: -4px;
            width: 2px;
            height: 16px;
            background-color: inherit;
        }
         /* Drag and Drop Styles */
        .gantt-task-row.dragging {
            opacity: 0.5;
            background: #f0f8ff;
        }
        .drop-indicator {
            position: absolute;
            height: 2px;
            background-color: #3b82f6; /* blue-500 */
            width: 100%;
            z-index: 20;
            pointer-events: none;
        }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        @media print {
            main.container {
                max-width: none !important;
                margin: 0 !important;
                padding: 0 !important;
            }
            /* --- START: General Print Styles --- */
            .print-hide {
                display: none !important;
            }

            /* --- START: Detail Modal Print Styles --- */
            body.is-printing-detail > *:not(.printable-modal-container.is-printing) {
                display: none !important;
            }
            body.is-printing-detail .printable-modal-container.is-printing {
                display: block !important;
                position: static !important;
                width: 100%;
                height: auto;
                background: transparent;
                overflow: visible;
            }
            body.is-printing-detail .printable-content {
                position: static;
                width: 100%; margin: 0; padding: 1rem;
                border: none; box-shadow: none; max-height: none; overflow: visible;
            }
            body.is-printing-detail #detailModal .printable-content { height: 98vh; }
            body.is-printing-detail #detailModal .printable-content > .flex-1.min-h-0.overflow-y-auto { overflow: visible; flex: 1; }
            body.is-printing-detail #detailModal #detail-content { display: flex; flex-direction: column; height: 100%; }
            body.is-printing-detail #detailModal #detail-image-container { flex: 1; min-height: 0; display: flex; flex-direction: column; justify-content: center; }
            body.is-printing-detail #detailModal #detail-image { page-break-inside: avoid; max-width: 100%; max-height: 100%; object-fit: contain; }

            /* --- START: List Print Styles --- */
            body.is-printing-list > *:not(main),
            body.is-printing-list main > *:not(#content-tracking) {
                display: none !important;
            }
            body.is-printing-list #content-todo,
            body.is-printing-list #content-feedback,
            body.is-printing-list #content-gantt,
            body.is-printing-list .printable-modal-container {
                display: none !important;
            }
            body.is-printing-list main,
            body.is-printing-list #content-tracking {
                display: block !important;
            }
            body.is-printing-list #content-tracking .bg-white {
                box-shadow: none; border: none; padding: 0;
            }
            body.is-printing-list #event-print-header,
            body.is-printing-list #event-print-footer {
                display: block !important;
            }
            body.is-printing-list table {
                width: 100%; border-collapse: collapse;
            }
            body.is-printing-list th, body.is-printing-list td {
                border: 1px solid #000000; padding: 8px; font-size: 10pt; text-align: left;
            }
            body.is-printing-list thead {
                background-color: #f9fafb; display: table-header-group;
            }
            body.is-printing-list .toggle-event-closed,
            body.is-printing-list td:last-child,
            body.is-printing-list th:last-child {
                display: none;
            }
            body.is-printing-list tr.event-item-closed td {
                background-color: #f3f4f6 !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            /* --- Gantt Print Styles --- */
            @page {
                size: A4 portrait;
                margin: 1cm;
            }
            body.is-printing-gantt > *:not(main),
            body.is-printing-gantt > main > *:not(#content-gantt) {
                display: none !important;
            }
            body.is-printing-gantt #content-gantt {
                display: block !important;
            }
            body.is-printing-gantt #gantt-screen-header {
                display: none !important;
            }
            #gantt-print-header {
                display: none;
            }
            body.is-printing-gantt #gantt-print-header {
                display: block !important;
            }
            body.is-printing-gantt {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            body.is-printing-gantt .col-resizer {
                display: none !important;
            }
            body.is-printing-gantt #gantt-container {
                display: flex !important;
                flex-direction: row !important;
                width: 100% !important;
                height: auto !important;
                overflow: visible !important;
            }
            body.is-printing-gantt .gantt-task-grid {
                flex: 0 0 var(--sidebar-width) !important;
                width: var(--sidebar-width) !important;
                border-right: 1px solid #ccc !important;
                overflow: visible !important;
                height: auto !important;
            }
            body.is-printing-gantt .gantt-timeline {
                flex: 1 1 auto !important;
                width: auto !important;
                overflow: visible !important;
                height: auto !important;
            }
            body.is-printing-gantt .task-header, 
            body.is-printing-gantt #timeline-header {
                position: static !important;
            }
            body.is-printing-gantt .gantt-task-row {
                page-break-inside: avoid;
            }
            /* Progress Bar Print Control */
            body.is-printing-gantt:not(.print-with-progress) .task-bar {
                display: none !important;
            }
            body.is-printing-gantt.print-with-progress .task-bar {
                display: block !important;
            }
            body.is-printing-gantt .task-bar,
            body.is-printing-gantt .task-progress-fill,
            body.is-printing-gantt .parent-bar {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            body.is-printing-gantt.print-no-assignee .gantt-assignee-col {
                display: none !important;
            }
            body.is-printing-gantt.print-no-progress-col .gantt-progress-col {
                display: none !important;
            }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <main class="container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="text-center mb-8 print-hide">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-900">待辦事項管理系統</h1>
            <p class="text-gray-600 mt-2">一個簡單好用的待辦事項列表</p>
            <div id="auth-status" class="mt-4 text-sm text-gray-500">正在連接到 Firebase...</div>
        </header>
        
        <!-- START: Tab Navigation -->
        <div class="mb-6 border-b border-gray-200 print-hide">
            <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                <button id="tab-todo" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-indigo-500 text-indigo-600" aria-current="page">
                    待修改明細
                </button>
                <button id="tab-tracking" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
                    事件追蹤
                </button>
                <button id="tab-feedback" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
                    問題反饋紀錄
                </button>
                <button id="tab-gantt" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
                    周計畫排程
                </button>
            </nav>
        </div>
        <!-- END: Tab Navigation -->

        <!-- START: Tab Content -->
        <div id="content-todo">
            <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
                <!-- 左側：新增表單 -->
                <div id="form-container" class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg">
                    <div id="todo-form-view">
                        <h2 class="text-2xl font-bold mb-6 border-b pb-3">建立新待辦</h2>
                        <form id="addItemForm" class="space-y-4">
                            <input type="text" id="todo-productionId" placeholder="生產編號" class="w-full px-3 py-2 border rounded-md focus:ring-indigo-500 focus:border-indigo-500" required>
                            <input type="text" id="todo-assemblyId" placeholder="組裝編號" class="w-full px-3 py-2 border rounded-md focus:ring-indigo-500 focus:border-indigo-500" required>
                            <input type="text" id="todo-partNumber" placeholder="料號" class="w-full px-3 py-2 border rounded-md focus:ring-indigo-500 focus:border-indigo-500" required>
                            <textarea id="todo-content" placeholder="修改內容" rows="4" class="w-full px-3 py-2 border rounded-md focus:ring-indigo-500 focus:border-indigo-500" required></textarea>
                            <div><label class="text-sm">圖片 (小於 750KB)</label><input type="file" id="todo-imageUpload" class="w-full text-sm"></div>
                            <div><label class="text-sm">日期</label><input type="date" id="todo-date" class="w-full px-3 py-2 border rounded-md" required></div>
                            <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 disabled:bg-gray-400" disabled>新增項目</button>
                        </form>
                    </div>
                </div>

                <!-- 右側：待辦列表 -->
                <div id="list-container-todo" class="lg:col-span-3 bg-white p-6 rounded-xl shadow-lg">
                    <div id="todo-list-view">
                        <h2 class="text-2xl font-bold mb-6 border-b pb-3">待修改明細列表</h2>
                        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-4 gap-4">
                            <input type="text" id="todo-searchInput" placeholder="查詢 (生產/組裝/料號)..." class="w-full sm:w-auto flex-grow px-3 py-2 border rounded-md">
                            <div class="flex space-x-2 flex-shrink-0">
                                <button id="filter-all" class="filter-btn active">全部</button>
                                <button id="filter-pending" class="filter-btn">待處理</button>
                                <button id="filter-completed" class="filter-btn">已完成</button>
                                <button id="filter-handedOver" class="filter-btn">已移交</button>
                            </div>
                        </div>
                        <div class="table-container">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">狀態</th>
                                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">生產編號</th>
                                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">組裝編號</th>
                                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">料號</th>
                                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">修改內容</th>
                                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">圖片</th>
                                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">日期</th>
                                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                                    </tr>
                                </thead>
                                <tbody id="todo-itemsList" class="bg-white divide-y divide-gray-200"></tbody>
                            </table>
                        </div>
                        <div id="pagination-container-todo" class="mt-6 flex justify-between items-center hidden">
                            <span id="page-info-todo" class="text-sm text-gray-700"></span>
                            <div id="pagination-buttons-todo" class="flex items-center space-x-1"></div>
                        </div>
                        <p id="todo-no-results" class="text-center py-8 hidden">找不到項目。</p>
                    </div>
                </div>
            </div>
        </div>
        <div id="content-tracking" class="hidden">
            <div class="bg-white p-8 rounded-xl shadow-lg">
                <form id="addEventForm" class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end mb-8 print-hide">
                    <h2 class="text-2xl font-bold md:col-span-3 border-b pb-3 mb-2">建立新事件</h2>
                    <div><label class="block text-sm font-medium text-gray-700">日期</label><input type="date" id="event-date" class="mt-1 w-full px-3 py-2 border rounded-md" required></div>
                    <div><label class="block text-sm font-medium text-gray-700">事項</label><input type="text" id="event-matter" placeholder="事件內容" class="mt-1 w-full px-3 py-2 border rounded-md" required></div>
                    <div><label class="block text-sm font-medium text-gray-700">相關人員</label><input type="text" id="event-personnel" placeholder="相關人員" class="mt-1 w-full px-3 py-2 border rounded-md" required></div>
                     <div>
                        <label class="block text-sm font-medium text-gray-700">優先順序</label>
                        <select id="event-priority" class="mt-1 w-full px-3 py-2 border rounded-md">
                            <option value="medium">2 (次要)</option>
                            <option value="high">1 (最優先)</option>
                            <option value="low">3 (較緩)</option>
                        </select>
                    </div>
                    <div class="flex items-center pt-2"><input type="checkbox" id="event-closed" class="h-4 w-4 text-indigo-600 rounded mr-2"><label for="event-closed" class="text-sm font-medium text-gray-700">已結案</label></div>
                    <div class="md:col-span-3"><button type="submit" class="w-full md:w-auto bg-indigo-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-indigo-700 disabled:bg-gray-400">新增事件</button></div>
                </form>

                <div class="border-b pb-3 mb-6 print-hide">
                    <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
                        <div class="flex items-center gap-4">
                             <h2 class="text-2xl font-bold">事件追蹤列表</h2>
                             <div class="flex space-x-2 flex-shrink-0">
                                <button id="event-view-active" class="filter-btn active">進行中</button>
                                <button id="event-view-archived" class="filter-btn">已封存</button>
                            </div>
                        </div>
                        <div class="flex items-center space-x-4">
                            <div>
                                <label for="event-sortSelect" class="sr-only">排序方式</label>
                                <select id="event-sortSelect" class="w-full sm:w-auto px-3 py-2 border rounded-md">
                                    <option value="createdAt-desc">最新建立</option>
                                    <option value="createdAt-asc">最舊建立</option>
                                    <option value="date-desc">日期 (新到舊)</option>
                                    <option value="date-asc">日期 (舊到新)</option>
                                    <option value="status-pending">狀態 (處理中優先)</option>
                                    <option value="priority-desc">優先順序 (高到低)</option>
                                </select>
                            </div>
                            <input type="text" id="event-searchInput" placeholder="查詢事項或人員..." class="w-full sm:w-auto px-3 py-2 border rounded-md">
                            <button id="printEventListBtn" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 flex-shrink-0">列印列表</button>
                        </div>
                    </div>
                </div>
                <!-- Print Header -->
                <div id="event-print-header" class="hidden">
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex items-center gap-4">
                            
                            <div>
                                <h1 class="text-2xl font-bold">廠務工作列表</h1>
                                <p class="text-xs text-gray-600 mt-1">優先順序說明：1 (最優先), 2 (次要), 3 (較緩)</p>
                            </div>
                        </div>
                        <p id="event-print-date" class="text-sm"></p>
                    </div>
                </div>
                <div class="table-container">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">優先順序</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">日期</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">事項</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">相關人員</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">流程追蹤</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">狀態</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                            </tr>
                        </thead>
                        <tbody id="event-itemsList" class="bg-white divide-y divide-gray-200"></tbody>
                    </table>
                </div>
                <!-- Print Footer -->
                <div id="event-print-footer" class="hidden mt-12 pt-4 border-t text-center text-gray-500 text-sm">
                    <p>陸續更新中.....</p>
                    
                </div>
                <p id="event-no-results" class="text-center py-8 hidden">找不到事件。</p>
            </div>
        </div>
        <div id="content-feedback" class="hidden">
             <div class="bg-white p-8 rounded-xl shadow-lg">
                <h2 class="text-2xl font-bold mb-6 border-b pb-3">建立新反饋</h2>
                <form id="addFeedbackForm" class="space-y-4 mb-8">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div><label class="block text-sm font-medium text-gray-700">類型</label><select id="feedback-type" class="mt-1 w-full px-3 py-2 border rounded-md"><option>硬體問題</option><option>軟體問題</option><option>操作問題</option><option>其他</option></select></div>
                        <div><label class="block text-sm font-medium text-gray-700">是否結案</label><select id="feedback-status" class="mt-1 w-full px-3 py-2 border rounded-md"><option>處理中</option><option>已結案</option></select></div>
                    </div>
                    <div><label class="block text-sm font-medium text-gray-700">問題內容</label><textarea id="feedback-problem" placeholder="詳細描述問題..." rows="3" class="mt-1 w-full px-3 py-2 border rounded-md" required></textarea></div>
                    <div><label class="block text-sm font-medium text-gray-700">解決方式</label><textarea id="feedback-solution" placeholder="記錄解決方式..." rows="3" class="mt-1 w-full px-3 py-2 border rounded-md"></textarea></div>
                    <div><button type="submit" class="w-full md:w-auto bg-indigo-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-indigo-700 disabled:bg-gray-400">新增反饋</button></div>
                </form>

                <h2 class="text-2xl font-bold mb-6 border-b pb-3">問題反饋列表</h2>
                <div class="flex justify-end mb-4">
                    <select id="feedback-filterType" class="w-full sm:w-1/3 px-3 py-2 border rounded-md">
                        <option value="">所有類型</option><option>硬體問題</option><option>軟體問題</option><option>操作問題</option><option>其他</option>
                    </select>
                </div>
                <div class="table-container">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50"><tr><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">類型</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">問題內容</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">解決方式</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">狀態</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th></tr></thead>
                        <tbody id="feedback-itemsList" class="bg-white divide-y divide-gray-200"></tbody>
                    </table>
                </div>
                 <div id="pagination-container-feedback" class="mt-6 flex justify-between items-center hidden"><span id="page-info-feedback" class="text-sm text-gray-700"></span><div id="pagination-buttons-feedback" class="flex items-center space-x-1"></div></div>
                <p id="feedback-no-results" class="text-center py-8 hidden">找不到反饋紀錄。</p>
            </div>
        </div>
        <!-- START: Gantt Chart Content -->
        <div id="content-gantt" class="hidden">
             <!-- Print Header for Gantt -->
             <div id="gantt-print-header">
                <div class="flex justify-between items-center mb-4">
                    <h1 class="text-2xl font-bold">周計畫排程</h1>
                    <p id="gantt-print-date" class="text-sm"></p>
                </div>
             </div>
             <!-- Screen Header -->
            <header id="gantt-screen-header" class="bg-white shadow-md flex items-center justify-between px-6 mb-4 rounded-lg" style="height: var(--header-height);">
                <div class="flex items-center space-x-4">
                    <h1 class="text-xl font-bold text-gray-700">周計畫排程</h1>
                    <span id="gantt-current-date" class="text-sm text-gray-500"></span>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="flex items-center space-x-2">
                        <input type="checkbox" id="printProgressToggle" checked class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                        <label for="printProgressToggle" class="text-sm font-medium text-gray-700">列印進度條</label>
                    </div>
                    <div class="flex items-center space-x-2">
                        <input type="checkbox" id="printAssigneeToggle" checked class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                        <label for="printAssigneeToggle" class="text-sm font-medium text-gray-700">列印人員</label>
                    </div>
                     <div class="flex items-center space-x-2">
                        <input type="checkbox" id="printProgressColumnToggle" checked class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                        <label for="printProgressColumnToggle" class="text-sm font-medium text-gray-700">列印進度</label>
                    </div>
                    <div class="flex items-center space-x-2">
                        <input type="checkbox" id="hideCompletedTasksToggle" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                        <label for="hideCompletedTasksToggle" class="text-sm font-medium text-gray-700">隱藏已完成</label>
                    </div>
                    <button id="ganttPrintBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded-lg shadow transition-transform transform hover:scale-105">
                        列印
                    </button>
                    <button id="ganttAddTaskBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow transition-transform transform hover:scale-105">
                        新增任務
                    </button>
                </div>
            </header>

            <!-- Gantt Chart Container -->
            <main id="gantt-container" class="gantt-grid">
                <!-- Task Grid (Left Side) -->
                <div id="gantt-task-grid" class="gantt-task-grid bg-white">
                    <div id="task-grid-header" class="task-header sticky top-0 bg-gray-50 z-10"></div>
                    <div id="task-list-body" class="relative"></div>
                </div>

                <!-- Timeline (Right Side) -->
                <div id="gantt-timeline" class="gantt-timeline">
                    <div id="timeline-header" class="timeline-header sticky top-0 bg-gray-50 z-10" style="position: sticky; top: 0;"></div>
                    <div id="timeline-body" class="relative"></div>
                </div>
            </main>
        </div>
        <!-- END: Gantt Chart Content -->
        <!-- END: Tab Content -->
    </main>

    <!-- Modals -->
    <div id="imageModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden print-hide"><div class="bg-white p-4 rounded-lg max-w-3xl max-h-full overflow-auto"><img id="modalImage" src="" alt="預覽圖片" class="max-w-full max-h-[80vh] rounded"><button id="closeModal" class="absolute top-4 right-4 text-white text-3xl font-bold">&times;</button></div></div>
    <div id="notificationModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden print-hide"><div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full mx-4"><p id="notificationMessage" class="text-gray-800 text-base mb-4"></p><button id="closeNotificationModal" class="w-full bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700">確定</button></div></div>
    <div id="confirmationModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden print-hide"><div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full mx-4"><p id="confirmationMessage" class="text-gray-800 text-lg mb-6"></p><div class="flex justify-end space-x-4"><button id="confirmCancel" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">取消</button><button id="confirmOk" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">確定</button></div></div></div>
    
    <!-- Detail and Print Modal (Todo) -->
    <div id="detailModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden printable-modal-container">
        <div class="bg-white p-8 rounded-lg shadow-xl max-w-2xl w-full mx-4 relative flex flex-col max-h-[90vh] printable-content">
            <h2 class="text-2xl font-bold mb-6 border-b pb-3 flex-shrink-0">項目明細</h2>
            
            <div class="flex-1 min-h-0 overflow-y-auto"> <!-- Scrollable wrapper for on-screen view -->
                <div id="detail-content" class="space-y-4 text-gray-700">
                    <p><strong>生產編號:</strong> <span id="detail-productionId"></span></p>
                    <p><strong>組裝編號:</strong> <span id="detail-assemblyId"></span></p>
                    <p><strong>料號:</strong> <span id="detail-partNumber"></span></p>
                    <p><strong>日期:</strong> <span id="detail-date"></span></p>
                    <div>
                        <p><strong>修改內容:</strong></p>
                        <p id="detail-content-text" class="mt-1 p-2 border rounded bg-gray-50 whitespace-pre-wrap"></p>
                    </div>
                    <div id="detail-image-container" class="mt-4 hidden">
                        <p><strong>圖片預覽:</strong></p>
                        <img id="detail-image" src="" alt="項目圖片" class="mt-2 max-w-full h-auto rounded border">
                    </div>
                </div>
            </div>

            <div class="mt-8 pt-4 border-t flex justify-end space-x-4 flex-shrink-0 print-hide">
                <button id="closeDetailModal" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">關閉</button>
                <button id="printDetail" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">列印</button>
            </div>
        </div>
    </div>

    <!-- Detail and Print Modal (Event) -->
    <div id="eventDetailModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden printable-modal-container">
        <div class="bg-white p-8 rounded-lg shadow-xl max-w-2xl w-full mx-4 relative flex flex-col max-h-[90vh] printable-content">
            <h2 class="text-2xl font-bold mb-6 border-b pb-3 flex-shrink-0">事件明細</h2>
            <div class="space-y-4 text-gray-700">
                <p><strong>日期:</strong> <span id="detail-event-date"></span></p>
                <p><strong>事項:</strong> <span id="detail-event-matter"></span></p>
                <p><strong>相關人員:</strong> <span id="detail-event-personnel"></span></p>
                <p><strong>狀態:</strong> <span id="detail-event-status"></span></p>
            </div>
            <div class="mt-8 pt-4 border-t flex justify-end space-x-4 flex-shrink-0 print-hide">
                <button id="closeEventDetailModal" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">關閉</button>
                <button id="printEventDetail" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">列印</button>
            </div>
        </div>
    </div>
    
    <!-- Modal for Add/Edit Task (Gantt) -->
    <div id="ganttTaskModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center">
        <div id="gantt-modal-content" class="bg-white rounded-lg shadow-2xl p-8 w-full max-w-md transform transition-all scale-95 opacity-0" >
            <h2 id="ganttModalTitle" class="text-2xl font-bold mb-6 text-gray-800">新增任務</h2>
            <form id="ganttTaskForm">
                <input type="hidden" id="ganttTaskId">
                <div class="mb-4">
                    <label for="ganttTaskName" class="block text-sm font-medium text-gray-700 mb-1">任務名稱</label>
                    <input type="text" id="ganttTaskName" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                </div>
                <div class="mb-4">
                    <label for="ganttTaskAssignee" class="block text-sm font-medium text-gray-700 mb-1">負責人員</label>
                    <input type="text" id="ganttTaskAssignee" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="ganttTaskStart" class="block text-sm font-medium text-gray-700 mb-1">開始日期</label>
                        <input type="date" id="ganttTaskStart" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                    </div>
                    <div>
                        <label for="ganttTaskDuration" class="block text-sm font-medium text-gray-700 mb-1">工期 (工作日)</label>
                        <input type="number" id="ganttTaskDuration" min="1" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                    </div>
                </div>
                <div class="mb-6">
                    <label for="ganttTaskProgress" class="block text-sm font-medium text-gray-700 mb-1">進度 (%)</label>
                    <input type="range" id="ganttTaskProgress" min="0" max="100" value="0" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                    <span id="ganttProgressValue" class="text-sm text-gray-600">0%</span>
                </div>
                 <div class="mb-4">
                    <label for="ganttTaskParent" class="block text-sm font-medium text-gray-700 mb-1">父任務 (可選)</label>
                    <select id="ganttTaskParent" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        <option value="">無</option>
                    </select>
                </div>
                <div class="flex justify-end space-x-4">
                    <button type="button" id="ganttCancelBtn" class="px-6 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none">取消</button>
                    <button type="button" id="ganttDeleteBtn" class="px-6 py-2 bg-red-600 text-white rounded-md text-sm font-medium hover:bg-red-700 focus:outline-none hidden">刪除</button>
                    <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded-md text-sm font-medium hover:bg-blue-700 focus:outline-none">儲存</button>
                </div>
            </form>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, addDoc, onSnapshot, updateDoc, deleteDoc, serverTimestamp, writeBatch, query, where, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        document.addEventListener('DOMContentLoaded', () => {
            
            // --- DOM 元素 ---
            const mainContent = document.getElementById('main-content');
            const tabTodo = document.getElementById('tab-todo');
            const tabTracking = document.getElementById('tab-tracking');
            const tabFeedback = document.getElementById('tab-feedback');
            const tabGantt = document.getElementById('tab-gantt');
            const contentTodo = document.getElementById('content-todo');
            const contentTracking = document.getElementById('content-tracking');
            const contentFeedback = document.getElementById('content-feedback');
            const contentGantt = document.getElementById('content-gantt');
            
            // 待辦事項
            const addItemForm = document.getElementById('addItemForm');
            const todoItemsList = document.getElementById('todo-itemsList');
            const todoSearchInput = document.getElementById('todo-searchInput');
            const todoSubmitButton = addItemForm.querySelector('button[type="submit"]');
            const filterAllBtn = document.getElementById('filter-all');
            const filterPendingBtn = document.getElementById('filter-pending');
            const filterCompletedBtn = document.getElementById('filter-completed');
            const filterHandedOverBtn = document.getElementById('filter-handedOver');
            const paginationContainerTodo = document.getElementById('pagination-container-todo');
            const pageInfoTodo = document.getElementById('page-info-todo');
            const paginationButtonsTodo = document.getElementById('pagination-buttons-todo');

            // 事件追蹤
            const addEventForm = document.getElementById('addEventForm');
            const eventItemsList = document.getElementById('event-itemsList');
            const eventSearchInput = document.getElementById('event-searchInput');
            const eventSortSelect = document.getElementById('event-sortSelect');
            const printEventListBtn = document.getElementById('printEventListBtn');
            const eventViewActiveBtn = document.getElementById('event-view-active');
            const eventViewArchivedBtn = document.getElementById('event-view-archived');
            const eventDetailModal = document.getElementById('eventDetailModal');
            const closeEventDetailModal = document.getElementById('closeEventDetailModal');
            const printEventDetail = document.getElementById('printEventDetail');
            const detailEventDate = document.getElementById('detail-event-date');
            const detailEventMatter = document.getElementById('detail-event-matter');
            const detailEventPersonnel = document.getElementById('detail-event-personnel');
            const detailEventStatus = document.getElementById('detail-event-status');

            // 問題反饋
            const addFeedbackForm = document.getElementById('addFeedbackForm');
            const feedbackItemsList = document.getElementById('feedback-itemsList');
            const feedbackFilterType = document.getElementById('feedback-filterType');
            const paginationContainerFeedback = document.getElementById('pagination-container-feedback');
            const pageInfoFeedback = document.getElementById('page-info-feedback');
            const paginationButtonsFeedback = document.getElementById('pagination-buttons-feedback');

            // 通用
            const authStatus = document.getElementById('auth-status');
            const imageModal = document.getElementById('imageModal');
            const modalImage = document.getElementById('modalImage');
            const closeModal = document.getElementById('closeModal');
            const notificationModal = document.getElementById('notificationModal');
            const notificationMessage = document.getElementById('notificationMessage');
            const closeNotificationModal = document.getElementById('closeNotificationModal');
            const confirmationModal = document.getElementById('confirmationModal');
            const confirmationMessage = document.getElementById('confirmationMessage');
            const confirmCancel = document.getElementById('confirmCancel');
            const confirmOk = document.getElementById('confirmOk');
            const detailModal = document.getElementById('detailModal');
            const closeDetailModal = document.getElementById('closeDetailModal');
            const printDetail = document.getElementById('printDetail');
            const detailProductionId = document.getElementById('detail-productionId');
            const detailAssemblyId = document.getElementById('detail-assemblyId');
            const detailPartNumber = document.getElementById('detail-partNumber');
            const detailDate = document.getElementById('detail-date');
            const detailContentText = document.getElementById('detail-content-text');
            const detailImageContainer = document.getElementById('detail-image-container');
            const detailImage = document.getElementById('detail-image');

            // --- 狀態變數 ---
            let allTodoItems = [], allEventItems = [], allFeedbackItems = [], allGanttTasks = [];
            let unsubscribeAllData = null;
            let confirmCallback = null;
            let editingItemId = null;
            let editingEventId = null;
            let currentFilter = 'all';
            let currentEventSort = 'createdAt-desc';
            let eventViewMode = 'active'; // 'active' or 'archived'
            let newItemsToHighlight = new Set();
            let currentPageTodo = 1, currentPageFeedback = 1;
            const itemsPerPage = 8;
            let db, auth;
            let appDataCollectionRef;

            // --- 日期初始化 ---
            document.getElementById('todo-date').valueAsDate = new Date();
            document.getElementById('event-date').valueAsDate = new Date();

            // --- Modal 輔助函數 ---
            const showNotification = (message) => { notificationMessage.textContent = message; notificationModal.classList.remove('hidden'); };
            const showConfirmation = (message, callback) => { confirmationMessage.textContent = message; confirmCallback = callback; confirmationModal.classList.remove('hidden'); };

            // --- Global Print Handlers ---
            window.addEventListener('afterprint', () => {
                document.body.classList.remove('is-printing-list', 'is-printing-gantt', 'is-printing-detail', 'print-with-progress', 'print-no-assignee', 'print-no-progress-col');
                
                if (detailModal) detailModal.classList.remove('is-printing');
                if (eventDetailModal) eventDetailModal.classList.remove('is-printing');
                
                updateSidebarWidth(); // Reset sidebar width
                // Re-render views
                renderEventItems();
                renderGantt(false); 
            });

            // --- Tab Switching ---
            const switchTab = (activeTab) => {
                const tabs = { todo: tabTodo, tracking: tabTracking, feedback: tabFeedback, gantt: tabGantt };
                const contents = { todo: contentTodo, tracking: contentTracking, feedback: contentFeedback, gantt: contentGantt };
                const activeClasses = 'whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-indigo-500 text-indigo-600';
                const inactiveClasses = 'whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300';
                
                for (const key in tabs) {
                    if (key === activeTab) {
                        tabs[key].className = activeClasses;
                        tabs[key].setAttribute('aria-current', 'page');
                        contents[key].classList.remove('hidden');
                    } else {
                        tabs[key].className = inactiveClasses;
                        tabs[key].removeAttribute('aria-current');
                        contents[key].classList.add('hidden');
                    }
                }
            };
            
            // --- Firebase 設定 ---
            const firebaseConfig = { apiKey: "AIzaSyA7IeOz4EJ-yMUccDTPOSaDm33fLChVD8Q", authDomain: "sunyu-check.firebaseapp.com", projectId: "sunyu-check", storageBucket: "sunyu-check.appspot.com", messagingSenderId: "627211744361", appId: "1:627211744361:web:58bce4b5009f0c9d5bdef8" };
            const appId = "sunyu-check";


            // --- Render and Helper Functions (Defined before they are called) ---
            const getPriorityIcon = (priority) => {
                let colorClass, number;
                switch(priority) {
                    case 'high': 
                        colorClass = 'bg-red-500';
                        number = '1';
                        break;
                    case 'low': 
                        colorClass = 'bg-green-500';
                        number = '3';
                        break;
                    case 'medium': 
                    default:
                        colorClass = 'bg-yellow-500';
                        number = '2';
                        break;
                }
                return `<div class="flex items-center justify-center">
                            <div class="relative w-6 h-6 rounded-full flex items-center justify-center ${colorClass}">
                                <span class="text-xs font-bold text-white">${number}</span>
                            </div>
                        </div>`;
            };

            const setupPagination = (totalItems, currentPage, container, infoEl, buttonsEl, onPageClick) => {
                buttonsEl.innerHTML = '';
                const pageCount = Math.ceil(totalItems / itemsPerPage);
                if (pageCount <= 1) { return container.classList.add('hidden'); }
                container.classList.remove('hidden');
                const startItem = (currentPage - 1) * itemsPerPage + 1;
                const endItem = Math.min(currentPage * itemsPerPage, totalItems);
                infoEl.textContent = `顯示 ${totalItems} 個項目中的 ${startItem}-${endItem} 項`;
                const createBtn = (text, onClick, enabled = true) => {
                    const btn = document.createElement('button');
                    btn.textContent = text;
                    btn.disabled = !enabled;
                    btn.className = `px-3 py-1 text-sm font-medium border rounded-md ${!enabled ? 'opacity-50 cursor-not-allowed' : 'hover:bg-gray-50'} ${text === currentPage ? 'bg-indigo-600 text-white border-indigo-600' : 'text-gray-700 bg-white border-gray-300'}`;
                    btn.addEventListener('click', onClick);
                    return btn;
                };
                buttonsEl.appendChild(createBtn('«', () => onPageClick(currentPage - 1), currentPage > 1));
                for (let i = 1; i <= pageCount; i++) { buttonsEl.appendChild(createBtn(i, () => onPageClick(i), true)); }
                buttonsEl.appendChild(createBtn('»', () => onPageClick(currentPage + 1), currentPage < pageCount));
            };

            const populateAndShowDetailModal = (item) => {
                detailProductionId.textContent = item.productionId || '-'; detailAssemblyId.textContent = item.assemblyId || '-';
                detailPartNumber.textContent = item.partNumber || '-'; detailDate.textContent = item.date || '-';
                detailContentText.textContent = item.content || '-';
                if (item.image) {
                    detailImage.src = item.image; detailImage.alt = `${item.partNumber} 的圖片`;
                    detailImageContainer.classList.remove('hidden');
                } else { detailImageContainer.classList.add('hidden'); detailImage.src = ''; }
                detailModal.classList.remove('hidden');
            };

            const populateAndShowEventDetailModal = (item) => {
                detailEventDate.textContent = item.date || '-';
                detailEventMatter.textContent = item.matter || '-';
                detailEventPersonnel.textContent = item.personnel || '-';
                detailEventStatus.textContent = item.closed ? '已結案' : '處理中';
                eventDetailModal.classList.remove('hidden');
            };

            const renderTodoItems = () => {
                if (!todoSearchInput) return;
                const searchTerm = todoSearchInput.value.toLowerCase();
                let filteredList = [...allTodoItems];
                
                if (currentFilter === 'pending') { 
                    filteredList = allTodoItems.filter(item => !item.completed && !item.handedOver); 
                } else if (currentFilter === 'completed') { 
                    filteredList = allTodoItems.filter(item => item.completed && !item.handedOver);
                } else if (currentFilter === 'handedOver') {
                    filteredList = allTodoItems.filter(item => item.handedOver);
                }

                filteredList = filteredList.filter(item => item.productionId?.toLowerCase().includes(searchTerm) || item.assemblyId?.toLowerCase().includes(searchTerm) || item.partNumber?.toLowerCase().includes(searchTerm));

                const paginatedItems = filteredList.slice((currentPageTodo - 1) * itemsPerPage, currentPageTodo * itemsPerPage);
                todoItemsList.innerHTML = ''; document.getElementById('todo-no-results').classList.toggle('hidden', filteredList.length > 0);
                paginatedItems.forEach(item => {
                    const isEditing = item.id === editingItemId; 
                    const tr = document.createElement('tr'); 
                    tr.dataset.id = item.id; 
                    if (item.completed) tr.classList.add('completed');
                    if (newItemsToHighlight.has(item.id)) { tr.classList.add('new-item-highlight'); setTimeout(() => tr.classList.remove('new-item-highlight'), 1500); newItemsToHighlight.delete(item.id); }
                    
                    if (isEditing) {
                        tr.innerHTML = `
                            <td class="px-4 py-4 whitespace-nowrap">
                                <div class="flex items-center space-x-4">
                                    <div><input type="checkbox" class="h-4 w-4 edit-todo-completed" ${item.completed ? 'checked' : ''}><label class="ml-2 text-sm">已完成</label></div>
                                    <div><input type="checkbox" class="h-4 w-4 edit-todo-handedOver" ${item.handedOver ? 'checked' : ''}><label class="ml-2 text-sm">已移交</label></div>
                                </div>
                            </td>
                            <td class="px-4 py-4"><input class="edit-input edit-productionId" value="${item.productionId}"></td>
                            <td class="px-4 py-4"><input class="edit-input edit-assemblyId" value="${item.assemblyId || ''}"></td>
                            <td class="px-4 py-4"><input class="edit-input edit-partNumber" value="${item.partNumber}"></td>
                            <td class="px-4 py-4"><textarea class="edit-input edit-content">${item.content}</textarea></td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">無法編輯</td>
                            <td class="px-4 py-4"><input type="date" class="edit-input edit-date" value="${item.date}"></td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm font-medium">
                                <button data-id="${item.id}" class="save-item text-green-600 hover:text-green-900">儲存</button>
                                <button data-id="${item.id}" class="cancel-edit text-gray-600 hover:text-gray-900 ml-4">取消</button>
                            </td>`;
                    } else {
                        let statusBadge;
                        if (item.handedOver) {
                            statusBadge = `<span class="bg-green-100 text-green-800 text-xs font-medium me-2 px-2.5 py-0.5 rounded-full">已移交</span>`;
                        } else if (item.completed) {
                            statusBadge = `<span class="bg-gray-200 text-gray-800 text-xs font-medium me-2 px-2.5 py-0.5 rounded-full">已完成</span>`;
                        } else {
                            statusBadge = `<span class="bg-blue-100 text-blue-800 text-xs font-medium me-2 px-2.5 py-0.5 rounded-full">待處理</span>`;
                        }

                        tr.innerHTML = `
                            <td class="px-4 py-4 whitespace-nowrap text-sm">${statusBadge}</td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">${item.productionId}</td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">${item.assemblyId || '-'}</td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">${item.partNumber}</td>
                            <td class="px-4 py-4 max-w-xs text-sm text-gray-500 truncate" title="${item.content}">${item.content}</td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">${item.image ? `<img src="${item.image}" alt="縮圖" class="view-image h-10 w-10 object-cover rounded cursor-pointer">` : '無'}</td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">${item.date}</td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm font-medium flex items-center">
                                <button data-id="${item.id}" class="view-detail p-1 text-gray-500 hover:text-blue-800" title="查看"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pointer-events-none" viewBox="0 0 20 20" fill="currentColor"><path d="M10 12a2 2 0 100-4 2 2 0 000 4z" /><path fill-rule="evenodd" d="M.458 10C3.732 4.943 9.522 3 10 3s6.268 1.943 9.542 7c-3.274 5.057-9.03 7-9.542 7S3.732 15.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd" /></svg></button>
                                <button data-id="${item.id}" class="toggle-complete p-1 text-gray-500 hover:text-green-800" title="標示為完成"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pointer-events-none" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg></button>
                                <button data-id="${item.id}" class="edit-item p-1 text-gray-500 hover:text-indigo-800" title="編輯"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pointer-events-none" viewBox="0 0 20 20" fill="currentColor"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" /></svg></button>
                                <button data-id="${item.id}" class="delete-item p-1 text-gray-500 hover:text-red-800" title="刪除"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pointer-events-none" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg></button>
                            </td>`;
                    }
                    todoItemsList.appendChild(tr);
                });
                setupPagination(filteredList.length, currentPageTodo, paginationContainerTodo, pageInfoTodo, paginationButtonsTodo, (page) => { currentPageTodo = page; renderTodoItems(); });
            };
            
            const setFilter = (filter) => { currentPageTodo = 1; currentFilter = filter; renderTodoItems(); updateFilterButtons(); };
            const updateFilterButtons = () => { 
                filterAllBtn.classList.toggle('active', currentFilter === 'all'); 
                filterPendingBtn.classList.toggle('active', currentFilter === 'pending'); 
                filterCompletedBtn.classList.toggle('active', currentFilter === 'completed');
                filterHandedOverBtn.classList.toggle('active', currentFilter === 'handedOver');
            };
            
            const renderEventItems = () => {
                if (!eventItemsList) return;
                const isPrinting = document.body.classList.contains('is-printing-list');
                const searchTerm = eventSearchInput.value.toLowerCase();
                
                const listToDisplay = allEventItems.filter(item => {
                    const isArchived = item.archived === true;
                    return isPrinting ? !isArchived : (eventViewMode === 'archived' ? isArchived : !isArchived);
                });
                
                let sortedList = [...listToDisplay];
                const priorityOrder = { 'high': 1, 'medium': 2, 'low': 3 };

                const sortFunctions = {
                    'createdAt-asc': (a, b) => (a.createdAt?.toMillis() || 0) - (b.createdAt?.toMillis() || 0),
                    'createdAt-desc': (a, b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0),
                    'date-desc': (a, b) => new Date(b.date) - new Date(a.date),
                    'date-asc': (a, b) => new Date(a.date) - new Date(b.date),
                    'status-pending': (a, b) => a.closed - b.closed,
                    'priority-desc': (a, b) => {
                        const priorityA = priorityOrder[a.priority] || 3;
                        const priorityB = priorityOrder[b.priority] || 3;
                        if (priorityA !== priorityB) {
                            return priorityA - priorityB;
                        }
                        return (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0);
                    }
                };
                sortedList.sort(sortFunctions[currentEventSort] || sortFunctions['createdAt-desc']);

                const filteredList = sortedList.filter(item => item.matter?.toLowerCase().includes(searchTerm) || item.personnel?.toLowerCase().includes(searchTerm));
                
                eventItemsList.innerHTML = ''; 
                document.getElementById('event-no-results').classList.toggle('hidden', filteredList.length > 0);
                
                filteredList.forEach(item => {
                    const tr = document.createElement('tr');
                    if (item.closed) {
                        tr.classList.add('event-item-closed');
                    }
                    const isEditing = item.id === editingEventId && !isPrinting;

                    if (isEditing) {
                        tr.innerHTML = `
                            <td class="px-4 py-4">
                                <select class="edit-input edit-event-priority">
                                    <option value="high" ${item.priority === 'high' ? 'selected' : ''}>1 (最優先)</option>
                                    <option value="medium" ${item.priority === 'medium' ? 'selected' : ''}>2 (次要)</option>
                                    <option value="low" ${item.priority === 'low' ? 'selected' : ''}>3 (較緩)</option>
                                </select>
                            </td>
                            <td class="px-4 py-4"><input type="date" class="edit-input edit-event-date" value="${item.date}"></td>
                            <td class="px-4 py-4"><input type="text" class="edit-input edit-event-matter" value="${item.matter || ''}"></td>
                            <td class="px-4 py-4"><input type="text" class="edit-input edit-event-personnel" value="${item.personnel || ''}"></td>
                            <td class="px-4 py-4"><textarea class="edit-input edit-event-process">${item.processTracking || ''}</textarea></td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm"><span class="ml-2 align-middle ${item.closed ? 'text-gray-500' : 'text-gray-900'}">${item.closed ? '已結案' : '處理中'}</span></td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm font-medium">
                                <button data-id="${item.id}" class="save-event text-green-600 hover:text-green-900 mr-4">儲存</button>
                                <button data-id="${item.id}" class="cancel-edit-event text-gray-600 hover:text-gray-900">取消</button>
                            </td>`;
                    } else {
                        const archiveButton = eventViewMode === 'active' 
                            ? `<button data-id="${item.id}" class="archive-event text-gray-600 hover:text-gray-900 mr-4">封存</button>`
                            : `<button data-id="${item.id}" class="unarchive-event text-green-600 hover:text-green-900 mr-4">取消封存</button>`;

                        tr.innerHTML = `
                            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">${getPriorityIcon(item.priority)}</td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">${item.date}</td>
                            <td class="px-4 py-4 text-sm text-gray-900">${item.matter}</td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">${item.personnel}</td>
                             <td class="px-4 py-4 text-sm text-gray-500 whitespace-pre-wrap">${item.processTracking || '-'}</td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm">
                                <input type="checkbox" data-id="${item.id}" class="toggle-event-closed align-middle h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500" ${item.closed ? 'checked' : ''}>
                                <span class="ml-2 align-middle ${item.closed ? 'text-gray-500 line-through' : 'text-gray-900'}">${item.closed ? '已結案' : '處理中'}</span>
                            </td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm font-medium">
                                ${archiveButton}
                                <button data-id="${item.id}" class="edit-event text-indigo-600 hover:text-indigo-900 mr-4">編輯</button>
                                <button data-id="${item.id}" class="delete-event text-red-600 hover:text-red-900">刪除</button>
                            </td>`;
                    }
                    eventItemsList.appendChild(tr);
                });
            };

            const setEventViewMode = (mode) => {
                eventViewMode = mode;
                eventViewActiveBtn.classList.toggle('active', mode === 'active');
                eventViewArchivedBtn.classList.toggle('active', mode === 'archived');
                renderEventItems();
            };
            
            const renderFeedbackItems = () => {
                const filterType = feedbackFilterType.value;
                const filteredList = allFeedbackItems.filter(item => !filterType || item.feedbackType === filterType);
                const paginatedItems = filteredList.slice((currentPageFeedback - 1) * itemsPerPage, currentPageFeedback * itemsPerPage);
                feedbackItemsList.innerHTML = ''; document.getElementById('feedback-no-results').classList.toggle('hidden', filteredList.length > 0);
                paginatedItems.forEach(item => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">${item.feedbackType}</td><td class="px-4 py-4 text-sm text-gray-900 max-w-xs truncate" title="${item.problem}">${item.problem}</td><td class="px-4 py-4 text-sm text-gray-500 max-w-xs truncate" title="${item.solution}">${item.solution || '-'}</td><td class="px-4 py-4 whitespace-nowrap text-sm ${item.status === '已結案' ? 'text-green-600' : 'text-yellow-600'}">${item.status}</td><td class="px-4 py-4 whitespace-nowrap text-sm font-medium"><button data-id="${item.id}" class="delete-feedback text-red-600 hover:text-red-900">刪除</button></td>`;
                    feedbackItemsList.appendChild(tr);
                });
                setupPagination(filteredList.length, currentPageFeedback, paginationContainerFeedback, pageInfoFeedback, paginationButtonsFeedback, (page) => { currentPageFeedback = page; renderFeedbackItems(); });
            };
            
            // =================================================================
            // --- Unified Data Listener ---
            // =================================================================
            const listenForAllData = () => {
                if (unsubscribeAllData) unsubscribeAllData();
                if (!appDataCollectionRef) return;

                // Use a simpler query without composite ordering
                const q = query(appDataCollectionRef); 

                unsubscribeAllData = onSnapshot(q, (snapshot) => {
                    allTodoItems = [];
                    allEventItems = [];
                    allFeedbackItems = [];
                    allGanttTasks = [];

                    snapshot.docs.forEach(doc => {
                        const data = { id: doc.id, ...doc.data() };
                        switch(data.type) {
                            case 'event':
                                allEventItems.push(data);
                                break;
                            case 'feedback':
                                allFeedbackItems.push(data);
                                break;
                            case 'gantt':
                                allGanttTasks.push(data);
                                break;
                            case 'todo':
                            default:
                                allTodoItems.push(data);
                                break;
                        }
                    });

                    // Sort Gantt tasks client-side
                    allGanttTasks.sort((a, b) => {
                        const orderA = a.order ?? Infinity;
                        const orderB = b.order ?? Infinity;
                        if (orderA !== orderB) {
                            return orderA - orderB;
                        }
                        const timeA = a.createdAt?.toMillis ? a.createdAt.toMillis() : 0;
                        const timeB = b.createdAt?.toMillis ? b.createdAt.toMillis() : 0;
                        return timeA - timeB;
                    });
                    
                    renderTodoItems();
                    renderEventItems();
                    renderFeedbackItems();
                    renderGantt();
                });
            };

            // --- Firebase 初始化 ---
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            
            appDataCollectionRef = collection(db, `/artifacts/${appId}/public/data/sharedTodoItems`);

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    authStatus.textContent = `已連線 | 公開共享模式`;
                    document.querySelector('#addEventForm button[type="submit"]').disabled = false;
                    document.querySelector('#addFeedbackForm button[type="submit"]').disabled = false;
                    todoSubmitButton.disabled = false;
                    
                    listenForAllData();
                } else {
                    authStatus.textContent = '正在驗證身份...';
                    try {
                        await signInAnonymously(auth);
                    } catch (error) {
                        console.error("匿名登入失敗:", error);
                        authStatus.textContent = `錯誤：無法連接。 ${error.message}`;
                    }
                }
            });
            
            // =================================================================
            // --- Event Listeners Setup ---
            // =================================================================
            closeNotificationModal.addEventListener('click', () => notificationModal.classList.add('hidden'));
            confirmCancel.addEventListener('click', () => { confirmationModal.classList.add('hidden'); confirmCallback = null; });
            confirmOk.addEventListener('click', () => { confirmationModal.classList.add('hidden'); if (confirmCallback) confirmCallback(); confirmCallback = null; });
            closeModal.addEventListener('click', () => imageModal.classList.add('hidden'));
            imageModal.addEventListener('click', (e) => { if (e.target === imageModal) imageModal.classList.add('hidden'); });
            closeDetailModal.addEventListener('click', () => detailModal.classList.add('hidden'));
            printDetail.addEventListener('click', () => {
                document.body.classList.add('is-printing-detail');
                detailModal.classList.add('is-printing');
                window.print();
            });
            closeEventDetailModal.addEventListener('click', () => eventDetailModal.classList.add('hidden'));
            printEventDetail.addEventListener('click', () => {
                document.body.classList.add('is-printing-detail');
                eventDetailModal.classList.add('is-printing');
                window.print();
            });

            tabTodo.addEventListener('click', () => switchTab('todo'));
            tabTracking.addEventListener('click', () => switchTab('tracking'));
            tabFeedback.addEventListener('click', () => switchTab('feedback'));
            tabGantt.addEventListener('click', () => switchTab('gantt'));

            // --- 待修改明細 (Todo) Section ---
            addItemForm.addEventListener('submit', (e) => {
                e.preventDefault();
                if (!appDataCollectionRef) return;
                const imageFile = document.getElementById('todo-imageUpload').files[0];
                if (imageFile && imageFile.size > 750 * 1024) { return showNotification("圖片檔案過大，請選擇小於 750KB 的圖片。"); }
                const reader = new FileReader();
                reader.onloadend = async () => {
                    try {
                        const docRef = await addDoc(appDataCollectionRef, {
                            type: 'todo',
                            productionId: document.getElementById('todo-productionId').value, assemblyId: document.getElementById('todo-assemblyId').value,
                            partNumber: document.getElementById('todo-partNumber').value, content: document.getElementById('todo-content').value,
                            date: document.getElementById('todo-date').value, image: reader.result || null,
                            completed: false, 
                            handedOver: false,
                            createdAt: serverTimestamp()
                        });
                        newItemsToHighlight.add(docRef.id);
                        addItemForm.reset();
                        document.getElementById('todo-date').valueAsDate = new Date();
                    } catch (error) { showNotification(`新增待辦失敗: ${error.message}`); }
                };
                if (imageFile) reader.readAsDataURL(imageFile); else reader.onloadend();
            });

            document.getElementById('list-container-todo').addEventListener('click', async (e) => {
                const target = e.target; const tr = target.closest('tr'); if (!tr) return;
                const id = tr.dataset.id; 
                if (!appDataCollectionRef) return;
                const docRef = doc(appDataCollectionRef, id);
                if (target.classList.contains('toggle-complete')) {
                    const item = allTodoItems.find(i => i.id === id); await updateDoc(docRef, { completed: !item.completed });
                } else if (target.classList.contains('delete-item')) {
                    showConfirmation('您確定要刪除這個項目嗎？', () => deleteDoc(docRef));
                } else if (target.classList.contains('view-image')) {
                    const item = allTodoItems.find(i => i.id === id); if (item && item.image) { modalImage.src = item.image; imageModal.classList.remove('hidden'); }
                } else if (target.classList.contains('view-detail')) { 
                    const item = allTodoItems.find(i => i.id === id); if (item) { populateAndShowDetailModal(item); }
                } else if (target.classList.contains('edit-item')) {
                    editingItemId = id; renderTodoItems();
                } else if (target.classList.contains('cancel-edit')) {
                    editingItemId = null; renderTodoItems();
                } else if (target.classList.contains('save-item')) {
                    try {
                        await updateDoc(docRef, {
                            productionId: tr.querySelector('.edit-productionId').value,
                            assemblyId: tr.querySelector('.edit-assemblyId').value,
                            partNumber: tr.querySelector('.edit-partNumber').value,
                            content: tr.querySelector('.edit-content').value,
                            date: tr.querySelector('.edit-date').value,
                            completed: tr.querySelector('.edit-todo-completed').checked,
                            handedOver: tr.querySelector('.edit-todo-handedOver').checked,
                        });
                        editingItemId = null;
                    } catch(error) { showNotification(`儲存失败: ${error.message}`); }
                }
            });
            
            filterAllBtn.addEventListener('click', () => setFilter('all')); 
            filterPendingBtn.addEventListener('click', () => setFilter('pending')); 
            filterCompletedBtn.addEventListener('click', () => setFilter('completed'));
            filterHandedOverBtn.addEventListener('click', () => setFilter('handedOver'));
            todoSearchInput.addEventListener('input', () => { currentPageTodo = 1; renderTodoItems(); });

            // --- 事件追蹤 (Event) Section ---
            addEventForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!appDataCollectionRef) return;
                try {
                    await addDoc(appDataCollectionRef, {
                        type: 'event',
                        date: document.getElementById('event-date').value, 
                        matter: document.getElementById('event-matter').value,
                        personnel: document.getElementById('event-personnel').value, 
                        closed: document.getElementById('event-closed').checked,
                        priority: document.getElementById('event-priority').value,
                        archived: false,
                        processTracking: "",
                        createdAt: serverTimestamp()
                    });
                    addEventForm.reset(); 
                    document.getElementById('event-date').valueAsDate = new Date();
                } catch (error) { showNotification(`新增事件失敗: ${error.message}`); }
            });

            contentTracking.addEventListener('click', async (e) => {
                const target = e.target;
                const id = target.dataset.id;
                const tr = target.closest('tr');
                if (!id || !appDataCollectionRef) return;
                const docRef = doc(appDataCollectionRef, id);

                if (target.classList.contains('delete-event')) {
                    showConfirmation('您確定要永久刪除這個事件嗎？', () => deleteDoc(docRef));
                } else if (target.classList.contains('archive-event')) {
                    await updateDoc(docRef, { archived: true });
                } else if (target.classList.contains('unarchive-event')) {
                    await updateDoc(docRef, { archived: false });
                } else if (target.classList.contains('toggle-event-closed')) {
                    const item = allEventItems.find(i => i.id === id);
                    if (item) await updateDoc(docRef, { closed: !item.closed });
                } else if (target.classList.contains('view-event-detail')) {
                    const item = allEventItems.find(i => i.id === id);
                    if(item) populateAndShowEventDetailModal(item);
                } else if (target.classList.contains('edit-event')) {
                    editingEventId = id;
                    renderEventItems();
                } else if (target.classList.contains('cancel-edit-event')) {
                    editingEventId = null;
                    renderEventItems();
                } else if (target.classList.contains('save-event')) {
                    if (tr) {
                        try {
                            const updatedData = {
                                matter: tr.querySelector('.edit-event-matter').value,
                                personnel: tr.querySelector('.edit-event-personnel').value,
                                priority: tr.querySelector('.edit-event-priority').value,
                                processTracking: tr.querySelector('.edit-event-process').value
                            };
                            await updateDoc(docRef, updatedData);
                            editingEventId = null;
                        } catch (error) {
                            showNotification(`儲存失敗: ${error.message}`);
                            editingEventId = null;
                            renderEventItems();
                        }
                    }
                }
            });

            printEventListBtn.addEventListener('click', () => {
                const today = new Date();
                const yyyy = today.getFullYear();
                const mm = String(today.getMonth() + 1).padStart(2, '0');
                const dd = String(today.getDate()).padStart(2, '0');
                document.getElementById('event-print-date').textContent = `日期：${yyyy}/${mm}/${dd}`;
                
                document.body.classList.add('is-printing-list');
                renderEventItems();
                window.print();
            });
            
            eventViewActiveBtn.addEventListener('click', () => setEventViewMode('active'));
            eventViewArchivedBtn.addEventListener('click', () => setEventViewMode('archived'));
            eventSortSelect.addEventListener('change', (e) => {
                currentEventSort = e.target.value;
                renderEventItems();
            });
            eventSearchInput.addEventListener('input', renderEventItems);

            // --- 問題反饋 (Feedback) Section ---
             addFeedbackForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!appDataCollectionRef) return;
                const solution = document.getElementById('feedback-solution').value;
                const status = document.getElementById('feedback-status').value;
                if (status === '已結案' && !solution.trim()) { return showNotification('必須填寫解決方式才能結案。'); }
                try {
                    await addDoc(appDataCollectionRef, {
                        type: 'feedback',
                        feedbackType: document.getElementById('feedback-type').value,
                        problem: document.getElementById('feedback-problem').value,
                        solution: solution, status: status, createdAt: serverTimestamp()
                    });
                    addFeedbackForm.reset();
                } catch (error) { showNotification(`新增反饋失敗: ${error.message}`); }
            });

            contentFeedback.addEventListener('click', async (e) => {
                if (e.target.classList.contains('delete-feedback')) {
                    if (!appDataCollectionRef) return;
                    const id = e.target.dataset.id;
                    showConfirmation('您確定要刪除這條反饋嗎？', () => deleteDoc(doc(appDataCollectionRef, id)));
                }
            });

            feedbackFilterType.addEventListener('change', () => { currentPageFeedback = 1; renderFeedbackItems(); });

            // =================================================================
            // --- Gantt Chart Logic ---
            // =================================================================
            // DOM Elements
            const taskGridHeader = document.getElementById('task-grid-header');
            const taskListBody = document.getElementById('task-list-body');
            const timelineHeader = document.getElementById('timeline-header');
            const timelineBody = document.getElementById('timeline-body');
            const ganttTaskGrid = document.getElementById('gantt-task-grid');
            const ganttTimeline = document.getElementById('gantt-timeline');
            const ganttContainer = document.getElementById('gantt-container');
            const ganttPrintBtn = document.getElementById('ganttPrintBtn');
            const ganttCurrentDateEl = document.getElementById('gantt-current-date');
            const printProgressToggle = document.getElementById('printProgressToggle');
            const printAssigneeToggle = document.getElementById('printAssigneeToggle');
            const printProgressColumnToggle = document.getElementById('printProgressColumnToggle');
            const hideCompletedTasksToggle = document.getElementById('hideCompletedTasksToggle');
            
            // Modal Elements
            const ganttAddTaskBtn = document.getElementById('ganttAddTaskBtn');
            const ganttTaskModal = document.getElementById('ganttTaskModal');
            const ganttModalContent = document.getElementById('gantt-modal-content');
            const ganttModalTitle = document.getElementById('ganttModalTitle');
            const ganttCancelBtn = document.getElementById('ganttCancelBtn');
            const ganttDeleteBtn = document.getElementById('ganttDeleteBtn');
            const ganttTaskForm = document.getElementById('ganttTaskForm');
            const ganttTaskIdInput = document.getElementById('ganttTaskId');
            const ganttTaskNameInput = document.getElementById('ganttTaskName');
            const ganttTaskAssigneeInput = document.getElementById('ganttTaskAssignee');
            const ganttTaskStartInput = document.getElementById('ganttTaskStart');
            const ganttTaskDurationInput = document.getElementById('ganttTaskDuration');
            const ganttTaskProgressInput = document.getElementById('ganttTaskProgress');
            const ganttProgressValue = document.getElementById('ganttProgressValue');
            const ganttTaskParentSelect = document.getElementById('ganttTaskParent');

            // Set current date in header
            const ganttToday = new Date();
            const year = ganttToday.getFullYear();
            const month = String(ganttToday.getMonth() + 1).padStart(2, '0');
            const day = String(ganttToday.getDate()).padStart(2, '0');
            ganttCurrentDateEl.textContent = `${year}-${month}-${day}`;

            // Gantt settings
            const ganttDayWidthScreen = 40;
            const ganttDayWidthPrint = 12; 
            let dayWidth = ganttDayWidthScreen; 
            let columns = [
                { label: 'WBS', width: 60 },
                { label: '任務名稱', width: 180 },
                { label: '工期', width: 90 },
                { label: '開始日期', width: 100 },
                { label: '結束日期', width: 100 },
                { label: '人員', width: 80 },
                { label: '進度', width: 50 }
            ];
            // Load column config from localStorage
            const savedColumns = localStorage.getItem('ganttColumnConfig');
            if (savedColumns) {
                try {
                    const parsedColumns = JSON.parse(savedColumns);
                    if (Array.isArray(parsedColumns) && parsedColumns.length === columns.length) {
                         columns = parsedColumns;
                    }
                } catch (e) {
                    console.error("Failed to parse saved column config", e);
                }
            }


            const parentColors = [
                { bar: '#a5b4fc', progress: '#4f46e5' }, // Indigo
                { bar: '#6ee7b7', progress: '#059669' }, // Emerald
                { bar: '#fcd34d', progress: '#d97706' }, // Amber
                { bar: '#f9a8d4', progress: '#be185d' }, // Pink
                { bar: '#67e8f9', progress: '#0891b2' }, // Cyan
            ];
            
            // --- Date Utility Functions (with weekend skipping) ---
            const parseDate = (dateStr) => {
                if (!dateStr) return null;
                const [year, month, day] = dateStr.split('-').map(Number);
                return new Date(year, month - 1, day);
            };

            const formatDate = (date) => date.toISOString().split('T')[0];
            
            const getEndDate = (task) => {
                const startStr = task.start;
                const duration = task.duration;

                if (!startStr) return null;
                if (duration <= 0) return startStr;
                
                let date = parseDate(startStr);
                let workingDaysCounted = 0;
                
                while (workingDaysCounted < duration) {
                    const dayOfWeek = date.getDay();
                    if (dayOfWeek !== 0 && dayOfWeek !== 6) { // It's a working day
                        workingDaysCounted++;
                    }
                    if (workingDaysCounted < duration) {
                        date.setDate(date.getDate() + 1);
                    }
                }
                return formatDate(date);
            };

            const calculateWorkingDays = (startStr, endStr) => {
                if (!startStr || !endStr) return 0;
                let count = 0;
                const start = parseDate(startStr);
                const end = parseDate(endStr);
                let current = new Date(start);

                if (start > end) return 0;

                while (current <= end) {
                    const dayOfWeek = current.getDay();
                    if (dayOfWeek !== 0 && dayOfWeek !== 6) {
                        count++;
                    }
                    current.setDate(current.getDate() + 1);
                }
                return count;
            };

            const dateDiffInDays = (dateStr1, dateStr2) => {
                if (!dateStr1 || !dateStr2) return 0;
                const dt1 = parseDate(dateStr1);
                const dt2 = parseDate(dateStr2);
                return Math.floor((dt2 - dt1) / (1000 * 60 * 60 * 24));
            };

            function processTasks(tasksToProcess) {
                const taskMap = new Map(tasksToProcess.map(t => [t.id, { ...t, children: [] }]));
                
                tasksToProcess.forEach(task => {
                    if (task.parentId && taskMap.has(task.parentId)) {
                        taskMap.get(task.parentId).children.push(taskMap.get(task.id));
                    }
                });

                const processedTasks = Array.from(taskMap.values());

                function updateParent(task) {
                    if (task.children.length === 0) return;

                    task.children.forEach(updateParent); // Post-order traversal

                    let minStart = null;
                    let maxEnd = null;
                    let totalProgress = 0;
                    let totalDuration = 0;

                    task.children.forEach(child => {
                        const childEnd = getEndDate(child);
                        if (!minStart || child.start < minStart) {
                            minStart = child.start;
                        }
                        if (!maxEnd || childEnd > maxEnd) {
                            maxEnd = childEnd;
                        }
                        totalProgress += child.progress * child.duration;
                        totalDuration += child.duration;
                    });

                    task.start = minStart;
                    task.duration = calculateWorkingDays(minStart, maxEnd);
                    task.progress = totalDuration > 0 ? Math.round(totalProgress / totalDuration) : 0;
                }

                processedTasks.filter(t => t.parentId === null).forEach(updateParent);
                return processedTasks;
            }

            function createHeader() {
                taskGridHeader.innerHTML = '';
                columns.forEach((col, index) => {
                    const cell = document.createElement('div');
                    cell.className = 'task-header-cell';
                    if (index === 5) cell.classList.add('gantt-assignee-col');
                    if (index === 6) cell.classList.add('gantt-progress-col');
                    cell.textContent = col.label;
                    cell.style.width = `${col.width}px`;

                    if (index < columns.length - 1) {
                        const resizer = document.createElement('div');
                        resizer.className = 'col-resizer';
                        resizer.dataset.colIndex = index;
                        cell.appendChild(resizer);
                    }
                    taskGridHeader.appendChild(cell);
                });
                updateSidebarWidth();
            }

            function updateSidebarWidth() {
                const totalWidth = columns.reduce((sum, col) => sum + col.width, 0);
                ganttContainer.style.setProperty('--sidebar-width', `${totalWidth}px`);
            }
            
            function renderGantt(isForPrint = false) {
                dayWidth = isForPrint ? ganttDayWidthPrint : ganttDayWidthScreen;
                const processedTasksWithHierarchy = processTasks(allGanttTasks);
                
                let tasksToRender = [...processedTasksWithHierarchy];

                // If hide-completed is checked, filter out tasks that are 100% complete and all their descendants
                if (hideCompletedTasksToggle && hideCompletedTasksToggle.checked && !isForPrint) {
                    const taskMap = new Map(processedTasksWithHierarchy.map(t => [t.id, t]));
                    const hiddenIds = new Set();
                    
                    // Find all tasks that are 100% complete
                    processedTasksWithHierarchy.forEach(task => {
                        if (task.progress === 100) {
                            hiddenIds.add(task.id);
                        }
                    });

                    // For each hidden task, also hide all its descendants
                    hiddenIds.forEach(id => {
                        const queue = [...(taskMap.get(id)?.children || [])];
                        while (queue.length > 0) {
                            const current = queue.shift();
                            hiddenIds.add(current.id);
                            if (current.children && current.children.length > 0) {
                                queue.push(...current.children);
                            }
                        }
                    });

                    tasksToRender = processedTasksWithHierarchy.filter(t => !hiddenIds.has(t.id));

                    // Rebuild the hierarchy for the *visible* tasks to ensure children arrays are correct
                    const visibleTaskMap = new Map(tasksToRender.map(t => [t.id, t]));
                    tasksToRender.forEach(t => { t.children = []; }); // Reset children
                    tasksToRender.forEach(t => {
                        if (t.parentId && visibleTaskMap.has(t.parentId)) {
                            visibleTaskMap.get(t.parentId).children.push(t);
                        }
                    });
                }

                const displayTasks = [];

                if (tasksToRender.length === 0) {
                    taskListBody.innerHTML = '<div class="p-4 text-center text-gray-500">尚無任務，或所有任務皆已完成並隱藏。</div>';
                    timelineHeader.innerHTML = '';
                    timelineBody.innerHTML = '';
                    return;
                }

                let projectStart = tasksToRender[0]?.start || formatDate(new Date());
                let projectEnd = getEndDate(tasksToRender[0]) || formatDate(new Date());

                tasksToRender.forEach(t => {
                    if (!t.start) return;
                    const endDate = getEndDate(t);
                    if (t.start < projectStart) projectStart = t.start;
                    if (endDate > projectEnd) projectEnd = endDate;
                });
                
                const totalDays = dateDiffInDays(projectStart, projectEnd) + 1;
                
                renderTimelineHeader(projectStart, totalDays);

                taskListBody.innerHTML = '';
                timelineBody.innerHTML = '';
                
                const rootTasks = tasksToRender.filter(t => t.parentId === null);
                
                let colorIndex = 0;
                let wbsCounter = 1;

                const processHierarchyForDisplay = (tasksToProcess, level, color, wbsPrefix = '') => {
                    tasksToProcess.forEach((task, index) => {
                        const currentWbs = wbsPrefix ? `${wbsPrefix}.${index + 1}` : `${wbsCounter}`;
                        task.color = color;
                        displayTasks.push({ task, level, wbs: currentWbs });
                        if (task.children.length > 0) {
                            processHierarchyForDisplay(task.children.sort((a,b) => a.order - b.order), level + 1, color, currentWbs);
                        }
                    });
                    if (!wbsPrefix) {
                        wbsCounter++;
                    }
                };

                rootTasks.sort((a,b) => a.order - b.order).forEach(task => {
                    const color = parentColors[colorIndex % parentColors.length];
                    processHierarchyForDisplay([task], 0, color);
                    colorIndex++;
                });

                timelineBody.style.height = `${displayTasks.length * 40}px`;
                displayTasks.forEach((item, index) => {
                    renderTaskRow(item.task, index, item.level, projectStart, item.wbs);
                });
            }

            function renderTimelineHeader(projectStart, totalDays) {
                timelineHeader.innerHTML = '';
                const months = {};
                const timelineWidth = totalDays * dayWidth;
                timelineHeader.style.width = `${timelineWidth}px`;
                
                for (let i = 0; i < totalDays; i++) {
                    const currentDate = parseDate(projectStart);
                    currentDate.setDate(currentDate.getDate() + i);
                    const month = currentDate.toLocaleString('zh-TW', { month: 'short', year: 'numeric' });
                    if (!months[month]) {
                        months[month] = { count: 0 };
                    }
                    months[month].count++;
                }

                const monthHeader = document.createElement('div');
                monthHeader.className = 'flex h-1/2';
                Object.keys(months).forEach(month => {
                    const monthEl = document.createElement('div');
                    monthEl.className = 'flex items-center justify-center border-r font-medium text-gray-600 text-sm';
                    monthEl.style.width = `${months[month].count * dayWidth}px`;
                    monthEl.textContent = month;
                    monthHeader.appendChild(monthEl);
                });

                const dayHeader = document.createElement('div');
                dayHeader.className = 'flex h-1/2';
                for (let i = 0; i < totalDays; i++) {
                    const currentDate = parseDate(projectStart);
                    currentDate.setDate(currentDate.getDate() + i);
                    const dayEl = document.createElement('div');
                    dayEl.className = 'flex items-center justify-center border-r text-xs text-gray-500';
                    dayEl.style.width = `${dayWidth}px`;
                    dayEl.textContent = currentDate.getDate();
                    if (currentDate.getDay() === 0 || currentDate.getDay() === 6) {
                        dayEl.classList.add('bg-gray-100');
                    }
                    dayHeader.appendChild(dayEl);
                }

                timelineHeader.appendChild(monthHeader);
                timelineHeader.appendChild(dayHeader);
            }

            function renderTaskRow(task, index, level, projectStart, wbs) {
                const isParent = task.children.length > 0;
                const endDate = getEndDate(task);
                
                const taskRow = document.createElement('div');
                taskRow.className = 'gantt-task-row';
                taskRow.dataset.taskId = task.id;
                taskRow.draggable = true;
                if (isParent) {
                    taskRow.classList.add('font-bold', 'bg-blue-100', 'text-lg');
                }

                const rowData = [
                    wbs,
                    `${' '.repeat(level * 4)}${isParent ? '▼ ' : ''}${task.name}`,
                    `${task.duration} 工作日`,
                    task.start,
                    endDate,
                    task.assignee || '',
                    `${task.progress}%`
                ];
                
                rowData.forEach((data, i) => {
                    const cell = document.createElement('div');
                    cell.className = 'task-cell';
                    if (i === 5) cell.classList.add('gantt-assignee-col');
                    if (i === 6) cell.classList.add('gantt-progress-col');
                    cell.textContent = data;
                    cell.style.width = `${columns[i].width}px`;
                     if (i === 1) { // Task name column
                        cell.style.paddingLeft = `${level * 20 + 10}px`;
                        cell.classList.add('truncate');
                    }
                    taskRow.appendChild(cell);
                });

                taskRow.addEventListener('click', () => openGanttModal(task.id));
                taskListBody.appendChild(taskRow);

                const daysFromStart = dateDiffInDays(projectStart, task.start);
                
                const taskBar = document.createElement('div');
                taskBar.className = 'task-bar';

                taskBar.style.left = `${daysFromStart * dayWidth}px`;
                taskBar.style.width = `${calculateWorkingDays(task.start, endDate) * dayWidth}px`;
                
                if (isParent) {
                    taskBar.classList.add('parent-bar');
                    taskBar.style.backgroundColor = task.color.progress;
                    taskBar.style.top = `${index * 40 + 16}px`;

                    const startCap = document.createElement('div');
                    startCap.className = 'parent-cap';
                    startCap.style.left = '0px';

                    const endCap = document.createElement('div');
                    endCap.className = 'parent-cap';
                    endCap.style.right = '0px';
                    
                    taskBar.appendChild(startCap);
                    taskBar.appendChild(endCap);
                } else {
                    const barColor = task.color.bar;
                    const progressColor = task.color.progress;
                    taskBar.style.backgroundColor = barColor;

                    const progressFill = document.createElement('div');
                    progressFill.className = 'task-progress-fill';
                    progressFill.style.width = `${task.progress}%`;
                    progressFill.style.backgroundColor = progressColor;

                    const taskLabel = document.createElement('span');
                    taskLabel.className = 'task-bar-label';
                    taskLabel.textContent = task.assignee || '';

                    taskBar.appendChild(progressFill);
                    if (task.assignee) taskBar.appendChild(taskLabel);

                    taskBar.style.top = `${index * 40 + 16}px`;
                }
                
                timelineBody.appendChild(taskBar);
            }
            
            // Modal Logic
            function openGanttModal(taskId = null) {
                ganttTaskForm.reset();
                ganttDeleteBtn.classList.add('hidden');
                populateParentTaskOptions(taskId);

                ganttTaskStartInput.disabled = false;
                ganttTaskDurationInput.disabled = false;
                ganttTaskProgressInput.disabled = false;

                if (taskId) {
                    const task = allGanttTasks.find(t => t.id === taskId);
                    const children = allGanttTasks.filter(t => t.parentId === taskId);
                    ganttModalTitle.textContent = '編輯任務';
                    ganttTaskIdInput.value = task.id;
                    ganttTaskNameInput.value = task.name;
                    ganttTaskAssigneeInput.value = task.assignee || '';
                    ganttTaskStartInput.value = task.start;
                    ganttTaskDurationInput.value = task.duration;
                    ganttTaskProgressInput.value = task.progress;
                    ganttProgressValue.textContent = `${task.progress}%`;
                    ganttTaskParentSelect.value = task.parentId || "";
                    ganttDeleteBtn.classList.remove('hidden');

                    if(children.length > 0) {
                        ganttTaskStartInput.disabled = true;
                        ganttTaskDurationInput.disabled = true;
                        ganttTaskProgressInput.disabled = true;
                    }

                } else {
                    ganttModalTitle.textContent = '新增任務';
                    ganttTaskIdInput.value = '';
                    ganttProgressValue.textContent = `0%`;
                }
                
                ganttTaskModal.classList.remove('hidden');
                ganttTaskModal.classList.add('flex');
                setTimeout(() => {
                    ganttModalContent.classList.remove('scale-95', 'opacity-0');
                }, 10);
            }
            
            function populateParentTaskOptions(currentTaskId) {
                ganttTaskParentSelect.innerHTML = '<option value="">無</option>';
                allGanttTasks.forEach(task => {
                    if (task.id === currentTaskId) return;
                    // Prevent circular dependencies - a task cannot be a child of its own descendant
                    let isDescendant = false;
                    let parent = allGanttTasks.find(t => t.id === task.id);
                    while(parent) {
                        if (parent.parentId === currentTaskId) {
                            isDescendant = true;
                            break;
                        }
                        parent = allGanttTasks.find(t => t.id === parent.parentId);
                    }
                    if(isDescendant) return;

                    const option = document.createElement('option');
                    option.value = task.id;
                    option.textContent = task.name;
                    ganttTaskParentSelect.appendChild(option);
                });
            }


            function closeGanttModal() {
                ganttModalContent.classList.add('scale-95', 'opacity-0');
                setTimeout(() => {
                    ganttTaskModal.classList.add('hidden');
                    ganttTaskModal.classList.remove('flex');
                }, 200);
            }

            async function saveGanttTask() {
                const id = ganttTaskIdInput.value;
                const parentId = ganttTaskParentSelect.value ? ganttTaskParentSelect.value : null;

                const taskData = {
                    type: 'gantt',
                    name: ganttTaskNameInput.value,
                    assignee: ganttTaskAssigneeInput.value,
                    start: ganttTaskStartInput.value,
                    duration: parseInt(ganttTaskDurationInput.value),
                    progress: parseInt(ganttTaskProgressInput.value),
                    parentId: parentId
                };
                
                try {
                    if (id) {
                        const docRef = doc(appDataCollectionRef, id);
                        await updateDoc(docRef, taskData);
                    } else {
                         const siblings = allGanttTasks.filter(t => t.parentId === parentId);
                         const maxOrder = siblings.length > 0 ? Math.max(...siblings.map(t => t.order || 0)) : -1;
                        await addDoc(appDataCollectionRef, { ...taskData, order: maxOrder + 1, createdAt: serverTimestamp() });
                    }
                    closeGanttModal();
                } catch(error) {
                    showNotification(`儲存任務失敗: ${error.message}`);
                }
            }

            async function deleteGanttTask() {
                const id = ganttTaskIdInput.value;
                if (!id) return;
                
                const tasksToDelete = new Set([id]);
                let changed = true;
                while(changed) {
                    changed = false;
                    const currentSize = tasksToDelete.size;
                    allGanttTasks.forEach(t => {
                        if (t.parentId && tasksToDelete.has(t.parentId)) {
                            tasksToDelete.add(t.id);
                        }
                    });
                    if (tasksToDelete.size > currentSize) changed = true;
                }
                
                try {
                    const batch = writeBatch(db);
                    tasksToDelete.forEach(taskId => {
                        const docRef = doc(appDataCollectionRef, taskId);
                        batch.delete(docRef);
                    });
                    await batch.commit();
                    closeGanttModal();
                } catch(error) {
                    showNotification(`刪除任務失敗: ${error.message}`);
                }
            }
            
            function prepareAndPrintGantt() {
                const ganttPrintDate = document.getElementById('gantt-print-date');
                const today = new Date();
                ganttPrintDate.textContent = `列印日期：${today.getFullYear()}/${String(today.getMonth() + 1).padStart(2, '0')}/${String(today.getDate()).padStart(2, '0')}`;
                
                const printAssignee = printAssigneeToggle.checked;
                const printProgressCol = printProgressColumnToggle.checked;

                if (printProgressToggle.checked) {
                    document.body.classList.add('print-with-progress');
                }
                if (!printAssignee) {
                    document.body.classList.add('print-no-assignee');
                }
                if (!printProgressCol) {
                    document.body.classList.add('print-no-progress-col');
                }

                let printSidebarWidth = 0;
                columns.forEach((col, index) => {
                    if ((index === 5 && !printAssignee) || (index === 6 && !printProgressCol)) {
                        // Do not add width of hidden columns
                    } else {
                        printSidebarWidth += col.width;
                    }
                });
                ganttContainer.style.setProperty('--sidebar-width', `${printSidebarWidth}px`);
                
                document.body.classList.add('is-printing-gantt');

                renderGantt(true);

                setTimeout(() => {
                    window.print();
                }, 100);
            }

            // --- Event Listeners ---
            ganttAddTaskBtn.addEventListener('click', () => openGanttModal());
            hideCompletedTasksToggle.addEventListener('change', () => renderGantt());
            
            ganttPrintBtn.addEventListener('click', prepareAndPrintGantt);

            ganttCancelBtn.addEventListener('click', closeGanttModal);
            ganttTaskModal.addEventListener('click', (e) => {
                if (e.target === ganttTaskModal) closeGanttModal();
            });
            ganttTaskForm.addEventListener('submit', (e) => {
                e.preventDefault();
                saveGanttTask();
            });
            ganttDeleteBtn.addEventListener('click', deleteGanttTask);

            ganttTaskProgressInput.addEventListener('input', (e) => {
                ganttProgressValue.textContent = `${e.target.value}%`;
            });

            // Sync Scrolling
            ganttTimeline.addEventListener('scroll', () => {
                ganttTaskGrid.scrollTop = ganttTimeline.scrollTop;
            });
            ganttTaskGrid.addEventListener('scroll', () => {
                 ganttTimeline.scrollTop = ganttTaskGrid.scrollTop;
            });
            ganttTaskGrid.addEventListener('wheel', (e) => {
                ganttTimeline.scrollTop += e.deltaY;
                e.preventDefault();
            });

            // --- Column Resizing Logic ---
            let resizingColIndex = -1;
            let startX = 0;
            let startWidth = 0;

            taskGridHeader.addEventListener('mousedown', (e) => {
                if (e.target.classList.contains('col-resizer')) {
                    resizingColIndex = parseInt(e.target.dataset.colIndex, 10);
                    startX = e.clientX;
                    startWidth = columns[resizingColIndex].width;
                    document.addEventListener('mousemove', handleMouseMove);
                    document.addEventListener('mouseup', handleMouseUp);
                }
            });

            function handleMouseMove(e) {
                if (resizingColIndex > -1) {
                    const diffX = e.clientX - startX;
                    const newWidth = startWidth + diffX;
                    if (newWidth > 40) { // Minimum width
                        columns[resizingColIndex].width = newWidth;
                        updateSidebarWidth();
                        createHeader();
                        renderGantt(); 
                    }
                }
            }
            
            function handleMouseUp() {
                 if (resizingColIndex > -1) {
                      localStorage.setItem('ganttColumnConfig', JSON.stringify(columns));
                 }
                resizingColIndex = -1;
                document.removeEventListener('mousemove', handleMouseMove);
                document.removeEventListener('mouseup', handleMouseUp);
            }
            
            // --- Drag and Drop Logic ---
            let draggedId = null;
            let dropIndicator = null;

            taskListBody.addEventListener('dragstart', (e) => {
                const row = e.target.closest('.gantt-task-row');
                if (row) {
                    draggedId = row.dataset.taskId;
                    e.dataTransfer.setData('text/plain', draggedId);
                    e.dataTransfer.effectAllowed = 'move';
                    setTimeout(() => row.classList.add('dragging'), 0);
                }
            });

            taskListBody.addEventListener('dragend', (e) => {
                const row = e.target.closest('.gantt-task-row');
                if (row) {
                    row.classList.remove('dragging');
                }
                if (dropIndicator) {
                    dropIndicator.remove();
                    dropIndicator = null;
                }
                draggedId = null;
            });

            taskListBody.addEventListener('dragover', (e) => {
                e.preventDefault();
                const targetRow = e.target.closest('.gantt-task-row');
                if (!targetRow || targetRow.dataset.taskId === draggedId) return;
                
                if (!dropIndicator) {
                    dropIndicator = document.createElement('div');
                    dropIndicator.className = 'drop-indicator';
                    taskListBody.appendChild(dropIndicator);
                }
                
                const rect = targetRow.getBoundingClientRect();
                const offsetY = e.clientY - rect.top;
                const isAfter = offsetY > rect.height / 2;
                
                dropIndicator.style.top = isAfter ? `${targetRow.offsetTop + rect.height}px` : `${targetRow.offsetTop}px`;
            });

            taskListBody.addEventListener('dragleave', (e) => {
                 if (e.relatedTarget && e.relatedTarget.closest('#task-list-body') === taskListBody) {
                     return;
                 }
                if (dropIndicator) {
                    dropIndicator.remove();
                    dropIndicator = null;
                }
            });

            taskListBody.addEventListener('drop', async (e) => {
                e.preventDefault();
                if (dropIndicator) {
                    dropIndicator.remove();
                    dropIndicator = null;
                }
                const targetRow = e.target.closest('.gantt-task-row');
                if (!targetRow || !draggedId || targetRow.dataset.taskId === draggedId) return;

                const draggedTask = allGanttTasks.find(t => t.id === draggedId);
                const targetTask = allGanttTasks.find(t => t.id === targetRow.dataset.taskId);

                if (!draggedTask || !targetTask || draggedTask.parentId !== targetTask.parentId) {
                    showNotification('任務只能在相同的父任務下進行排序。');
                    return;
                }
                
                const siblings = allGanttTasks
                    .filter(t => t.parentId === draggedTask.parentId)
                    .sort((a, b) => (a.order || 0) - (b.order || 0));

                const draggedIndex = siblings.findIndex(t => t.id === draggedId);
                siblings.splice(draggedIndex, 1);

                const targetIndex = siblings.findIndex(t => t.id === targetTask.id);
                const rect = targetRow.getBoundingClientRect();
                const isAfter = (e.clientY - rect.top) > (rect.height / 2);

                siblings.splice(isAfter ? targetIndex + 1 : targetIndex, 0, draggedTask);

                try {
                    const batch = writeBatch(db);
                    siblings.forEach((task, index) => {
                        const docRef = doc(appDataCollectionRef, task.id);
                        batch.update(docRef, { order: index });
                    });
                    await batch.commit();
                } catch(error) {
                    showNotification(`任務排序失敗: ${error.message}`);
                }
                
                draggedId = null;
            });
            
            // Initial Setup
            createHeader();
            renderGantt();
        });
    </script>
</body>
</html>


