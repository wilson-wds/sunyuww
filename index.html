<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>多功能待辦與生管系統</title>
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 Google Fonts 的 Inter 字體 -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* 自訂樣式 */
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
        }
        .completed > td:not(:first-child):not(:last-child) {
            text-decoration: line-through;
            color: #9ca3af;
        }
        .table-container {
            overflow-x: auto;
        }
        .edit-input {
            width: 100%;
            padding: 0.25rem 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            background-color: #f9fafb;
        }
        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-weight: 500;
            font-size: 0.75rem;
            white-space: nowrap;
        }
        .toggle-expand {
            cursor: pointer;
            transition: transform 0.2s;
        }
        .toggle-expand.expanded {
            transform: rotate(90deg);
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <main class="container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-900">多功能管理系統</h1>
            <p class="text-gray-600 mt-2">整合待修改事項與生管發包流程</p>
            <div id="auth-status" class="mt-4 text-sm text-gray-500">正在連接到 Firebase...</div>
        </header>
        
        <!-- 主要功能分頁 -->
        <div class="mb-8 border-b border-gray-200">
            <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                <button id="main-tab-todo" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-indigo-500 text-indigo-600">
                    待修改事項
                </button>
                <button id="main-tab-prod" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
                    生管發包流程
                </button>
            </nav>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
            <!-- 左側：動態表單 -->
            <div id="form-container" class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg">
                <!-- 待辦事項表單 (預設顯示) -->
                <div id="todo-form-view">
                    <h2 class="text-2xl font-bold mb-6 border-b pb-3">建立新待辦</h2>
                    <form id="addItemForm" class="space-y-4">
                        <input type="text" id="todo-productionId" placeholder="生產編號" class="w-full px-3 py-2 border rounded-md focus:ring-indigo-500 focus:border-indigo-500" required>
                        <input type="text" id="todo-assemblyId" placeholder="組裝編號" class="w-full px-3 py-2 border rounded-md focus:ring-indigo-500 focus:border-indigo-500" required>
                        <input type="text" id="todo-partNumber" placeholder="料號" class="w-full px-3 py-2 border rounded-md focus:ring-indigo-500 focus:border-indigo-500" required>
                        <textarea id="todo-content" placeholder="修改內容" rows="4" class="w-full px-3 py-2 border rounded-md focus:ring-indigo-500 focus:border-indigo-500" required></textarea>
                        <div><label class="text-sm">圖片 (小於 750KB)</label><input type="file" id="todo-imageUpload" class="w-full text-sm"></div>
                        <div><label class="text-sm">日期</label><input type="date" id="todo-date" class="w-full px-3 py-2 border rounded-md" required></div>
                        <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 disabled:bg-gray-400" disabled>新增項目</button>
                    </form>
                </div>
                <!-- 生管流程表單 (預設隱藏) -->
                <div id="prod-form-view" class="hidden">
                    <h2 class="text-2xl font-bold mb-6 border-b pb-3">建立新生管項目</h2>
                    <form id="addProdForm" class="space-y-4">
                        <input type="text" id="prod-parentPartNumber" placeholder="主料號 (可選，用於子項目)" class="w-full px-3 py-2 border rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                        <input type="text" id="prod-partNumber" placeholder="料號 / 子料號" class="w-full px-3 py-2 border rounded-md focus:ring-indigo-500 focus:border-indigo-500" required>
                        <input type="text" id="prod-productionId" placeholder="生產編號" class="w-full px-3 py-2 border rounded-md focus:ring-indigo-500 focus:border-indigo-500" required>
                        <input type="text" id="prod-assemblyId" placeholder="組裝編號" class="w-full px-3 py-2 border rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                        <input type="number" id="prod-quantity" placeholder="數量" class="w-full px-3 py-2 border rounded-md focus:ring-indigo-500 focus:border-indigo-500" required>
                        <input type="text" id="prod-process" placeholder="製程" class="w-full px-3 py-2 border rounded-md focus:ring-indigo-500 focus:border-indigo-500" required>
                        <div><label class="text-sm">交接日</label><input type="date" id="prod-handoverDate" class="w-full px-3 py-2 border rounded-md" required></div>
                        <div><label class="text-sm">完成日</label><input type="date" id="prod-completionDate" class="w-full px-3 py-2 border rounded-md" required></div>
                        <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 disabled:bg-gray-400" disabled>新增流程</button>
                    </form>
                </div>
            </div>

            <!-- 右側：動態列表 -->
            <div id="list-container" class="lg:col-span-3 bg-white p-6 rounded-xl shadow-lg">
                <!-- 待辦事項列表 (預設顯示) -->
                <div id="todo-list-view">
                    <h2 class="text-2xl font-bold mb-6 border-b pb-3">待修改明細</h2>
                    <input type="text" id="todo-searchInput" placeholder="查詢..." class="w-full mb-4 px-3 py-2 border rounded-md">
                    <div class="table-container">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50"><tr><th>狀態</th><th>生產編號</th><th>組裝編號</th><th>料號</th><th>修改內容</th><th>圖片</th><th>日期</th><th>操作</th></tr></thead>
                            <tbody id="todo-itemsList"></tbody>
                        </table>
                    </div>
                    <p id="todo-no-results" class="text-center py-8 hidden">找不到項目。</p>
                </div>
                <!-- 生管流程列表 (預設隱藏) -->
                <div id="prod-list-view" class="hidden">
                    <h2 class="text-2xl font-bold mb-6 border-b pb-3">生管發包明細</h2>
                    <input type="text" id="prod-searchInput" placeholder="查詢..." class="w-full mb-4 px-3 py-2 border rounded-md">
                    <div class="table-container">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50"><tr><th class="w-12"></th><th>進度狀態</th><th>料號</th><th>生產編號</th><th>組裝編號</th><th>數量</th><th>製程</th><th>交接日</th><th>完成日</th><th>操作</th></tr></thead>
                            <tbody id="prod-itemsList"></tbody>
                        </table>
                    </div>
                    <p id="prod-no-results" class="text-center py-8 hidden">找不到項目。</p>
                </div>
            </div>
        </div>
    </main>

    <!-- Modals -->
    <div id="imageModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden"><div class="bg-white p-4 rounded-lg max-w-3xl max-h-full overflow-auto"><img id="modalImage" src="" alt="預覽圖片" class="max-w-full max-h-[80vh] rounded"><button id="closeModal" class="absolute top-4 right-4 text-white text-3xl font-bold">&times;</button></div></div>
    <div id="notificationModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden"><div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full mx-4"><p id="notificationMessage" class="text-gray-800 text-base mb-4"></p><button id="closeNotificationModal" class="w-full bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700">確定</button></div></div>
    <div id="confirmationModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden"><div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full mx-4"><p id="confirmationMessage" class="text-gray-800 text-lg mb-6"></p><div class="flex justify-end space-x-4"><button id="confirmCancel" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">取消</button><button id="confirmOk" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">確定</button></div></div></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, addDoc, onSnapshot, updateDoc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- DOM 元素 ---
        const mainTabTodo = document.getElementById('main-tab-todo');
        const mainTabProd = document.getElementById('main-tab-prod');
        const todoFormView = document.getElementById('todo-form-view');
        const prodFormView = document.getElementById('prod-form-view');
        const addItemForm = document.getElementById('addItemForm');
        const addProdForm = document.getElementById('addProdForm');
        const todoListView = document.getElementById('todo-list-view');
        const prodListView = document.getElementById('prod-list-view');
        const todoItemsList = document.getElementById('todo-itemsList');
        const prodItemsList = document.getElementById('prod-itemsList');
        const todoSearchInput = document.getElementById('todo-searchInput');
        const prodSearchInput = document.getElementById('prod-searchInput');
        const authStatus = document.getElementById('auth-status');
        const todoSubmitButton = addItemForm.querySelector('button[type="submit"]');
        const prodSubmitButton = addProdForm.querySelector('button[type="submit"]');
        const imageModal = document.getElementById('imageModal');
        const modalImage = document.getElementById('modalImage');
        const closeModal = document.getElementById('closeModal');
        const notificationModal = document.getElementById('notificationModal');
        const notificationMessage = document.getElementById('notificationMessage');
        const closeNotificationModal = document.getElementById('closeNotificationModal');
        const confirmationModal = document.getElementById('confirmationModal');
        const confirmationMessage = document.getElementById('confirmationMessage');
        const confirmCancel = document.getElementById('confirmCancel');
        const confirmOk = document.getElementById('confirmOk');

        // --- 狀態變數 ---
        let allTodoItems = [];
        let allProdItems = [];
        let unsubscribeTodo = null;
        let unsubscribeProd = null;
        let confirmCallback = null;
        let editingItemId = null;
        let currentView = 'todo';
        const prodStatuses = ['待發包', '已發包', '生產中', '已完工', '已入庫'];

        // --- 日期初始化 ---
        document.getElementById('todo-date').valueAsDate = new Date();
        document.getElementById('prod-handoverDate').valueAsDate = new Date();
        document.getElementById('prod-completionDate').valueAsDate = new Date();

        // --- 主分頁切換 ---
        const switchMainTab = (view) => {
            currentView = view;
            editingItemId = null;
            const isTodo = view === 'todo';
            mainTabTodo.className = isTodo ? 'whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-indigo-500 text-indigo-600' : 'whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300';
            mainTabProd.className = !isTodo ? 'whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-indigo-500 text-indigo-600' : 'whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300';
            todoFormView.classList.toggle('hidden', !isTodo);
            prodFormView.classList.toggle('hidden', isTodo);
            todoListView.classList.toggle('hidden', !isTodo);
            prodListView.classList.toggle('hidden', isTodo);
        };
        mainTabTodo.addEventListener('click', () => switchMainTab('todo'));
        mainTabProd.addEventListener('click', () => switchMainTab('prod'));
        
        // --- Modal 輔助函數 ---
        const showNotification = (message) => { notificationMessage.textContent = message; notificationModal.classList.remove('hidden'); };
        const showConfirmation = (message, callback) => { confirmationMessage.textContent = message; confirmCallback = callback; confirmationModal.classList.remove('hidden'); };
        closeNotificationModal.addEventListener('click', () => notificationModal.classList.add('hidden'));
        confirmCancel.addEventListener('click', () => { confirmationModal.classList.add('hidden'); confirmCallback = null; });
        confirmOk.addEventListener('click', () => { confirmationModal.classList.add('hidden'); if (confirmCallback) confirmCallback(); confirmCallback = null; });
        closeModal.addEventListener('click', () => imageModal.classList.add('hidden'));
        imageModal.addEventListener('click', (e) => { if (e.target === imageModal) imageModal.classList.add('hidden'); });

        // --- Firebase 設定 ---
        let firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const manualFirebaseConfig = { apiKey: "AIzaSyA7IeOz4EJ-yMUccDTPOSaDm33fLChVD8Q", authDomain: "sunyu-check.firebaseapp.com", projectId: "sunyu-check", storageBucket: "sunyu-check.firebasestorage.app", messagingSenderId: "627211744361", appId: "1:627211744361:web:58bce4b5009f0c9d5bdef8" };
        if (!firebaseConfig || Object.keys(firebaseConfig).length === 0) { firebaseConfig = manualFirebaseConfig; }
        const appId = typeof __app_id !== 'undefined' ? __app_id : (firebaseConfig.projectId || 'default-app-id');

        // --- Firebase 初始化 ---
        if (!firebaseConfig || !firebaseConfig.apiKey) {
            authStatus.textContent = "錯誤：找不到 Firebase 設定。";
        } else {
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);
            const todoCollectionRef = collection(db, `/artifacts/${appId}/public/data/sharedTodoItems`);
            const prodCollectionRef = collection(db, `/artifacts/${appId}/public/data/productionOrders`);

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    authStatus.textContent = `已連線 | 公開共享模式`;
                    todoSubmitButton.disabled = false;
                    prodSubmitButton.disabled = false;
                    listenForTodoItems();
                    listenForProdItems();
                } else {
                    authStatus.textContent = '正在驗證身份...';
                    try {
                        if (typeof __initial_auth_token !== 'undefined') await signInWithCustomToken(auth, __initial_auth_token);
                        else await signInAnonymously(auth);
                    } catch (error) {
                        authStatus.textContent = '錯誤：無法連接。';
                    }
                }
            });

            // --- 資料監聽 ---
            const listenForTodoItems = () => {
                if (unsubscribeTodo) unsubscribeTodo();
                unsubscribeTodo = onSnapshot(todoCollectionRef, (snapshot) => {
                    allTodoItems = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    allTodoItems.sort((a, b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0));
                    renderTodoItems(todoSearchInput.value);
                });
            };
            const listenForProdItems = () => {
                if (unsubscribeProd) unsubscribeProd();
                unsubscribeProd = onSnapshot(prodCollectionRef, (snapshot) => {
                    allProdItems = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    allProdItems.sort((a, b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0));
                    renderProdItems(prodSearchInput.value);
                });
            };

            // --- 表單提交 ---
            addItemForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const imageFile = document.getElementById('todo-imageUpload').files[0];
                if (imageFile && imageFile.size > 750 * 1024) {
                    showNotification("圖片檔案過大，請選擇小於 750KB 的圖片。");
                    return;
                }
                const reader = new FileReader();
                reader.onloadend = async () => {
                    try {
                        await addDoc(todoCollectionRef, {
                            productionId: document.getElementById('todo-productionId').value,
                            assemblyId: document.getElementById('todo-assemblyId').value,
                            partNumber: document.getElementById('todo-partNumber').value,
                            content: document.getElementById('todo-content').value,
                            date: document.getElementById('todo-date').value,
                            image: reader.result || null,
                            completed: false,
                            createdAt: serverTimestamp()
                        });
                        addItemForm.reset();
                        document.getElementById('todo-date').valueAsDate = new Date();
                    } catch (error) {
                        showNotification(`新增待辦失敗: ${error.message}`);
                    }
                };
                if (imageFile) reader.readAsDataURL(imageFile);
                else reader.onloadend();
            });

            addProdForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const handoverDate = document.getElementById('prod-handoverDate').value;
                const completionDate = document.getElementById('prod-completionDate').value;
                if (new Date(completionDate) < new Date(handoverDate)) {
                    showNotification("完成日不能早于交接日。");
                    return;
                }
                try {
                    await addDoc(prodCollectionRef, {
                        parentPartNumber: document.getElementById('prod-parentPartNumber').value.trim() || null,
                        partNumber: document.getElementById('prod-partNumber').value,
                        productionId: document.getElementById('prod-productionId').value,
                        assemblyId: document.getElementById('prod-assemblyId').value,
                        quantity: Number(document.getElementById('prod-quantity').value),
                        process: document.getElementById('prod-process').value,
                        handoverDate,
                        completionDate,
                        status: '待發包',
                        createdAt: serverTimestamp()
                    });
                    addProdForm.reset();
                    document.getElementById('prod-handoverDate').valueAsDate = new Date();
                    document.getElementById('prod-completionDate').valueAsDate = new Date();
                } catch (error) {
                    showNotification(`新增流程失敗: ${error.message}`);
                }
            });

            // --- 列表事件代理 ---
            document.getElementById('list-container').addEventListener('click', async (e) => {
                const target = e.target;
                const tr = target.closest('tr');
                if (!tr) return;

                if (target.classList.contains('toggle-expand')) {
                    const parentId = tr.dataset.id;
                    const childRows = prodItemsList.querySelectorAll(`[data-parent-id="${parentId}"]`);
                    childRows.forEach(row => row.classList.toggle('hidden'));
                    target.classList.toggle('expanded');
                    return;
                }

                const id = tr.dataset.id;
                const isTodoView = currentView === 'todo';
                const collectionRef = isTodoView ? todoCollectionRef : prodCollectionRef;
                const docRef = doc(collectionRef, id);

                if (target.classList.contains('toggle-complete')) {
                    const item = allTodoItems.find(i => i.id === id);
                    await updateDoc(docRef, { completed: !item.completed });
                } else if (target.classList.contains('delete-item')) {
                    showConfirmation('您確定要刪除這個項目嗎？', () => deleteDoc(docRef));
                } else if (target.classList.contains('view-image')) {
                    const item = allTodoItems.find(i => i.id === id);
                    if (item && item.image) {
                        modalImage.src = item.image;
                        imageModal.classList.remove('hidden');
                    }
                } else if (target.classList.contains('edit-item')) {
                    editingItemId = id;
                    isTodoView ? renderTodoItems() : renderProdItems();
                } else if (target.classList.contains('cancel-edit')) {
                    editingItemId = null;
                    isTodoView ? renderTodoItems() : renderProdItems();
                } else if (target.classList.contains('save-item')) {
                    let updatedData = {};
                    try {
                        if (isTodoView) {
                            updatedData = {
                                productionId: tr.querySelector('.edit-productionId').value,
                                assemblyId: tr.querySelector('.edit-assemblyId').value,
                                partNumber: tr.querySelector('.edit-partNumber').value,
                                content: tr.querySelector('.edit-content').value,
                                date: tr.querySelector('.edit-date').value,
                            };
                        } else {
                             updatedData = {
                                parentPartNumber: tr.querySelector('.edit-parentPartNumber')?.value.trim() || null,
                                partNumber: tr.querySelector('.edit-partNumber').value,
                                productionId: tr.querySelector('.edit-productionId').value,
                                assemblyId: tr.querySelector('.edit-assemblyId').value,
                                quantity: Number(tr.querySelector('.edit-quantity').value),
                                process: tr.querySelector('.edit-process').value,
                                handoverDate: tr.querySelector('.edit-handoverDate').value,
                                completionDate: tr.querySelector('.edit-completionDate').value,
                                status: tr.querySelector('.edit-status').value,
                            };
                        }
                        await updateDoc(docRef, updatedData);
                        editingItemId = null;
                    } catch(error) {
                        showNotification(`儲存失敗: ${error.message}`);
                    }
                }
            });
        }
        
        // --- 渲染函數 ---
        const getStatusClasses = (status) => {
            switch (status) {
                case '待發包': return 'bg-gray-200 text-gray-800';
                case '已發包': return 'bg-blue-200 text-blue-800';
                case '生產中': return 'bg-amber-200 text-amber-800';
                case '已完工': return 'bg-green-200 text-green-800';
                case '已入庫': return 'bg-indigo-200 text-indigo-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        };

        const renderTodoItems = (filter = '') => {
            const list = allTodoItems.filter(item => item.productionId?.toLowerCase().includes(filter) || item.assemblyId?.toLowerCase().includes(filter) || item.partNumber?.toLowerCase().includes(filter));
            todoItemsList.innerHTML = '';
            document.getElementById('todo-no-results').classList.toggle('hidden', list.length > 0);
            list.forEach(item => {
                const isEditing = item.id === editingItemId;
                const tr = document.createElement('tr');
                tr.dataset.id = item.id;
                if (item.completed) tr.classList.add('completed');
                tr.innerHTML = isEditing ? `<td><input type="checkbox" class="toggle-complete" ${item.completed ? 'checked' : ''}></td><td><input class="edit-input edit-productionId" value="${item.productionId}"></td><td><input class="edit-input edit-assemblyId" value="${item.assemblyId || ''}"></td><td><input class="edit-input edit-partNumber" value="${item.partNumber}"></td><td><textarea class="edit-input edit-content">${item.content}</textarea></td><td>無法編輯</td><td><input type="date" class="edit-input edit-date" value="${item.date}"></td><td><button class="save-item text-green-600">儲存</button><button class="cancel-edit ml-2">取消</button></td>`
                : `<td><input type="checkbox" class="toggle-complete" ${item.completed ? 'checked' : ''}></td><td>${item.productionId}</td><td>${item.assemblyId || '-'}</td><td>${item.partNumber}</td><td class="max-w-xs truncate" title="${item.content}">${item.content}</td><td>${item.image ? `<button class="view-image text-indigo-600">預覽</button>` : '無'}</td><td>${item.date}</td><td><button class="edit-item text-indigo-600">編輯</button><button class="delete-item text-red-600 ml-2">刪除</button></td>`;
                todoItemsList.appendChild(tr);
            });
        };

        const renderProdItems = (filter = '') => {
            const parents = allProdItems.filter(item => !item.parentPartNumber);
            const children = allProdItems.filter(item => item.parentPartNumber);

            let filteredParents = parents;
            if (filter) {
                const lowerFilter = filter.toLowerCase();
                const parentMatches = parents.filter(p => p.partNumber.toLowerCase().includes(lowerFilter) || p.productionId.toLowerCase().includes(lowerFilter));
                const childMatches = children.filter(c => c.partNumber.toLowerCase().includes(lowerFilter) || c.productionId.toLowerCase().includes(lowerFilter));
                const parentIdsFromChildMatches = new Set(childMatches.map(c => c.parentPartNumber));
                const parentsFromChildMatches = parents.filter(p => parentIdsFromChildMatches.has(p.partNumber));
                filteredParents = [...new Set([...parentMatches, ...parentsFromChildMatches])];
            }
            
            prodItemsList.innerHTML = '';
            document.getElementById('prod-no-results').classList.toggle('hidden', filteredParents.length > 0);

            filteredParents.forEach(parent => {
                const parentIsEditing = parent.id === editingItemId;
                const parentTr = document.createElement('tr');
                parentTr.dataset.id = parent.id;
                const statusClasses = getStatusClasses(parent.status);
                parentTr.className = `transition-colors duration-300 ${parentIsEditing ? 'bg-white' : statusClasses.split(' ')[0].replace('200', '50')}`;
                
                const childItems = children.filter(c => c.parentPartNumber === parent.partNumber);
                const expanderIcon = childItems.length > 0 ? `<svg class="toggle-expand w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>` : '';

                if (parentIsEditing) {
                    const options = prodStatuses.map(s => `<option value="${s}" ${s === parent.status ? 'selected' : ''}>${s}</option>`).join('');
                    parentTr.innerHTML = `<td></td><td><select class="edit-input edit-status">${options}</select></td><td><input class="edit-input edit-partNumber" value="${parent.partNumber}"><input type="hidden" class="edit-parentPartNumber" value=""></td><td><input class="edit-input edit-productionId" value="${parent.productionId}"></td><td><input class="edit-input edit-assemblyId" value="${parent.assemblyId || ''}"></td><td><input type="number" class="edit-input edit-quantity" value="${parent.quantity}"></td><td><input class="edit-input edit-process" value="${parent.process}"></td><td><input type="date" class="edit-input edit-handoverDate" value="${parent.handoverDate}"></td><td><input type="date" class="edit-input edit-completionDate" value="${parent.completionDate}"></td><td><button class="save-item text-green-600">儲存</button><button class="cancel-edit ml-2">取消</button></td>`;
                } else {
                    parentTr.innerHTML = `<td>${expanderIcon}</td><td><span class="status-badge ${statusClasses}">${parent.status || 'N/A'}</span></td><td>${parent.partNumber}</td><td>${parent.productionId}</td><td>${parent.assemblyId || '-'}</td><td>${parent.quantity}</td><td>${parent.process}</td><td>${parent.handoverDate}</td><td>${parent.completionDate}</td><td><button class="edit-item text-indigo-600">編輯</button><button class="delete-item text-red-600 ml-2">刪除</button></td>`;
                }
                prodItemsList.appendChild(parentTr);

                childItems.forEach(child => {
                    const childIsEditing = child.id === editingItemId;
                    const childTr = document.createElement('tr');
                    childTr.dataset.id = child.id;
                    childTr.dataset.parentId = parent.id;
                    const childStatusClasses = getStatusClasses(child.status);
                    childTr.className = `hidden transition-colors duration-300 bg-gray-50 ${childIsEditing ? 'bg-white' : ''}`;

                     if (childIsEditing) {
                        const options = prodStatuses.map(s => `<option value="${s}" ${s === child.status ? 'selected' : ''}>${s}</option>`).join('');
                        childTr.innerHTML = `<td></td><td><select class="edit-input edit-status">${options}</select></td><td class="pl-8"><input class="edit-input edit-partNumber" value="${child.partNumber}"><input type="hidden" class="edit-parentPartNumber" value="${child.parentPartNumber}"></td><td><input class="edit-input edit-productionId" value="${child.productionId}"></td><td><input class="edit-input edit-assemblyId" value="${child.assemblyId || ''}"></td><td><input type="number" class="edit-input edit-quantity" value="${child.quantity}"></td><td><input class="edit-input edit-process" value="${child.process}"></td><td><input type="date" class="edit-input edit-handoverDate" value="${child.handoverDate}"></td><td><input type="date" class="edit-input edit-completionDate" value="${child.completionDate}"></td><td><button class="save-item text-green-600">儲存</button><button class="cancel-edit ml-2">取消</button></td>`;
                    } else {
                        childTr.innerHTML = `<td></td><td><span class="status-badge ${childStatusClasses}">${child.status || 'N/A'}</span></td><td class="pl-8">${child.partNumber}</td><td>${child.productionId}</td><td>${child.assemblyId || '-'}</td><td>${child.quantity}</td><td>${child.process}</td><td>${child.handoverDate}</td><td>${child.completionDate}</td><td><button class="edit-item text-indigo-600">編輯</button><button class="delete-item text-red-600 ml-2">刪除</button></td>`;
                    }
                    prodItemsList.appendChild(childTr);
                });
            });
        };

        // --- 搜尋 ---
        todoSearchInput.addEventListener('input', (e) => renderTodoItems(e.target.value.toLowerCase()));
        prodSearchInput.addEventListener('input', (e) => renderProdItems(e.target.value.toLowerCase()));

    </script>
</body>
</html>
