<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å·¥å» å”ä½œç®¡ç†ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- å¼•å…¥ Phosphor Icons åœ–ç¤ºåº«ï¼Œè®“ä»‹é¢æ›´ç¾ä»£åŒ– -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script>
        tailwind.config = {
            theme: { 
                extend: { 
                    fontFamily: { sans: ['Noto Sans TC', 'sans-serif'] },
                    colors: {
                        'brand': { 50: '#eff6ff', 100: '#dbeafe', 500: '#3b82f6', 600: '#2563eb', 700: '#1d4ed8', 800: '#1e40af' }
                    }
                } 
            }
        }
    </script>
    <style>
        /* è‡ªå®šç¾©æ»¾å‹•æ¢ - æ›´ç´°ç·» */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* ç”˜ç‰¹åœ–ä½ˆå±€è®Šæ•¸ - å› æ‡‰å­—é«”åŠ å¤§ï¼Œæ¬„ä½å¯¬åº¦åŒæ­¥åŠ å¯¬ */
        :root {
            --name-width: 260px; /* ä»»å‹™åç¨±æ¬„ä½åŠ å¯¬ */
            --grid-cols: 700px; /* ç¸½å¯¬åº¦å¢åŠ  */
            --timeline-width: 1200px;
        }

        /* Gantt Layout */
        .gantt-container { overflow: auto; height: 100%; position: relative; background-color: #f8fafc; }
        .gantt-grid-layout { 
            display: grid; 
            grid-template-columns: var(--grid-cols) 1fr; 
            min-width: calc(var(--grid-cols) + var(--timeline-width)); 
        }

        /* å‡çµçª—æ ¼æ•ˆæœå„ªåŒ– */
        .sticky-left { position: sticky; left: 0; z-index: 20; background: white; border-right: 1px solid #e2e8f0; box-shadow: 2px 0 5px rgba(0,0,0,0.02); }
        .sticky-header { position: sticky; top: 0; z-index: 30; background: #f8fafc; border-bottom: 1px solid #e2e8f0; box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
        .sticky-corner { position: sticky; left: 0; top: 0; z-index: 40; background: #f1f5f9; border-right: 1px solid #e2e8f0; border-bottom: 1px solid #e2e8f0; }

        /* è¡¨æ ¼ç·šæ¢èˆ‡äº’å‹• */
        .gantt-row { border-bottom: 1px solid #f1f5f9; transition: all 0.15s ease; height: 48px; /* ç¨å¾®å¢é«˜è¡Œé«˜ä»¥é©æ‡‰å¤§å­—é«” */ }
        .gantt-cell-border { border-right: 1px solid #f1f5f9; }
        .gantt-timeline-cell { flex-shrink: 0; border-right: 1px dashed #e2e8f0; text-align: center; position: relative; height: 100%; }
        .gantt-timeline-cell.weekend { background-color: #f8fafc; background-image: repeating-linear-gradient(45deg, #f1f5f9 25%, transparent 25%, transparent 75%, #f1f5f9 75%, #f1f5f9), repeating-linear-gradient(45deg, #f1f5f9 25%, #f8fafc 25%, #f8fafc 75%, #f1f5f9 75%, #f1f5f9); background-position: 0 0, 10px 10px; background-size: 20px 20px; }

        /* Task Bars */
        .gantt-bar { 
            position: absolute; height: 28px; top: 10px; border-radius: 6px; /* é«˜åº¦å¢åŠ  */
            cursor: grab; transition: transform 0.1s, box-shadow 0.2s; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); font-size: 13px; /* å­—é«”åŠ å¤§ */
            display: flex; items-center; padding-left: 10px; color: white; 
            overflow: visible; z-index: 10; white-space: nowrap; font-weight: 500;
        }
        .gantt-bar:hover { z-index: 25; box-shadow: 0 4px 12px rgba(0,0,0,0.15); filter: brightness(105%); }
        .gantt-bar:active { cursor: grabbing; }
        
        /* Parent Task Bar */
        .gantt-bar.is-parent { 
            height: 16px; top: 16px; border-radius: 4px; /* é«˜åº¦å¾®èª¿ */
            background: #475569; opacity: 1; cursor: pointer;
            border: 1px solid #334155;
        }
        .gantt-bar.is-parent::before, .gantt-bar.is-parent::after { 
            content: ''; position: absolute; top: 14px; width: 0; height: 0; border-style: solid; 
        }
        .gantt-bar.is-parent::before { left: 0; border-width: 0 0 8px 8px; border-color: transparent transparent transparent #334155; transform: rotate(90deg); }
        .gantt-bar.is-parent::after { right: 0; border-width: 0 8px 8px 0; border-color: transparent #334155 transparent transparent; transform: rotate(-90deg); }

        /* Parent Row Styling */
        .gantt-row.is-parent-row { background-color: #f8fafc !important; font-weight: 700; color: #1e293b; }
        .gantt-row.is-parent-row:hover { background-color: #f1f5f9 !important; }

        /* Today Marker - Modern */
        .today-line { position: absolute; top: 0; bottom: 0; left: 50%; width: 2px; background: #ef4444; z-index: 15; pointer-events: none; box-shadow: 0 0 4px rgba(239, 68, 68, 0.4); }
        .today-label { 
            position: absolute; top: -26px; left: 50%; transform: translateX(-50%);
            background: #ef4444; color: white; font-size: 11px; /* å­—é«”åŠ å¤§ */
            font-weight: bold;
            padding: 3px 8px; border-radius: 4px; z-index: 16; white-space: nowrap;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .today-label::after {
            content: ''; position: absolute; top: 100%; left: 50%; margin-left: -4px;
            border-width: 4px; border-style: solid; border-color: #ef4444 transparent transparent transparent;
        }

        .gantt-row:hover { background-color: #f8fafc; }
        
        /* Custom Tooltip */
        .gantt-tooltip {
            position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%) translateY(-8px);
            background: #1e293b; color: white; padding: 8px 12px; border-radius: 6px;
            font-size: 13px; /* å­—é«”åŠ å¤§ */
            white-space: nowrap; pointer-events: none; opacity: 0;
            transition: opacity 0.2s, transform 0.2s; z-index: 50; box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            text-align: left; min-width: 140px;
        }
        .gantt-tooltip::after {
            content: ''; position: absolute; top: 100%; left: 50%; margin-left: -5px;
            border-width: 5px; border-style: solid; border-color: #1e293b transparent transparent transparent;
        }
        .gantt-bar:hover .gantt-tooltip { opacity: 1; transform: translateX(-50%) translateY(-5px); }
        
        .gantt-info-row { display: flex; justify-content: space-between; gap: 12px; margin-bottom: 2px; }
        .gantt-info-label { color: #94a3b8; }

        /* Drag & Drop Styles */
        .draggable-handle { cursor: grab; color: #94a3b8; transition: color 0.2s; }
        .draggable-handle:hover { color: #475569; }
        .gantt-row.dragging { opacity: 0.5; background: #f0f9ff; }
        .gantt-row.drag-over-top { border-top: 2px solid #3b82f6 !important; }
        .gantt-row.drag-over-bottom { border-bottom: 2px solid #3b82f6 !important; }

        /* Column Resizer */
        .col-resizer {
            position: absolute; right: 0; top: 0; bottom: 0; width: 4px;
            cursor: col-resize; z-index: 50; opacity: 0; transition: all 0.2s;
        }
        .header-cell-resizable:hover .col-resizer, .col-resizer:hover, .col-resizer.resizing {
            opacity: 1; background: #3b82f6;
        }
        
        /* Collapse Arrow */
        .collapse-arrow { cursor: pointer; width: 24px; height: 24px; display: flex; items-center; justify-center; border-radius: 4px; transition: background 0.2s; }
        .collapse-arrow:hover { background: #e2e8f0; }
        .collapse-arrow i { transition: transform 0.2s; font-size: 14px; }
        .collapsed .collapse-arrow i { transform: rotate(-90deg); }

        @media print {
            .no-print { display: none !important; }
            .print-show { display: block !important; }
            body { height: auto !important; overflow: visible !important; -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
            .gantt-container { overflow: visible; }
            .gantt-bar { -webkit-print-color-adjust: exact; box-shadow: none !important; }
        }
    </style>
</head>
<body class="bg-gray-50 text-slate-800 font-sans h-screen flex overflow-hidden">

    <!-- å´é‚Šå°èˆª -->
    <aside class="w-64 bg-slate-900 text-slate-300 flex-shrink-0 flex flex-col no-print transition-all duration-300 z-50 shadow-xl" id="sidebar">
        <div class="p-6 text-xl font-bold text-white border-b border-slate-800 flex items-center gap-3">
            <i class="ph-fill ph-factory text-indigo-400 text-3xl"></i>
            <span class="tracking-wide text-lg">å·¥å» å”ä½œç³»çµ±</span>
        </div>
        <div class="px-4 py-4">
            <div class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-2 px-2">ç®¡ç†åŠŸèƒ½</div>
            <nav class="space-y-1">
                <button onclick="window.app.switchTab('todo')" class="nav-btn w-full text-left px-3 py-3 rounded-lg hover:bg-slate-800 hover:text-white transition-all flex items-center gap-3 text-base" data-tab="todo">
                    <i class="ph ph-clipboard-text text-xl"></i> å¾…ä¿®æ”¹æ˜ç´°
                </button>
                <button onclick="window.app.switchTab('event')" class="nav-btn w-full text-left px-3 py-3 rounded-lg hover:bg-slate-800 hover:text-white transition-all flex items-center gap-3 text-base" data-tab="event">
                    <i class="ph ph-calendar-check text-xl"></i> äº‹ä»¶è¿½è¹¤
                </button>
                <button onclick="window.app.switchTab('feedback')" class="nav-btn w-full text-left px-3 py-3 rounded-lg hover:bg-slate-800 hover:text-white transition-all flex items-center gap-3 text-base" data-tab="feedback">
                    <i class="ph ph-chat-circle-dots text-xl"></i> å•é¡Œåé¥‹
                </button>
                <button onclick="window.app.switchTab('gantt')" class="nav-btn w-full text-left px-3 py-3 rounded-lg hover:bg-slate-800 hover:text-white transition-all flex items-center gap-3 text-base" data-tab="gantt">
                    <i class="ph ph-chart-bar text-xl"></i> å‘¨è¨ˆç•«æ’ç¨‹
                </button>
            </nav>
        </div>
        
        <div class="mt-auto p-4 border-t border-slate-800">
            <div class="flex items-center gap-3 text-sm text-slate-400">
                <div class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></div>
                <span id="auth-status">é€£ç·šä¸­...</span>
            </div>
        </div>
    </aside>

    <!-- ä¸»å…§å®¹å€ -->
    <main class="flex-1 flex flex-col min-w-0 bg-white relative">
        <!-- é ‚éƒ¨å·¥å…·åˆ— -->
        <header class="h-16 border-b border-slate-200 flex items-center justify-between px-6 bg-white no-print flex-shrink-0 z-20">
            <div class="flex items-center gap-4">
                <h1 id="page-title" class="text-2xl font-bold text-slate-800 flex items-center gap-2">
                    <span class="w-1.5 h-7 bg-indigo-600 rounded-full"></span>
                    å¾…ä¿®æ”¹æ˜ç´°
                </h1>
            </div>
            <div class="flex gap-3" id="header-actions">
                <!-- å‹•æ…‹æ³¨å…¥æŒ‰éˆ• -->
            </div>
        </header>

        <!-- å…§å®¹å®¹å™¨ -->
        <div id="app-container" class="flex-1 overflow-hidden relative bg-gray-50 flex flex-col">
            <!-- Loading -->
            <div id="loading" class="absolute inset-0 flex items-center justify-center bg-white/90 z-50 backdrop-blur-sm transition-opacity duration-500">
                <div class="flex flex-col items-center">
                    <div class="animate-spin rounded-full h-12 w-12 border-[4px] border-indigo-100 border-t-indigo-600 mb-4"></div>
                    <div class="text-slate-600 font-medium tracking-wide text-base">æ­£åœ¨åŒæ­¥é›²ç«¯è³‡æ–™...</div>
                </div>
            </div>

            <!-- Views -->
            <div id="view-todo" class="view-section space-y-4 hidden p-6 overflow-auto h-full"></div>
            <div id="view-event" class="view-section space-y-4 hidden p-6 overflow-auto h-full"></div>
            <div id="view-feedback" class="view-section space-y-4 hidden p-6 overflow-auto h-full"></div>
            <!-- Gantt View -->
            <div id="view-gantt" class="view-section hidden h-full flex flex-col"></div>
        </div>
    </main>

    <!-- çµ±ä¸€ Modal -->
    <div id="uni-modal" class="fixed inset-0 bg-slate-900/40 z-50 hidden items-center justify-center p-4 no-print backdrop-blur-sm transition-all duration-300 opacity-0" aria-hidden="true">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col transform transition-all scale-95 duration-200 border border-slate-100">
            <div class="px-6 py-5 border-b border-slate-100 flex justify-between items-center bg-white rounded-t-xl">
                <h3 id="modal-title" class="text-xl font-bold text-slate-800"></h3>
                <button onclick="window.modal.close()" class="text-slate-400 hover:text-slate-600 hover:bg-slate-100 w-10 h-10 flex items-center justify-center rounded-full transition-colors">
                    <i class="ph ph-x text-2xl"></i>
                </button>
            </div>
            <div id="modal-body" class="p-8 overflow-y-auto custom-scrollbar"></div>
            <div id="modal-footer" class="p-6 border-t border-slate-100 flex justify-end gap-3 bg-slate-50 rounded-b-xl"></div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-6 right-6 bg-slate-900 text-white px-6 py-4 rounded-lg shadow-lg transform translate-y-32 transition-transform duration-300 z-[100] flex items-center gap-3 border border-slate-700">
        <span id="toast-icon" class="text-2xl">âœ…</span>
        <span id="toast-msg" class="font-medium text-base">Notification</span>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, serverTimestamp, query, orderBy, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Config & Utils ---
        const CONFIG = {
            firebase: JSON.parse(`{"apiKey":"AIzaSyA7IeOz4EJ-yMUccDTPOSaDm33fLChVD8Q","authDomain":"sunyu-check.firebaseapp.com","projectId":"sunyu-check","storageBucket":"sunyu-check.appspot.com","messagingSenderId":"627211744361","appId":"1:627211744361:web:58bce4b5009f0c9d5bdef8"}`),
            appId: "sunyu-check",
            cols: {
                todo: [
                    { k: 'status', l: 'ç‹€æ…‹', w: '110px', render: r => r.completed ? '<span class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full text-sm font-medium bg-slate-100 text-slate-600 border border-slate-200"><i class="ph-fill ph-check-circle"></i>å·²å®Œæˆ</span>' : '<span class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full text-sm font-medium bg-blue-50 text-blue-600 border border-blue-200"><i class="ph-fill ph-hourglass"></i>å¾…è™•ç†</span>' },
                    { k: 'productionId', l: 'ç”Ÿç”¢ç·¨è™Ÿ', w: '130px' }, 
                    { k: 'partNumber', l: 'æ–™è™Ÿ', w: '130px' }, 
                    { k: 'content', l: 'ä¿®æ”¹å…§å®¹', w: 'auto' },
                    { k: 'date', l: 'æ—¥æœŸ', w: '130px' },
                    { k: 'actions', l: 'æ“ä½œ', type: 'actions', w: '150px' }
                ],
                event: [
                    { k: 'priority', l: 'å„ªå…ˆ', w: '90px', render: r => `<div class="flex justify-center"><span class="w-7 h-7 rounded-full flex items-center justify-center text-white text-sm font-bold shadow-sm ${r.priority==='high'?'bg-red-500 ring-2 ring-red-100':r.priority==='low'?'bg-emerald-500 ring-2 ring-emerald-100':'bg-amber-500 ring-2 ring-amber-100'}">${r.priority==='high'?'H':r.priority==='low'?'L':'M'}</span></div>` },
                    { k: 'date', l: 'æ—¥æœŸ', w: '130px' }, 
                    { k: 'matter', l: 'äº‹é …å…§å®¹', w: 'auto' }, 
                    { k: 'personnel', l: 'ç›¸é—œäººå“¡', w: '160px' },
                    { k: 'closed', l: 'ç‹€æ…‹', w: '110px', render: r => r.closed ? '<span class="text-slate-400 font-medium text-base flex items-center gap-1"><i class="ph-fill ph-check-square"></i> å·²çµæ¡ˆ</span>' : '<span class="text-emerald-600 font-medium text-base flex items-center gap-1"><i class="ph-fill ph-lightning"></i> é€²è¡Œä¸­</span>' },
                    { k: 'actions', l: 'æ“ä½œ', type: 'actions', w: '190px' }
                ],
                feedback: [
                    { k: 'feedbackType', l: 'é¡å‹', w: '130px', render: r => `<span class="px-3 py-1.5 rounded text-sm bg-slate-100 text-slate-700 font-bold border border-slate-200">${r.feedbackType}</span>` }, 
                    { k: 'problem', l: 'å•é¡Œæè¿°', w: '40%' }, 
                    { k: 'solution', l: 'è§£æ±ºæ–¹æ¡ˆ', w: 'auto' },
                    { k: 'status', l: 'ç‹€æ…‹', w: '110px', render: r => r.status === 'å·²çµæ¡ˆ' ? '<span class="text-green-600 font-bold text-base">å·²çµæ¡ˆ</span>' : '<span class="text-amber-500 font-bold text-base">è™•ç†ä¸­</span>' }, 
                    { k: 'actions', l: 'æ“ä½œ', type: 'actions', w: '110px' }
                ]
            }
        };

        const utils = {
            $: (s) => document.querySelector(s),
            date: (d = new Date()) => d.toISOString().split('T')[0],
            toast: (msg, icon='âœ…') => {
                const t = utils.$('#toast'); 
                utils.$('#toast-msg').textContent = msg;
                utils.$('#toast-icon').textContent = icon;
                t.classList.remove('translate-y-32');
                setTimeout(() => t.classList.add('translate-y-32'), 3000);
            },
            addWorkingDays: (startDateStr, days) => {
                if (!startDateStr || !days) return '-';
                let current = new Date(startDateStr);
                let remaining = parseInt(days);
                while (remaining > 0) {
                    const day = current.getDay();
                    if (day !== 0 && day !== 6) { remaining--; }
                    if (remaining > 0) { current.setDate(current.getDate() + 1); }
                }
                return current.toISOString().split('T')[0];
            },
            countWorkingDays: (startStr, endStr) => {
                let start = new Date(startStr);
                let end = new Date(endStr);
                let count = 0;
                let cur = new Date(start);
                while(cur <= end) {
                    const day = cur.getDay();
                    if(day !== 0 && day !== 6) count++;
                    cur.setDate(cur.getDate() + 1);
                }
                return count;
            },
            addDays: (dateStr, days) => {
                const d = new Date(dateStr);
                d.setDate(d.getDate() + days);
                return d.toISOString().split('T')[0];
            }
        };

        // --- Firebase Service ---
        class FirestoreService {
            constructor() {
                const app = initializeApp(CONFIG.firebase);
                this.auth = getAuth(app);
                this.db = getFirestore(app);
                this.coll = null; 
                this.user = null;
            }
            async init() {
                return new Promise(resolve => {
                    const initAuth = async () => {
                        try {
                            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                                await signInWithCustomToken(this.auth, __initial_auth_token);
                            } else {
                                await signInAnonymously(this.auth);
                            }
                        } catch (e) {
                            console.error('Authentication error, falling back to anonymous:', e);
                            await signInAnonymously(this.auth);
                        }
                    };
                    initAuth();
                    
                    onAuthStateChanged(this.auth, async (u) => {
                        this.user = u;
                        if(u) {
                             // Use public collection as per user context implies shared factory system
                            this.coll = collection(this.db, `/artifacts/${CONFIG.appId}/public/data/sharedTodoItems`);
                            utils.$('#auth-status').textContent = `ä½¿ç”¨è€…: ${this.user.uid.slice(0,4)}..`;
                            resolve(this.user);
                        }
                    });
                });
            }
            sub(cb) {
                if (!this.coll) return;
                return onSnapshot(query(this.coll, orderBy("createdAt", "desc")), (snap) => {
                    const data = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    cb(data);
                }, (error) => {
                    console.error("Firestore error:", error);
                    utils.toast('é€£ç·šä¸­æ–·ï¼Œè«‹é‡æ–°æ•´ç†', 'âš ï¸');
                });
            }
            async add(data) { if(!this.user) return; await addDoc(this.coll, { ...data, createdAt: serverTimestamp() }); utils.toast('æ–°å¢æˆåŠŸ'); }
            async update(id, data) { if(!this.user) return; await updateDoc(doc(this.coll, id), data); utils.toast('æ›´æ–°æˆåŠŸ'); }
            async del(id) { 
                if(!this.user) return;
                if(confirm('ç¢ºå®šè¦åˆªé™¤æ­¤é …ç›®å—ï¼Ÿå¦‚æœé€™æ˜¯çˆ¶ä»»å‹™ï¼Œå»ºè­°å…ˆç§»é™¤å­ä»»å‹™çš„é—œè¯ã€‚')) { 
                    await deleteDoc(doc(this.coll, id)); 
                    utils.toast('å·²åˆªé™¤', 'ğŸ—‘ï¸'); 
                    return true;
                }
                return false;
            }
            async batchUpdateOrders(updates) {
                if(!this.user) return;
                const batch = writeBatch(this.db);
                updates.forEach(({id, order}) => {
                    const ref = doc(this.coll, id);
                    batch.update(ref, { order });
                });
                await batch.commit();
                utils.toast('æ’åºå·²æ›´æ–°', 'â‡…');
            }
        }
        const db = new FirestoreService();

        // --- UI Components ---
        const modal = {
            el: utils.$('#uni-modal'),
            open(title, bodyHtml, footerHtml = '') {
                utils.$('#modal-title').textContent = title;
                utils.$('#modal-body').innerHTML = bodyHtml;
                utils.$('#modal-footer').innerHTML = footerHtml;
                this.el.classList.remove('hidden');
                this.el.classList.add('flex');
                setTimeout(() => {
                    this.el.classList.remove('opacity-0');
                    utils.$('#uni-modal > div').classList.remove('scale-95');
                }, 10);
            },
            close() { 
                utils.$('#uni-modal > div').classList.add('scale-95');
                this.el.classList.add('opacity-0');
                setTimeout(() => {
                    this.el.classList.add('hidden'); 
                    this.el.classList.remove('flex');
                }, 300);
            }
        };
        window.modal = modal;

        const renderer = {
            table(items, cols, type) {
                if (!items.length) return `
                    <div class="flex flex-col items-center justify-center py-20 bg-white rounded-xl border border-dashed border-slate-300">
                        <i class="ph ph-tray text-6xl text-slate-300 mb-4"></i>
                        <div class="text-slate-500 font-medium text-lg">ç›®å‰å°šç„¡è³‡æ–™</div>
                        <button onclick="window.app.openEditModal('${type}')" class="mt-4 text-indigo-600 font-bold hover:underline text-base">æ–°å¢ç¬¬ä¸€ç­†${window.app.getTypeName(type)}</button>
                    </div>`;
                return `
                <div class="overflow-hidden border border-slate-200 rounded-xl shadow-sm bg-white">
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-slate-200">
                            <thead class="bg-slate-50"><tr>${cols.map(c => `<th class="px-6 py-4 text-left text-sm font-bold text-slate-600 uppercase tracking-wider">${c.l}</th>`).join('')}</tr></thead>
                            <tbody class="divide-y divide-slate-100 bg-white">
                                ${items.map(item => `
                                    <tr class="hover:bg-slate-50 transition-colors group">
                                        ${cols.map(c => {
                                            if (c.type === 'actions') return `
                                                <td class="px-6 py-4 whitespace-nowrap text-base font-medium opacity-0 group-hover:opacity-100 transition-opacity">
                                                    <div class="flex items-center gap-3">
                                                        <button onclick="window.app.handlers.edit('${type}', '${item.id}')" class="text-indigo-600 hover:text-indigo-800 transition-colors p-1.5 rounded hover:bg-indigo-50" title="ç·¨è¼¯"><i class="ph-bold ph-pencil-simple text-xl"></i></button>
                                                        <button onclick="window.app.handlers.del('${item.id}')" class="text-red-600 hover:text-red-800 transition-colors p-1.5 rounded hover:bg-red-50" title="åˆªé™¤"><i class="ph-bold ph-trash text-xl"></i></button>
                                                        ${type === 'event' ? `<button onclick="window.app.handlers.toGantt('${item.id}')" class="text-emerald-600 hover:text-emerald-800 ml-2 font-bold bg-emerald-50 px-3 py-1.5 rounded border border-emerald-200 text-sm flex items-center gap-1"><i class="ph-bold ph-plus"></i>æ’ç¨‹</button>` : ''}
                                                    </div>
                                                </td>`;
                                            return `<td class="px-6 py-4 text-base text-slate-700" style="${c.w ? `min-width:${c.w}`:''}">${c.render ? c.render(item) : (item[c.k] || '<span class="text-slate-300">-</span>')}</td>`;
                                        }).join('')}
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>`;
            },
            form(fields, type) {
                return fields.map(f => `
                    <div class="mb-5">
                        <label class="block text-base font-bold text-slate-700 mb-2">${f.label}</label>
                        ${f.type === 'select' 
                            ? `<div class="relative"><select name="${f.name}" class="w-full border border-slate-300 rounded-lg p-3 bg-slate-50 focus:bg-white focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none appearance-none font-medium text-slate-700 text-base transition-colors">${f.opts.map(o => {
                                const val = typeof o === 'object' ? o.v : o;
                                const lbl = typeof o === 'object' ? o.l : o;
                                // Fix: Ensure null and empty string comparison works for "No Parent" option
                                const isSelected = (f.val || '') == (val || '');
                                return `<option value="${val}" ${isSelected ? 'selected' : ''}>${lbl}</option>`;
                            }).join('')}</select><div class="absolute inset-y-0 right-0 flex items-center px-4 pointer-events-none text-gray-500"><i class="ph-bold ph-caret-down text-lg"></i></div></div>`
                            : f.type === 'textarea' 
                                ? `<textarea name="${f.name}" rows="4" class="w-full border border-slate-300 rounded-lg p-3 bg-slate-50 focus:bg-white focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none font-medium text-slate-700 text-base transition-colors" placeholder="è«‹è¼¸å…¥${f.label}...">${f.val||''}</textarea>`
                                : `<input type="${f.type||'text'}" name="${f.name}" class="w-full border border-slate-300 rounded-lg p-3 bg-slate-50 focus:bg-white focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none font-medium text-slate-700 text-base transition-colors" value="${f.val||''}" placeholder="${f.placeholder||''}">`
                        }
                    </div>
                `).join('');
            }
        };

        // --- Enhanced Gantt Manager ---
        class GanttManager {
            constructor() {
                this.zoom = 42; 
                this.viewStart = new Date();
                this.viewStart.setDate(this.viewStart.getDate() - 3); 
                this.daysToShow = 35; 
                this.filterAssignee = '';
                this.hideCompleted = false;
                this.hideWeekends = false; 
                this.showProgressCol = true;
                this.nameColWidth = 260; // é è¨­åŠ å¯¬
                
                // State
                this.isResizing = false;
                this.collapsedRows = new Set(); 
                
                // Drag Drop State
                this.draggedId = null;
                this.dragOverId = null;
                this.dragPosition = null; 
            }

            setView(mode, val) {
                if (mode === 'date' && val) {
                     const d = new Date(val);
                     d.setDate(d.getDate() - 2); 
                     this.viewStart = d;
                     app.render();
                     return;
                }

                const d = new Date(this.viewStart);
                if (mode === 'prev') d.setDate(d.getDate() - 7);
                if (mode === 'next') d.setDate(d.getDate() + 7);
                if (mode === 'today') {
                    const now = new Date();
                    now.setDate(now.getDate() - 2); 
                    this.viewStart = now;
                    // Reset date picker
                    const picker = utils.$('#gantt-date-picker');
                    if(picker) picker.value = utils.date();
                    app.render();
                    return;
                }
                this.viewStart = d;
                
                // Sync date picker
                const picker = utils.$('#gantt-date-picker');
                if(picker) {
                    const centerDate = new Date(this.viewStart);
                    centerDate.setDate(centerDate.getDate() + 2);
                    picker.value = utils.date(centerDate);
                }
                
                app.render();
            }

            setZoom(delta) {
                const oldZoom = this.zoom;
                this.zoom = Math.max(28, Math.min(130, this.zoom + delta)); // å¢åŠ ç¸®æ”¾ç¯„åœ
                if (this.zoom < oldZoom) this.daysToShow += 4;
                else this.daysToShow = Math.max(14, this.daysToShow - 2);
                app.render();
            }

            setFilter(assignee) { this.filterAssignee = assignee; app.render(); }
            toggleCompleted(checked) { this.hideCompleted = checked; app.render(); }
            toggleWeekends(checked) { this.hideWeekends = checked; app.render(); }
            toggleProgressCol(checked) { this.showProgressCol = checked; this.updateLayout(); app.render(); }
            
            toggleCollapse(id) {
                if (this.collapsedRows.has(id)) {
                    this.collapsedRows.delete(id);
                } else {
                    this.collapsedRows.add(id);
                }
                app.render();
            }

            startResize(e) {
                e.preventDefault(); e.stopPropagation();
                this.isResizing = true;
                this.startX = e.pageX;
                this.startWidth = this.nameColWidth;
                document.body.style.cursor = 'col-resize';
                
                const moveHandler = (e) => {
                    if (!this.isResizing) return;
                    const diff = e.pageX - this.startX;
                    this.nameColWidth = Math.max(180, this.startWidth + diff);
                    this.updateLayout();
                    app.render(); 
                };
                
                const upHandler = () => {
                    this.isResizing = false;
                    document.body.style.cursor = 'default';
                    document.removeEventListener('mousemove', moveHandler);
                    document.removeEventListener('mouseup', upHandler);
                };
                
                document.addEventListener('mousemove', moveHandler);
                document.addEventListener('mouseup', upHandler);
            }
            
            updateLayout() {
                const container = utils.$('#view-gantt');
                if (!container) return;
                // åŠ å¯¬æ¬„ä½å¯¬åº¦è¨­å®šä»¥å®¹ç´è¼ƒå¤§å­—é«”
                const fixedWidths = 60 + 90 + 90 + 60 + 80 + (this.showProgressCol ? 70 : 0); 
                const totalGridWidth = this.nameColWidth + fixedWidths;
                container.style.setProperty('--name-width', `${this.nameColWidth}px`);
                container.style.setProperty('--grid-cols', `${totalGridWidth}px`);
            }

            // --- Drag & Drop Handlers (Row Reorder) ---
            handleDragStart(e, id) {
                this.draggedId = id;
                e.dataTransfer.effectAllowed = 'move';
                e.target.closest('.gantt-row').classList.add('dragging');
            }

            handleDragOver(e, id) {
                e.preventDefault();
                if (this.draggedId === id) return;
                const row = e.target.closest('.gantt-row');
                const rect = row.getBoundingClientRect();
                const mid = rect.top + rect.height / 2;
                
                this.dragOverId = id;
                this.dragPosition = e.clientY < mid ? 'top' : 'bottom';
                
                document.querySelectorAll('.gantt-row').forEach(r => r.classList.remove('drag-over-top', 'drag-over-bottom'));
                if (this.dragPosition === 'top') row.classList.add('drag-over-top');
                else row.classList.add('drag-over-bottom');
            }

            async handleDrop(e, targetId) {
                e.preventDefault();
                document.querySelectorAll('.gantt-row').forEach(r => r.classList.remove('dragging', 'drag-over-top', 'drag-over-bottom'));
                
                if (!this.draggedId || this.draggedId === targetId) return;

                const draggedTask = app.data.find(t => t.id === this.draggedId);
                const targetTask = app.data.find(t => t.id === targetId);

                if (!draggedTask || !targetTask) return;
                if (draggedTask.parentId !== targetTask.parentId) {
                    utils.toast('åªèƒ½åœ¨åŒä¸€å±¤ç´šå…§æ’åº', 'âš ï¸');
                    return;
                }

                const siblings = app.data.filter(t => t.type === 'gantt' && t.parentId === draggedTask.parentId).sort((a,b) => (a.order||0) - (b.order||0));
                const draggedIdx = siblings.findIndex(t => t.id === this.draggedId);
                siblings.splice(draggedIdx, 1); 
                const targetIdx = siblings.findIndex(t => t.id === targetId);
                const insertIdx = this.dragPosition === 'top' ? targetIdx : targetIdx + 1;
                siblings.splice(insertIdx, 0, draggedTask);

                const updates = siblings.map((t, idx) => ({ id: t.id, order: idx }));
                await db.batchUpdateOrders(updates);
                this.draggedId = null;
            }

            handleBarDragStart(e, id, isSummary) {
                if (isSummary) { utils.toast('æ‘˜è¦ä»»å‹™ç”±å­ä»»å‹™æ±ºå®š', 'ğŸ”’'); return; }
                e.preventDefault(); e.stopPropagation(); 
                const task = app.data.find(t => t.id === id);
                if (!task) return;

                const barEl = e.currentTarget;
                const startX = e.pageX;
                let isDragging = false;
                barEl.style.cursor = 'grabbing';
                barEl.style.transition = 'none';

                const moveHandler = (e) => {
                    const diff = e.pageX - startX;
                    if (Math.abs(diff) > 5) isDragging = true;
                    barEl.style.transform = `translateX(${diff}px)`;
                };

                const upHandler = async (e) => {
                    document.removeEventListener('mousemove', moveHandler);
                    document.removeEventListener('mouseup', upHandler);
                    barEl.style.cursor = 'grab';
                    barEl.style.transition = ''; 
                    barEl.style.transform = ''; 

                    if (!isDragging) {
                        window.app.handlers.edit('gantt', id);
                    } else {
                        const diff = e.pageX - startX;
                        const daysDiff = Math.round(diff / this.zoom);
                        if (daysDiff !== 0) {
                            const newStart = utils.addDays(task.start, daysDiff);
                            await db.update(id, { start: newStart });
                            utils.toast(`å·²ç§»å‹•è‡³ ${newStart}`);
                        }
                    }
                };
                document.addEventListener('mousemove', moveHandler);
                document.addEventListener('mouseup', upHandler);
            }

            processTasks(tasks) {
                const taskMap = new Map();
                tasks.forEach(t => taskMap.set(t.id, { ...t, children: [] }));

                const roots = [];
                tasks.forEach(t => {
                    const task = taskMap.get(t.id);
                    if (t.parentId && taskMap.has(t.parentId)) {
                        taskMap.get(t.parentId).children.push(task);
                    } else {
                        roots.push(task);
                    }
                });

                const sortFn = (a, b) => (a.order || 0) - (b.order || 0);
                const flatList = [];
                
                const processNode = (node, level, prefix) => {
                    node.wbs = prefix; 

                    if (node.children.length > 0) {
                        node.children.sort(sortFn);
                        // Calculate Parent Dates
                        const activeChildren = node.children.filter(c => !c.suspended);
                        const childTimes = activeChildren.map(c => {
                            const start = new Date(c.start);
                            const endStr = utils.addWorkingDays(c.start, c.duration);
                            return { start: start.getTime(), end: new Date(endStr).getTime() };
                        }).filter(t => !isNaN(t.start));
                        
                        if (childTimes.length) {
                            node.start = new Date(Math.min(...childTimes.map(t => t.start))).toISOString().split('T')[0];
                            const endDateStr = new Date(Math.max(...childTimes.map(t => t.end))).toISOString().split('T')[0];
                            node.duration = utils.countWorkingDays(node.start, endDateStr);
                            
                            let totalDur = 0, weightedProg = 0;
                            activeChildren.forEach(c => {
                                const dur = parseInt(c.duration)||1;
                                totalDur += dur;
                                weightedProg += dur * (parseInt(c.progress)||0);
                            });
                            node.progress = totalDur ? Math.round(weightedProg / totalDur) : 0;
                        }
                        node.isSummary = true;
                    }

                    node.endDate = utils.addWorkingDays(node.start, node.duration);
                    if (this.hideCompleted && parseInt(node.progress) === 100) return;

                    flatList.push({ ...node, level });
                    
                    // Logic for Collapse/Expand
                    if (!this.collapsedRows.has(node.id)) {
                        node.children.forEach((c, i) => processNode(c, level + 1, `${prefix}.${i + 1}`));
                    }
                };

                roots.sort(sortFn).forEach((root, i) => processNode(root, 0, (i + 1).toString()));
                return flatList;
            }

            render(allTasks) {
                const container = utils.$('#view-gantt');
                const assignees = [...new Set(allTasks.map(t => t.assignee).filter(Boolean))].sort();
                
                let filteredTasks = [...allTasks];
                if (this.filterAssignee) {
                    filteredTasks = filteredTasks.filter(t => t.assignee === this.filterAssignee);
                }

                const displayTasks = this.processTasks(filteredTasks);
                const today = new Date();
                const viewStart = new Date(this.viewStart);
                
                // Timeline Generation
                let headerTimeline = '';
                let timelinePixelWidth = 0;
                const timelineDays = [];

                // Filter visible days based on weekend setting
                for(let i=0; i<this.daysToShow; i++) {
                    const d = new Date(viewStart); d.setDate(d.getDate() + i);
                    const dayOfWeek = d.getDay();
                    const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
                    
                    if (this.hideWeekends && isWeekend) continue; // Skip rendering
                    
                    timelineDays.push({ date: d, isWeekend });
                }
                
                timelinePixelWidth = timelineDays.length * this.zoom;
                container.style.setProperty('--timeline-width', `${timelinePixelWidth}px`);
                this.updateLayout();

                timelineDays.forEach((dayData) => {
                    const d = dayData.date;
                    const isToday = d.toDateString() === today.toDateString();
                    const dayLabel = d.getDate();
                    const weekday = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][d.getDay()];

                    headerTimeline += `
                        <div class="gantt-timeline-cell ${dayData.isWeekend ? 'weekend' : ''} ${isToday ? 'bg-red-50/50' : ''}" style="width:${this.zoom}px">
                            <div class="text-xs leading-tight pt-2 ${isToday ? 'text-red-600 font-bold' : 'text-slate-500 font-medium'}">${weekday}</div>
                            <div class="text-base font-bold ${isToday ? 'text-red-600' : 'text-slate-700'}">${dayLabel}</div>
                            ${isToday ? `<div class="today-label">Today</div><div class="today-line"></div>` : ''}
                        </div>`;
                });

                // èª¿æ•´å¾Œçš„ Grid Template
                const gridTemplate = `60px var(--name-width) 90px 90px 60px 80px ${this.showProgressCol ? '70px' : '0px'}`;
                let rowsHTML = '';

                if(!displayTasks.length) {
                    rowsHTML = `<div class="p-16 text-center text-slate-400 font-bold col-span-2 bg-white m-4 rounded-lg border-2 border-dashed border-slate-200 text-lg">
                        <i class="ph ph-calendar-slash text-5xl mb-2"></i><br>ç›®å‰æœŸé–“ç„¡æ’ç¨‹
                    </div>`;
                } else {
                    displayTasks.forEach(t => {
                        // Calculate position based on visible days (ignoring weekends if hidden)
                        const start = new Date(t.start);
                        const end = new Date(t.endDate);
                        
                        let leftOffsetDays = 0;
                        let durationDays = 0;

                        // Calculate exact placement skipping hidden weekends
                        const dLoop = new Date(viewStart);
                        // Find start index relative to viewStart
                        let foundStart = false;
                        let startIndex = -1;
                        let endIndex = -1;

                        // Loop through visible days to find start and length
                        for(let i=0; i<timelineDays.length; i++) {
                            const currentDayStr = timelineDays[i].date.toDateString();
                            if(currentDayStr === start.toDateString()) startIndex = i;
                            if(currentDayStr === end.toDateString()) endIndex = i;
                            
                            if (start < timelineDays[i].date && startIndex === -1) startIndex = i; // Task started before view
                        }

                        // Handling tasks outside view
                        if (startIndex === -1 && end < timelineDays[0].date) return; // Completely before
                        if (start > timelineDays[timelineDays.length-1].date) return; // Completely after

                        const effectiveStartIdx = startIndex === -1 ? 0 : startIndex;
                        
                        // Calculate width
                        // If end index is found, width is diff. If not, it goes off screen.
                        let widthInUnits = 0;
                        
                        // Simple logic for bar width based on visual days
                         // We need to iterate days to calculate pixel width correctly if skipping weekends
                        let visualDuration = 0;
                        let renderLeft = -1;
                        
                        // Logic: Scan timelineDays
                        timelineDays.forEach((td, idx) => {
                             if (td.date >= start && renderLeft === -1) renderLeft = idx;
                             if (td.date >= start && td.date <= end) visualDuration++;
                        });

                        if (renderLeft === -1) {
                            // Started before view
                            if (end >= timelineDays[0].date) {
                                renderLeft = 0;
                            } else return; // Should be caught above
                        }

                        const left = renderLeft * this.zoom;
                        const width = Math.max(1, visualDuration) * this.zoom;

                        const isOverdue = t.progress < 100 && new Date(t.endDate) < today && !t.isSummary && !t.suspended;
                        
                        // Styles
                        let barColor = 'bg-indigo-600';
                        if (t.isSummary) barColor = 'bg-slate-600';
                        else if (t.progress == 100) barColor = 'bg-emerald-500';
                        else if (isOverdue) barColor = 'bg-rose-500';
                        
                        if (t.isSummary) barColor = 'is-parent'; // Class handle

                        let barHTML = '';
                        if (!t.suspended && width > 0) {
                            barHTML = `
                                <div class="gantt-bar ${barColor} group-hover:shadow-md"
                                     style="left:${left}px; width:${width - 6}px;"
                                     onmousedown="window.app.gantt.handleBarDragStart(event, '${t.id}', ${!!t.isSummary})">
                                    
                                    ${!t.isSummary ? `
                                        <div class="h-full bg-white/20 absolute left-0 top-0 bottom-0" style="width:${t.progress}%"></div>
                                        <span class="truncate px-2 relative drop-shadow-md text-xs">${t.progress}%</span>
                                    ` : ''}

                                    ${isOverdue ? '<span class="absolute -right-1 -top-1 w-3 h-3 bg-red-500 rounded-full border-2 border-white animate-pulse"></span>' : ''}
                                    
                                    <!-- Tooltip -->
                                    <div class="gantt-tooltip">
                                        <div class="font-bold text-indigo-200 mb-1 border-b border-indigo-500/30 pb-1 text-sm">${t.name}</div>
                                        <div class="gantt-info-row"><span class="gantt-info-label">é–‹å§‹:</span> <span>${t.start}</span></div>
                                        <div class="gantt-info-row"><span class="gantt-info-label">çµæŸ:</span> <span>${t.endDate}</span></div>
                                        <div class="gantt-info-row"><span class="gantt-info-label">å·¥æœŸ:</span> <span>${t.duration}å¤©</span></div>
                                        <div class="gantt-info-row"><span class="gantt-info-label">è² è²¬:</span> <span>${t.assignee||'-'}</span></div>
                                        <div class="mt-1 pt-1 border-t border-slate-600 text-right ${isOverdue?'text-red-400 font-bold':''}">${isOverdue?'âš  å·²å»¶é²': (t.progress==100?'âœ” å·²å®Œæˆ':'âš¡ é€²è¡Œä¸­')}</div>
                                    </div>
                                </div>
                            `;
                        }

                        const indent = t.level * 18;
                        const isCollapsed = this.collapsedRows.has(t.id);
                        
                        rowsHTML += `
                        <div class="contents group hover:bg-slate-50">
                            <!-- Left Grid -->
                            <div class="gantt-row grid bg-white items-center sticky-left ${t.isSummary ? 'is-parent-row' : ''}" 
                                 style="grid-template-columns: ${gridTemplate};"
                                 draggable="true"
                                 ondragstart="window.app.gantt.handleDragStart(event, '${t.id}')"
                                 ondragover="window.app.gantt.handleDragOver(event, '${t.id}')"
                                 ondrop="window.app.gantt.handleDrop(event, '${t.id}')">
                                
                                <div class="px-2 text-sm text-center font-bold text-slate-400 h-full flex items-center justify-center gantt-cell-border draggable-handle cursor-grab">
                                    <i class="ph-bold ph-dots-six-vertical text-lg"></i>
                                </div>
                                
                                <div class="px-2 gantt-cell-border flex items-center h-full overflow-hidden relative">
                                    <div style="width:${indent}px" class="flex-shrink-0"></div>
                                    ${t.isSummary ? `
                                        <div onclick="window.app.gantt.toggleCollapse('${t.id}')" class="collapse-arrow mr-1 ${isCollapsed?'collapsed':''}">
                                            <i class="ph-bold ph-caret-down text-slate-500"></i>
                                        </div>
                                    ` : '<div class="w-6"></div>'}
                                    
                                    <div class="truncate flex-1 cursor-pointer hover:text-indigo-600 transition-colors py-2" onclick="window.app.handlers.edit('gantt', '${t.id}')" title="${t.name}">
                                        <span class="${t.isSummary ? 'text-slate-800' : 'text-slate-600 font-medium'} text-sm font-bold">${t.name}</span>
                                    </div>
                                    ${t.suspended ? '<i class="ph-fill ph-pause-circle text-red-500 ml-1 text-lg"></i>' : ''}
                                    <div class="col-resizer" onmousedown="window.app.gantt.startResize(event)"></div>
                                </div>

                                <div class="px-1 text-sm text-center gantt-cell-border text-slate-600 h-full flex items-center justify-center font-mono">${t.suspended ? '-' : t.start.slice(5)}</div>
                                <div class="px-1 text-sm text-center gantt-cell-border text-slate-600 h-full flex items-center justify-center font-mono">${t.suspended ? '-' : (t.endDate ? t.endDate.slice(5) : '-')}</div>
                                <div class="px-1 text-sm text-center gantt-cell-border text-slate-600 h-full flex items-center justify-center font-medium">${t.suspended ? '-' : t.duration}</div>
                                <div class="px-2 text-sm text-center gantt-cell-border truncate text-slate-600 h-full flex items-center justify-center">
                                    ${t.assignee ? `<span class="bg-slate-100 text-slate-700 px-2 py-0.5 rounded border border-slate-200 font-medium">${t.assignee.slice(0,3)}</span>` : '-'}
                                </div>
                                ${this.showProgressCol ? `
                                <div class="px-2 text-xs text-center flex items-center justify-center gantt-cell-border h-full">
                                    <div class="w-full bg-gray-200 rounded-full h-2 overflow-hidden">
                                        <div class="h-2 rounded-full ${t.progress==100?'bg-emerald-500':'bg-indigo-500'}" style="width:${t.progress}%"></div>
                                    </div>
                                </div>` : ''}
                            </div>
                            
                            <!-- Timeline Row -->
                            <div class="relative h-[48px] border-b border-slate-100 bg-white group-hover:bg-slate-50/50 gantt-timeline-row">
                                ${timelineDays.map((td, i) => {
                                    const isT = td.date.toDateString() === today.toDateString();
                                    return `<div class="absolute top-0 bottom-0 border-r border-slate-100/50 ${td.isWeekend ? 'weekend' : ''} ${isT ? 'bg-red-50/20' : ''}" style="left:${i * this.zoom}px; width:${this.zoom}px; z-index: 0;"></div>`
                                }).join('')}
                                ${barHTML}
                            </div>
                        </div>`;
                    });
                }

                container.innerHTML = `
                    <div class="flex flex-col h-full bg-white rounded-lg shadow-sm border border-slate-200 overflow-hidden">
                        <!-- Toolbar -->
                        <div class="p-3 border-b border-slate-200 bg-white flex flex-wrap gap-3 items-center justify-between no-print flex-shrink-0 z-40">
                            <div class="flex items-center gap-4">
                                <div class="flex items-center gap-1 bg-slate-100 rounded-lg p-1 border border-slate-200">
                                    <button onclick="window.app.gantt.setView('prev')" class="w-8 h-8 flex items-center justify-center text-slate-600 hover:bg-white hover:shadow rounded transition-all"><i class="ph-bold ph-caret-left text-lg"></i></button>
                                    <button onclick="window.app.gantt.setView('today')" class="px-3 h-8 text-sm font-bold text-indigo-600 hover:bg-white hover:shadow rounded transition-all flex items-center gap-1"><i class="ph-bold ph-calendar text-lg"></i> ä»Šå¤©</button>
                                    <input type="date" id="gantt-date-picker" onchange="window.app.gantt.setView('date', this.value)" class="h-8 bg-transparent border-0 text-sm font-medium text-slate-600 focus:ring-0 w-[120px]" title="è·³è½‰æ—¥æœŸ">
                                    <button onclick="window.app.gantt.setView('next')" class="w-8 h-8 flex items-center justify-center text-slate-600 hover:bg-white hover:shadow rounded transition-all"><i class="ph-bold ph-caret-right text-lg"></i></button>
                                </div>
                                <div class="flex items-center gap-1 text-slate-500 px-2 py-1">
                                    <button onclick="window.app.gantt.setZoom(-10)" class="w-8 h-8 flex items-center justify-center rounded hover:bg-slate-100 text-lg" title="ç¸®å°"><i class="ph ph-minus"></i></button>
                                    <i class="ph ph-magnifying-glass text-lg"></i>
                                    <button onclick="window.app.gantt.setZoom(10)" class="w-8 h-8 flex items-center justify-center rounded hover:bg-slate-100 text-lg" title="æ”¾å¤§"><i class="ph ph-plus"></i></button>
                                </div>
                                <div class="h-6 w-px bg-slate-200 mx-1"></div>
                                <div class="flex items-center gap-4 text-sm font-medium text-slate-600">
                                    <label class="flex items-center gap-1.5 cursor-pointer hover:text-slate-800">
                                        <input type="checkbox" onchange="window.app.gantt.toggleCompleted(this.checked)" ${this.hideCompleted?'checked':''} class="rounded text-indigo-600 focus:ring-indigo-500 border-slate-300 w-4 h-4">
                                        éš±è—å·²å®Œæˆ
                                    </label>
                                    <label class="flex items-center gap-1.5 cursor-pointer hover:text-slate-800">
                                        <input type="checkbox" onchange="window.app.gantt.toggleWeekends(this.checked)" ${this.hideWeekends?'checked':''} class="rounded text-indigo-600 focus:ring-indigo-500 border-slate-300 w-4 h-4">
                                        éš±è—é€±æœ«
                                    </label>
                                    <label class="flex items-center gap-1.5 cursor-pointer hover:text-slate-800">
                                        <input type="checkbox" onchange="window.app.gantt.toggleProgressCol(this.checked)" ${this.showProgressCol?'checked':''} class="rounded text-indigo-600 focus:ring-indigo-500 border-slate-300 w-4 h-4">
                                        é€²åº¦æ¬„
                                    </label>
                                </div>
                            </div>
                            
                            <div class="flex items-center gap-3">
                                <div class="relative">
                                    <select onchange="window.app.gantt.setFilter(this.value)" class="pl-9 pr-3 py-2 text-sm border border-slate-300 rounded-md bg-white focus:ring-2 focus:ring-indigo-500 outline-none font-medium text-slate-700 shadow-sm">
                                        <option value="">æ‰€æœ‰äººå“¡</option>
                                        ${assignees.map(p => `<option value="${p}" ${this.filterAssignee===p?'selected':''}>${p}</option>`).join('')}
                                    </select>
                                    <i class="ph-bold ph-user absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-lg"></i>
                                </div>
                                <button onclick="window.print()" class="flex items-center gap-1.5 bg-slate-800 text-white px-4 py-2 rounded-md text-sm hover:bg-slate-700 transition-colors shadow font-bold">
                                    <i class="ph-bold ph-printer text-lg"></i> åˆ—å°
                                </button>
                            </div>
                        </div>

                        <div class="gantt-container bg-white custom-scrollbar">
                            <div class="gantt-grid-layout">
                                <div class="sticky-corner h-14 grid divide-x divide-slate-200 bg-slate-50 z-40 border-b border-slate-200" style="grid-template-columns: ${gridTemplate};">
                                    <div class="flex items-center justify-center text-sm font-bold text-slate-600">WBS</div>
                                    <div class="flex items-center justify-center text-sm font-bold text-slate-600 header-cell-resizable relative">
                                        ä»»å‹™åç¨±
                                        <div class="col-resizer" onmousedown="window.app.gantt.startResize(event)"></div>
                                    </div>
                                    <div class="flex items-center justify-center text-sm font-bold text-slate-600">é–‹å§‹</div>
                                    <div class="flex items-center justify-center text-sm font-bold text-slate-600">çµæŸ</div>
                                    <div class="flex items-center justify-center text-sm font-bold text-slate-600">å¤©æ•¸</div>
                                    <div class="flex items-center justify-center text-sm font-bold text-slate-600">è² è²¬</div>
                                    ${this.showProgressCol ? '<div class="flex items-center justify-center text-sm font-bold text-slate-600">é€²åº¦</div>' : ''}
                                </div>
                                <div class="sticky-header h-14 flex relative overflow-hidden bg-white z-30 border-b border-slate-200">
                                    ${headerTimeline}
                                </div>
                                ${rowsHTML}
                            </div>
                        </div>
                    </div>
                `;
                
                // Set Date picker initial value if not set
                setTimeout(() => {
                    const picker = utils.$('#gantt-date-picker');
                    if(picker && !picker.value) {
                         const d = new Date(this.viewStart);
                         d.setDate(d.getDate() + 2);
                         picker.value = utils.date(d);
                    }
                }, 0);
            }
        }

        // --- Application Logic ---
        const app = {
            data: [],
            currentTab: 'todo',
            gantt: new GanttManager(),
            
            init() {
                db.init().then(() => {
                    db.sub(data => {
                        this.data = data;
                        utils.$('#loading').classList.add('opacity-0');
                        setTimeout(() => utils.$('#loading').classList.add('hidden'), 500);
                        this.render();
                    });
                });
                
                window.app = this;
                this.handlers = {
                    del: async (id) => {
                        const success = await db.del(id);
                        if(success) window.modal.close();
                    },
                    edit: (type, id) => this.openEditModal(type, id),
                    toGantt: (id) => this.addToGantt(id),
                    save: async (id, type) => {
                        const form = utils.$('#edit-form');
                        const payload = Object.fromEntries(new FormData(form));
                        
                        // Data Types & Defaults
                        if(type === 'gantt') {
                            payload.duration = parseInt(payload.duration) || 1;
                            payload.progress = parseInt(payload.progress) || 0;
                            payload.order = parseInt(payload.order) || 0;
                            if (payload.parentId === "") payload.parentId = null;
                            const suspendedEl = form.querySelector('[name=suspended]');
                            payload.suspended = suspendedEl ? suspendedEl.checked : false;
                        }
                        if(type==='todo') { 
                            const el = form.querySelector('[name=completed]');
                            payload.completed = el ? el.checked : false; 
                        }
                        if(type==='event') { 
                            const el = form.querySelector('[name=closed]');
                            payload.closed = el ? el.checked : false; 
                        }
                        
                        try {
                            id ? await db.update(id, payload) : await db.add({ type, ...payload });
                            window.modal.close();
                        } catch(e) {
                            console.error(e);
                            utils.toast('å„²å­˜å¤±æ•—ï¼Œè«‹æª¢æŸ¥æ¬Šé™', 'âŒ');
                        }
                    }
                };
            },

            switchTab(tab) {
                this.currentTab = tab;
                document.querySelectorAll('.nav-btn').forEach(b => {
                    b.classList.remove('bg-slate-800', 'text-white', 'shadow-lg');
                    b.classList.add('text-slate-300', 'hover:bg-slate-800', 'hover:text-white');
                });
                const activeBtn = utils.$(`button[data-tab="${tab}"]`);
                activeBtn.classList.add('bg-slate-800', 'text-white', 'shadow-lg');
                activeBtn.classList.remove('text-slate-300');
                
                utils.$('#page-title').innerHTML = `<span class="w-1.5 h-7 bg-indigo-500 rounded-full"></span>${activeBtn.textContent.trim()}`;
                
                const actions = utils.$('#header-actions');
                const btnClass = "bg-indigo-600 text-white px-5 py-2.5 rounded-lg hover:bg-indigo-700 shadow-md hover:shadow-lg transition-all flex items-center gap-2 text-base font-bold";
                actions.innerHTML = tab === 'gantt' 
                    ? `<button onclick="window.app.openEditModal('gantt')" class="${btnClass}"><i class="ph-bold ph-plus text-lg"></i> æ–°å¢ä»»å‹™</button>`
                    : `<button onclick="window.app.openEditModal('${tab}')" class="${btnClass}"><i class="ph-bold ph-plus text-lg"></i> æ–°å¢é …ç›®</button>`;
                this.render();
            },

            render() {
                document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
                const view = utils.$(`#view-${this.currentTab}`);
                view.classList.remove('hidden');
                const items = this.data.filter(i => i.type === this.currentTab);
                
                if (['todo', 'event', 'feedback'].includes(this.currentTab)) {
                    view.innerHTML = renderer.table(items, CONFIG.cols[this.currentTab], this.currentTab);
                } else if (this.currentTab === 'gantt') {
                    this.gantt.render(items);
                }
            },

            openEditModal(type, id = null) {
                const item = id ? this.data.find(i => i.id === id) : {};
                let fields = [];
                // Field Definitions
                if (type === 'todo') fields = [
                    { label: 'ç”Ÿç”¢ç·¨è™Ÿ', name: 'productionId', val: item.productionId },
                    { label: 'æ–™è™Ÿ', name: 'partNumber', val: item.partNumber },
                    { label: 'ä¿®æ”¹å…§å®¹', name: 'content', type: 'textarea', val: item.content },
                    { label: 'å»ºç«‹æ—¥æœŸ', name: 'date', type: 'date', val: item.date || utils.date() }
                ];
                if (type === 'event') fields = [
                    { label: 'äº‹ä»¶æ—¥æœŸ', name: 'date', type: 'date', val: item.date || utils.date() },
                    { label: 'äº‹é …å…§å®¹', name: 'matter', val: item.matter },
                    { label: 'ç›¸é—œäººå“¡', name: 'personnel', val: item.personnel },
                    { label: 'å„ªå…ˆç¨‹åº¦', name: 'priority', type: 'select', opts: [{v:'high',l:'ğŸ”´ ç·Šæ€¥'},{v:'medium',l:'ğŸŸ  ä¸€èˆ¬'},{v:'low',l:'ğŸŸ¢ ä½'}], val: item.priority || 'medium' }
                ];
                if (type === 'feedback') fields = [
                    { label: 'åé¥‹é¡å‹', name: 'feedbackType', type: 'select', opts: ['ç¡¬é«”','è»Ÿé«”','æµç¨‹','å…¶ä»–'], val: item.feedbackType },
                    { label: 'å•é¡Œæè¿°', name: 'problem', type: 'textarea', val: item.problem },
                    { label: 'è§£æ±ºæ–¹æ¡ˆ', name: 'solution', type: 'textarea', val: item.solution }
                ];
                if (type === 'gantt') {
                    // Fix: Allow deep nesting by removing the '!i.parentId' restriction
                    // Also prevent cycles: a task cannot be its own ancestor
                    const potentialParents = this.data.filter(i => {
                        if (i.type !== 'gantt' || i.id === id) return false;
                        
                        // Prevent Cycle: check if 'id' is an ancestor of 'i'
                        if (id) {
                            let ancestor = i;
                            let safety = 0;
                            while(ancestor.parentId && safety < 100) {
                                if(ancestor.parentId === id) return false; // Cycle detected
                                ancestor = this.data.find(t => t.id === ancestor.parentId);
                                if(!ancestor) break;
                                safety++;
                            }
                        }
                        return true;
                    });

                    const parentOpts = [{v: '', l: 'ç„¡ (è¨­ç‚ºé ‚å±¤ä»»å‹™)'}, ...potentialParents.map(p => ({v: p.id, l: p.name}))];
                    fields = [
                        { label: 'ä»»å‹™åç¨±', name: 'name', val: item.name, placeholder: 'è¼¸å…¥ä»»å‹™åç¨±...' },
                        { label: 'çˆ¶ä»»å‹™ (ç¾¤çµ„)', name: 'parentId', type: 'select', opts: parentOpts, val: item.parentId || '' },
                        { label: 'è² è²¬äºº', name: 'assignee', val: item.assignee, placeholder: 'ä¾‹å¦‚: å°ç‹' },
                        { label: 'é–‹å§‹æ—¥æœŸ', name: 'start', type: 'date', val: item.start || utils.date() },
                        { label: 'å·¥æœŸ (å·¥ä½œå¤©)', name: 'duration', type: 'number', val: item.duration || 1 },
                        { label: 'ç•¶å‰é€²åº¦ (%)', name: 'progress', type: 'number', val: item.progress || 0 },
                        { label: 'æ’åº (è¶Šå°è¶Šå‰)', name: 'order', type: 'number', val: item.order || 0 }
                    ];
                }

                let extraHtml = '';
                if(type === 'todo' && id) extraHtml = `<div class="mt-4 p-4 bg-slate-50 rounded border border-slate-200"><label class="flex items-center gap-3 cursor-pointer"><input type="checkbox" name="completed" ${item.completed?'checked':''} class="w-5 h-5 text-indigo-600 rounded border-slate-300"> <span class="font-bold text-slate-700 text-base">å·²å®Œæˆæ­¤é …ç›®</span></label></div>`;
                if(type === 'event' && id) extraHtml = `<div class="mt-4 p-4 bg-slate-50 rounded border border-slate-200"><label class="flex items-center gap-3 cursor-pointer"><input type="checkbox" name="closed" ${item.closed?'checked':''} class="w-5 h-5 text-indigo-600 rounded border-slate-300"> <span class="font-bold text-slate-700 text-base">æ¨™è¨˜ç‚ºå·²çµæ¡ˆ</span></label></div>`;
                if(type === 'gantt') extraHtml = `<div class="mt-4 p-4 bg-red-50 rounded border border-red-100"><label class="flex items-center gap-3 cursor-pointer"><input type="checkbox" name="suspended" ${item.suspended?'checked':''} class="w-5 h-5 text-red-600 rounded border-slate-300"> <span class="font-bold text-red-700 flex items-center gap-2 text-base"><i class="ph-fill ph-pause"></i> æš«ç·©å¯¦æ–½ (ä¸é¡¯ç¤ºæ–¼æ’ç¨‹)</span></label></div>`;

                const deleteBtn = id ? `<button type="button" onclick="window.app.handlers.del('${id}')" class="px-5 py-2.5 text-red-600 font-bold hover:bg-red-50 rounded-lg transition-colors mr-auto flex items-center gap-2 border border-transparent text-base"><i class="ph-bold ph-trash text-lg"></i> åˆªé™¤</button>` : '';

                window.modal.open(
                    id ? `ç·¨è¼¯${this.getTypeName(type)}` : `æ–°å¢${this.getTypeName(type)}`,
                    `<form id="edit-form">${renderer.form(fields, type)}${extraHtml}</form>`,
                    `${deleteBtn}
                     <button onclick="window.modal.close()" class="px-6 py-3 text-slate-600 font-bold hover:bg-slate-100 rounded-lg transition-colors text-base">å–æ¶ˆ</button>
                     <button onclick="window.app.handlers.save('${id||''}', '${type}')" class="px-6 py-3 bg-indigo-600 text-white font-bold rounded-lg hover:bg-indigo-700 shadow-lg hover:shadow-xl transition-all flex items-center gap-2 text-base"><i class="ph-bold ph-floppy-disk text-lg"></i> å„²å­˜</button>`
                );
            },
            
            getTypeName(type) { return { 'todo': 'å¾…è¾¦', 'event': 'äº‹ä»¶', 'feedback': 'åé¥‹', 'gantt': 'æ’ç¨‹' }[type] || 'é …ç›®'; },

            async addToGantt(eventId) {
                const event = this.data.find(i => i.id === eventId);
                const duration = event.priority === 'high' ? 3 : (event.priority === 'medium' ? 5 : 7);
                await db.add({
                    type: 'gantt', 
                    name: `[${event.priority === 'high' ? 'æ€¥' : 'ä¸€èˆ¬'}] ${event.matter}`, 
                    assignee: event.personnel,
                    start: event.date, 
                    duration: duration, 
                    progress: 0, 
                    order: 99
                });
                utils.toast('âœ… å·²å°‡äº‹ä»¶åŠ å…¥æ’ç¨‹è¡¨');
                this.switchTab('gantt');
            }
        };

        app.init();
    </script>
</body>
</html>
