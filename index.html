<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å·¥å» å”ä½œç®¡ç†ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: { extend: { fontFamily: { sans: ['Noto Sans TC', 'sans-serif'] } } }
        }
    </script>
    <style>
        /* è‡ªå®šç¾©æ»¾å‹•æ¢ */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* ç”˜ç‰¹åœ–ä½ˆå±€è®Šæ•¸ - é è¨­å€¼ï¼Œæœƒè¢« JS è¦†è“‹ */
        :root {
            --name-width: 220px; /* ä»»å‹™åç¨±æ¬„ä½é è¨­å¯¬åº¦ */
            --grid-cols: 560px; /* å·¦å´åˆ—è¡¨ç¸½å¯¬åº¦ (Name + å…¶ä»–å›ºå®šæ¬„ä½) */
            --timeline-width: 1200px;
        }

        /* Gantt Layout */
        .gantt-container { overflow: auto; height: 100%; position: relative; }
        .gantt-grid-layout { 
            display: grid; 
            grid-template-columns: var(--grid-cols) 1fr; 
            min-width: calc(var(--grid-cols) + var(--timeline-width)); 
        }

        /* å‡çµçª—æ ¼ */
        .sticky-left { position: sticky; left: 0; z-index: 20; background: white; border-right: 1px solid #e2e8f0; }
        .sticky-header { position: sticky; top: 0; z-index: 30; background: #f8fafc; border-bottom: 1px solid #e2e8f0; }
        .sticky-corner { position: sticky; left: 0; top: 0; z-index: 40; background: #f8fafc; border-right: 1px solid #e2e8f0; border-bottom: 1px solid #e2e8f0; }

        /* Task Bars */
        .gantt-bar { position: absolute; height: 20px; top: 10px; border-radius: 4px; cursor: pointer; transition: all 0.2s; box-shadow: 0 1px 2px rgba(0,0,0,0.1); font-size: 11px; display: flex; items-center; padding-left: 8px; color: white; overflow: hidden; z-index: 10; white-space: nowrap; }
        .gantt-bar:hover { filter: brightness(110%); transform: translateY(-1px); z-index: 25; box-shadow: 0 4px 6px rgba(0,0,0,0.2); }
        
        /* Parent Task Bar */
        .gantt-bar.is-parent { height: 12px; top: 14px; border-radius: 6px; background: #334155; opacity: 0.95; }
        .gantt-bar.is-parent::before, .gantt-bar.is-parent::after { content: ''; position: absolute; top: 100%; width: 0; height: 0; border-style: solid; }
        .gantt-bar.is-parent::before { left: 0; border-width: 6px 6px 0 0; border-color: #334155 transparent transparent transparent; }
        .gantt-bar.is-parent::after { right: 0; border-width: 6px 0 0 6px; border-color: #334155 transparent transparent transparent; }

        /* Parent Row Styling - Darker Background */
        .gantt-row.is-parent-row { background-color: #e2e8f0 !important; font-weight: 700; color: #1e293b; border-bottom: 1px solid #94a3b8; }
        .gantt-row.is-parent-row:hover { background-color: #cbd5e1 !important; }

        /* Today Marker Styles - Fixed Alignment */
        .today-line { position: absolute; top: 0; bottom: 0; left: 50%; transform: translateX(-50%); width: 2px; background-color: rgba(239, 68, 68, 0.5); z-index: 15; pointer-events: none; }
        .today-label { position: absolute; top: 0; background: #ef4444; color: white; font-size: 10px; padding: 0 4px; border-radius: 0 0 4px 4px; left: 50%; transform: translateX(-50%); z-index: 16; white-space: nowrap; }

        .gantt-row:hover { background-color: #f1f5f9; }
        .gantt-timeline-row:hover { background-color: #f8fafc; }

        /* Column Resizer */
        .col-resizer {
            position: absolute; right: 0; top: 0; bottom: 0; width: 6px;
            cursor: col-resize; z-index: 50; opacity: 0; transition: opacity 0.2s;
        }
        .header-cell-resizable:hover .col-resizer, .col-resizer:hover, .col-resizer.resizing {
            opacity: 1; background: rgba(59, 130, 246, 0.5); /* blue-500 */
        }

        @media print {
            .no-print { display: none !important; }
            .print-show { display: block !important; }
            body { height: auto !important; overflow: visible !important; -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
            .gantt-container { overflow: visible; }
            /* å¼·åˆ¶åˆ—å°èƒŒæ™¯è‰² */
            .gantt-row.is-parent-row { background-color: #e2e8f0 !important; -webkit-print-color-adjust: exact; }
            .gantt-bar { -webkit-print-color-adjust: exact; }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans h-screen flex overflow-hidden">

    <!-- å´é‚Šå°èˆª -->
    <aside class="w-64 bg-slate-800 text-white flex-shrink-0 flex flex-col no-print transition-all duration-300 z-30" id="sidebar">
        <div class="p-6 text-xl font-bold border-b border-slate-700 flex items-center gap-2">
            <span>ğŸ­</span> å·¥å» å”ä½œç³»çµ±
        </div>
        <nav class="flex-1 p-4 space-y-2">
            <button onclick="window.app.switchTab('todo')" class="nav-btn w-full text-left px-4 py-3 rounded hover:bg-slate-700 bg-slate-700 transition-colors" data-tab="todo">ğŸ“‹ å¾…ä¿®æ”¹æ˜ç´°</button>
            <button onclick="window.app.switchTab('event')" class="nav-btn w-full text-left px-4 py-3 rounded hover:bg-slate-700 transition-colors" data-tab="event">ğŸ“… äº‹ä»¶è¿½è¹¤</button>
            <button onclick="window.app.switchTab('feedback')" class="nav-btn w-full text-left px-4 py-3 rounded hover:bg-slate-700 transition-colors" data-tab="feedback">ğŸ’¬ å•é¡Œåé¥‹</button>
            <button onclick="window.app.switchTab('gantt')" class="nav-btn w-full text-left px-4 py-3 rounded hover:bg-slate-700 transition-colors" data-tab="gantt">ğŸ“Š å‘¨è¨ˆç•«æ’ç¨‹</button>
        </nav>
        <div class="p-4 text-xs text-slate-400 border-t border-slate-700" id="auth-status">é€£ç·šä¸­...</div>
    </aside>

    <!-- ä¸»å…§å®¹å€ -->
    <main class="flex-1 flex flex-col min-w-0 bg-white relative">
        <!-- é ‚éƒ¨å·¥å…·åˆ— -->
        <header class="h-16 border-b flex items-center justify-between px-6 bg-white no-print flex-shrink-0 z-20 shadow-sm">
            <h1 id="page-title" class="text-2xl font-bold text-slate-800">å¾…ä¿®æ”¹æ˜ç´°</h1>
            <div class="flex gap-2" id="header-actions">
                <!-- å‹•æ…‹æ³¨å…¥æŒ‰éˆ• -->
            </div>
        </header>

        <!-- å…§å®¹å®¹å™¨ -->
        <div id="app-container" class="flex-1 overflow-hidden relative bg-gray-50 flex flex-col">
            <!-- Loading -->
            <div id="loading" class="absolute inset-0 flex items-center justify-center bg-white/80 z-50 backdrop-blur-sm">
                <div class="flex flex-col items-center">
                    <div class="animate-spin rounded-full h-12 w-12 border-4 border-indigo-200 border-t-indigo-600 mb-3"></div>
                    <div class="text-indigo-600 font-medium animate-pulse">è³‡æ–™è¼‰å…¥ä¸­...</div>
                </div>
            </div>

            <!-- Views -->
            <div id="view-todo" class="view-section space-y-4 hidden p-6 overflow-auto h-full"></div>
            <div id="view-event" class="view-section space-y-4 hidden p-6 overflow-auto h-full"></div>
            <div id="view-feedback" class="view-section space-y-4 hidden p-6 overflow-auto h-full"></div>
            <!-- Gantt View (no padding to maximize space) -->
            <div id="view-gantt" class="view-section hidden h-full flex flex-col"></div>
        </div>
    </main>

    <!-- çµ±ä¸€ Modal -->
    <div id="uni-modal" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center p-4 no-print backdrop-blur-sm transition-opacity">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col transform transition-transform scale-100">
            <div class="p-5 border-b flex justify-between items-center bg-gray-50 rounded-t-xl">
                <h3 id="modal-title" class="text-xl font-bold text-gray-800"></h3>
                <button onclick="window.modal.close()" class="text-gray-400 hover:text-red-500 text-2xl w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-200 transition-colors">&times;</button>
            </div>
            <div id="modal-body" class="p-6 overflow-y-auto"></div>
            <div id="modal-footer" class="p-4 border-t flex justify-end gap-3 bg-gray-50 rounded-b-xl"></div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-6 right-6 bg-slate-800 text-white px-6 py-4 rounded-lg shadow-xl transform translate-y-32 transition-transform duration-300 z-50 flex items-center gap-3">
        <span id="toast-icon">âœ…</span>
        <span id="toast-msg" class="font-medium">Notification</span>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, serverTimestamp, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Config & Utils ---
        const CONFIG = {
            firebase: JSON.parse(`{"apiKey":"AIzaSyA7IeOz4EJ-yMUccDTPOSaDm33fLChVD8Q","authDomain":"sunyu-check.firebaseapp.com","projectId":"sunyu-check","storageBucket":"sunyu-check.appspot.com","messagingSenderId":"627211744361","appId":"1:627211744361:web:58bce4b5009f0c9d5bdef8"}`),
            appId: "sunyu-check",
            cols: {
                todo: [
                    { k: 'status', l: 'ç‹€æ…‹', w: '100px', render: r => r.completed ? '<span class="px-2 py-1 rounded text-xs font-medium bg-gray-100 text-gray-600 border border-gray-200">å·²å®Œæˆ</span>' : '<span class="px-2 py-1 rounded text-xs font-medium bg-blue-50 text-blue-600 border border-blue-100">å¾…è™•ç†</span>' },
                    { k: 'productionId', l: 'ç”Ÿç”¢ç·¨è™Ÿ', w: '120px' }, 
                    { k: 'partNumber', l: 'æ–™è™Ÿ', w: '120px' }, 
                    { k: 'content', l: 'ä¿®æ”¹å…§å®¹', w: 'auto' },
                    { k: 'date', l: 'æ—¥æœŸ', w: '120px' },
                    { k: 'actions', l: 'æ“ä½œ', type: 'actions', w: '140px' }
                ],
                event: [
                    { k: 'priority', l: 'å„ªå…ˆ', w: '80px', render: r => `<div class="flex justify-center"><span class="w-6 h-6 rounded-full flex items-center justify-center text-white text-xs font-bold shadow-sm ${r.priority==='high'?'bg-red-500 ring-2 ring-red-100':r.priority==='low'?'bg-green-500 ring-2 ring-green-100':'bg-amber-400 ring-2 ring-amber-100'}">${r.priority==='high'?'1':r.priority==='low'?'3':'2'}</span></div>` },
                    { k: 'date', l: 'æ—¥æœŸ', w: '120px' }, 
                    { k: 'matter', l: 'äº‹é …å…§å®¹', w: 'auto' }, 
                    { k: 'personnel', l: 'ç›¸é—œäººå“¡', w: '150px' },
                    { k: 'closed', l: 'ç‹€æ…‹', w: '100px', render: r => r.closed ? '<span class="text-gray-400 font-medium">âœ… å·²çµæ¡ˆ</span>' : '<span class="text-emerald-600 font-medium">âš¡ é€²è¡Œä¸­</span>' },
                    { k: 'actions', l: 'æ“ä½œ', type: 'actions', w: '180px' }
                ],
                feedback: [
                    { k: 'feedbackType', l: 'é¡å‹', w: '120px', render: r => `<span class="px-2 py-1 rounded text-xs bg-slate-100 text-slate-700 font-medium">${r.feedbackType}</span>` }, 
                    { k: 'problem', l: 'å•é¡Œæè¿°', w: '40%' }, 
                    { k: 'solution', l: 'è§£æ±ºæ–¹æ¡ˆ', w: 'auto' },
                    { k: 'status', l: 'ç‹€æ…‹', w: '100px', render: r => r.status === 'å·²çµæ¡ˆ' ? '<span class="text-green-600">å·²çµæ¡ˆ</span>' : '<span class="text-amber-500">è™•ç†ä¸­</span>' }, 
                    { k: 'actions', l: 'æ“ä½œ', type: 'actions', w: '100px' }
                ]
            }
        };

        const utils = {
            $: (s) => document.querySelector(s),
            date: (d = new Date()) => d.toISOString().split('T')[0],
            toast: (msg, icon='âœ…') => {
                const t = utils.$('#toast'); 
                utils.$('#toast-msg').textContent = msg;
                utils.$('#toast-icon').textContent = icon;
                t.classList.remove('translate-y-32');
                setTimeout(() => t.classList.add('translate-y-32'), 3000);
            },
            badge: 'px-2 py-1 rounded text-xs font-medium',
            // æ–°å¢ï¼šè¨ˆç®—å·¥ä½œæ—¥å¾Œçš„çµæŸæ—¥æœŸ
            addWorkingDays: (startDateStr, days) => {
                if (!startDateStr || !days) return '-';
                let current = new Date(startDateStr);
                let remaining = parseInt(days);
                
                let resultDate = new Date(current);
                
                while (remaining > 0) {
                    const day = current.getDay();
                    if (day !== 0 && day !== 6) { // 0=Sun, 6=Sat
                        remaining--;
                    }
                    if (remaining > 0) {
                        current.setDate(current.getDate() + 1);
                    }
                }
                return current.toISOString().split('T')[0];
            },
            // æ–°å¢ï¼šè¨ˆç®—å…©å€‹æ—¥æœŸä¹‹é–“çš„å·¥ä½œæ—¥å¤©æ•¸
            countWorkingDays: (startStr, endStr) => {
                let start = new Date(startStr);
                let end = new Date(endStr);
                let count = 0;
                let cur = new Date(start);
                while(cur <= end) {
                    const day = cur.getDay();
                    if(day !== 0 && day !== 6) count++;
                    cur.setDate(cur.getDate() + 1);
                }
                return count;
            }
        };

        // --- Firebase Service ---
        class FirestoreService {
            constructor() {
                const app = initializeApp(CONFIG.firebase);
                this.auth = getAuth(app);
                this.db = getFirestore(app);
                this.coll = collection(this.db, `/artifacts/${CONFIG.appId}/public/data/sharedTodoItems`);
                this.user = null;
            }
            async init() {
                return new Promise(resolve => {
                    onAuthStateChanged(this.auth, async (u) => {
                        this.user = u || await signInAnonymously(this.auth).then(c => c.user);
                        utils.$('#auth-status').textContent = `ä½¿ç”¨è€… ID: ${this.user.uid.slice(0,6)}...`;
                        resolve(this.user);
                    });
                });
            }
            sub(cb) {
                return onSnapshot(query(this.coll, orderBy("createdAt", "desc")), (snap) => {
                    const data = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    cb(data);
                });
            }
            async add(data) { await addDoc(this.coll, { ...data, createdAt: serverTimestamp() }); utils.toast('æ–°å¢æˆåŠŸ'); }
            async update(id, data) { await updateDoc(doc(this.coll, id), data); utils.toast('æ›´æ–°æˆåŠŸ'); }
            async del(id) { if(confirm('ç¢ºå®šè¦åˆªé™¤æ­¤é …ç›®å—ï¼Ÿå¦‚æœé€™æ˜¯çˆ¶ä»»å‹™ï¼Œå»ºè­°å…ˆç§»é™¤å­ä»»å‹™çš„é—œè¯ã€‚')) { await deleteDoc(doc(this.coll, id)); utils.toast('å·²åˆªé™¤', 'ğŸ—‘ï¸'); } }
        }
        const db = new FirestoreService();

        // --- UI Components ---
        const modal = {
            el: utils.$('#uni-modal'),
            open(title, bodyHtml, footerHtml = '') {
                utils.$('#modal-title').textContent = title;
                utils.$('#modal-body').innerHTML = bodyHtml;
                utils.$('#modal-footer').innerHTML = footerHtml;
                this.el.classList.remove('hidden');
                this.el.classList.add('flex');
                setTimeout(() => utils.$('#uni-modal > div').classList.remove('scale-95', 'opacity-0'), 10);
            },
            close() { 
                utils.$('#uni-modal > div').classList.add('scale-95', 'opacity-0');
                setTimeout(() => {
                    this.el.classList.add('hidden'); 
                    this.el.classList.remove('flex');
                }, 200);
            }
        };
        // Expose modal globally so inline onclick works
        window.modal = modal;

        const renderer = {
            table(items, cols, type) {
                if (!items.length) return `
                    <div class="flex flex-col items-center justify-center py-16 bg-white rounded-lg border border-dashed border-gray-300">
                        <div class="text-4xl mb-3">ğŸ“­</div>
                        <div class="text-gray-400">ç›®å‰å°šç„¡è³‡æ–™</div>
                    </div>`;
                return `
                <div class="overflow-x-auto border rounded-lg shadow-sm bg-white">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50"><tr>${cols.map(c => `<th class="px-6 py-4 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">${c.l}</th>`).join('')}</tr></thead>
                        <tbody class="divide-y divide-gray-200 bg-white">
                            ${items.map(item => `
                                <tr class="hover:bg-indigo-50/30 transition-colors group">
                                    ${cols.map(c => {
                                        if (c.type === 'actions') return `
                                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium opacity-0 group-hover:opacity-100 transition-opacity">
                                                <div class="flex items-center gap-3">
                                                    <button onclick="window.app.handlers.edit('${type}', '${item.id}')" class="text-indigo-600 hover:text-indigo-900 flex items-center gap-1"><span class="text-lg">âœ</span> ç·¨è¼¯</button>
                                                    <button onclick="window.app.handlers.del('${item.id}')" class="text-red-600 hover:text-red-900 flex items-center gap-1"><span class="text-lg">Ã—</span> åˆªé™¤</button>
                                                    ${type === 'event' ? `<button onclick="window.app.handlers.toGantt('${item.id}')" class="text-blue-600 hover:text-blue-800 ml-2 font-bold bg-blue-50 px-2 py-1 rounded">ï¼‹æ’ç¨‹</button>` : ''}
                                                </div>
                                            </td>`;
                                        return `<td class="px-6 py-4 text-sm text-gray-700" style="${c.w ? `min-width:${c.w}`:''}">${c.render ? c.render(item) : (item[c.k] || '-')}</td>`;
                                    }).join('')}
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>`;
            },
            form(fields, type) {
                return fields.map(f => `
                    <div class="mb-5">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">${f.label}</label>
                        ${f.type === 'select' 
                            ? `<div class="relative"><select name="${f.name}" class="w-full border border-gray-300 rounded-lg p-2.5 bg-white focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none appearance-none">${f.opts.map(o => {
                                const val = typeof o === 'object' ? o.v : o;
                                const lbl = typeof o === 'object' ? o.l : o;
                                return `<option value="${val}" ${f.val == val ? 'selected' : ''}>${lbl}</option>`;
                            }).join('')}</select><div class="absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none text-gray-500">â–¼</div></div>`
                            : f.type === 'textarea' 
                                ? `<textarea name="${f.name}" rows="4" class="w-full border border-gray-300 rounded-lg p-2.5 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none" placeholder="è«‹è¼¸å…¥${f.label}...">${f.val||''}</textarea>`
                                : `<input type="${f.type||'text'}" name="${f.name}" class="w-full border border-gray-300 rounded-lg p-2.5 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none" value="${f.val||''}" placeholder="${f.placeholder||''}">`
                        }
                    </div>
                `).join('');
            }
        };

        // --- Enhanced Gantt Manager ---
        class GanttManager {
            constructor() {
                this.zoom = 40; // px per day
                this.viewStart = new Date();
                this.viewStart.setDate(this.viewStart.getDate() - 3); 
                this.daysToShow = 45; // Default show
                this.filterAssignee = '';
                this.hideCompleted = false;
                this.showProgressCol = true;
                
                // Column resizing state
                this.nameColWidth = 180; // Default width
                this.isResizing = false;
            }

            setView(mode) {
                const d = new Date(this.viewStart);
                if (mode === 'prev') d.setDate(d.getDate() - 7);
                if (mode === 'next') d.setDate(d.getDate() + 7);
                if (mode === 'today') {
                    const now = new Date();
                    now.setDate(now.getDate() - 2); 
                    this.viewStart = now;
                    app.render();
                    return;
                }
                this.viewStart = d;
                app.render();
            }

            setZoom(delta) {
                const oldZoom = this.zoom;
                this.zoom = Math.max(20, Math.min(100, this.zoom + delta));
                if (this.zoom < oldZoom) {
                    this.daysToShow += 5;
                } else {
                    this.daysToShow = Math.max(14, this.daysToShow - 2);
                }
                app.render();
            }

            setFilter(assignee) {
                this.filterAssignee = assignee;
                app.render();
            }
            
            toggleCompleted(checked) {
                this.hideCompleted = checked;
                app.render();
            }

            toggleProgressCol(checked) {
                this.showProgressCol = checked;
                this.updateLayout(); // Re-calc grid width
                app.render();
            }
            
            // --- Column Resizing Logic ---
            startResize(e) {
                e.preventDefault();
                e.stopPropagation();
                this.isResizing = true;
                this.startX = e.pageX;
                this.startWidth = this.nameColWidth;
                
                const moveHandler = (e) => {
                    if (!this.isResizing) return;
                    const diff = e.pageX - this.startX;
                    const newWidth = Math.max(120, this.startWidth + diff); // Min 120px
                    this.nameColWidth = newWidth;
                    this.updateLayout();
                    app.render(); // Re-render to apply new grid template to rows
                };
                
                const upHandler = () => {
                    this.isResizing = false;
                    document.removeEventListener('mousemove', moveHandler);
                    document.removeEventListener('mouseup', upHandler);
                };
                
                document.addEventListener('mousemove', moveHandler);
                document.addEventListener('mouseup', upHandler);
            }
            
            updateLayout() {
                const container = utils.$('#view-gantt');
                if (!container) return;
                
                // Fixed widths: Start(80) + End(80) + Dur(50) + Assign(70) + (Prog(60))
                const fixedWidths = 80 + 80 + 50 + 70 + (this.showProgressCol ? 60 : 0);
                const totalGridWidth = this.nameColWidth + fixedWidths;
                
                container.style.setProperty('--name-width', `${this.nameColWidth}px`);
                container.style.setProperty('--grid-cols', `${totalGridWidth}px`);
            }

            processTasks(tasks) {
                const taskMap = new Map();
                tasks.forEach(t => taskMap.set(t.id, { ...t, children: [] }));

                const roots = [];
                tasks.forEach(t => {
                    const task = taskMap.get(t.id);
                    if (t.parentId && taskMap.has(t.parentId)) {
                        taskMap.get(t.parentId).children.push(task);
                    } else {
                        roots.push(task);
                    }
                });

                const sortFn = (a, b) => (a.order || 0) - (b.order || 0);
                const flatList = [];
                
                const processNode = (node, level) => {
                    // Auto-calculate parent data
                    if (node.children.length > 0) {
                        node.children.sort(sortFn);
                        // Calculate REAL end dates for children using working days
                        const childTimes = node.children.map(c => {
                            const start = new Date(c.start);
                            const endStr = utils.addWorkingDays(c.start, c.duration);
                            return {
                                start: start.getTime(),
                                end: new Date(endStr).getTime()
                            };
                        }).filter(t => !isNaN(t.start));
                        
                        if (childTimes.length) {
                            const minStart = Math.min(...childTimes.map(t => t.start));
                            const maxEnd = Math.max(...childTimes.map(t => t.end));
                            
                            node.start = new Date(minStart).toISOString().split('T')[0];
                            const endDateStr = new Date(maxEnd).toISOString().split('T')[0];
                            
                            // Re-calculate duration based on working days between start and max end
                            node.duration = utils.countWorkingDays(node.start, endDateStr);
                            
                            // Weighted progress
                            const totalDur = node.children.reduce((acc, c) => acc + (parseInt(c.duration)||1), 0);
                            const weightedProg = node.children.reduce((acc, c) => acc + ((parseInt(c.duration)||1) * (parseInt(c.progress)||0)), 0);
                            node.progress = totalDur ? Math.round(weightedProg / totalDur) : 0;
                            node.isSummary = true;
                        }
                    }

                    // Calculate own end date for display
                    node.endDate = utils.addWorkingDays(node.start, node.duration);

                    const isCompleted = parseInt(node.progress) === 100;
                    if (this.hideCompleted && isCompleted) return;

                    flatList.push({ ...node, level });
                    node.children.forEach(c => processNode(c, level + 1));
                };

                roots.sort(sortFn).forEach(root => processNode(root, 0));
                return flatList;
            }

            render(allTasks) {
                const container = utils.$('#view-gantt');
                
                const assignees = [...new Set(allTasks.map(t => t.assignee).filter(Boolean))].sort();
                
                let filteredTasks = [...allTasks];
                if (this.filterAssignee) {
                    filteredTasks = filteredTasks.filter(t => t.assignee === this.filterAssignee);
                }

                const displayTasks = this.processTasks(filteredTasks);

                const today = new Date();
                const viewStart = new Date(this.viewStart);
                
                // Update Timeline Width Variable
                const timelinePixelWidth = this.daysToShow * this.zoom;
                container.style.setProperty('--timeline-width', `${timelinePixelWidth}px`);
                
                // Apply Layout Variables
                this.updateLayout();

                let headerTimeline = '';
                let rowsHTML = '';
                
                for(let i=0; i<this.daysToShow; i++) {
                    const d = new Date(viewStart); d.setDate(d.getDate() + i);
                    const isToday = d.toDateString() === today.toDateString();
                    const isWeekend = d.getDay() === 0 || d.getDay() === 6;
                    
                    const dayLabel = d.getDate();
                    const weekday = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][d.getDay()];

                    headerTimeline += `
                        <div class="gantt-timeline-cell ${isWeekend ? 'bg-gray-50 text-gray-400' : ''} ${isToday ? 'bg-red-50' : ''}" style="width:${this.zoom}px">
                            <div class="text-[10px] leading-tight pt-1 ${isToday ? 'text-red-600 font-bold' : ''}">${weekday}</div>
                            <div class="text-sm font-medium ${isToday ? 'text-red-600' : ''}">${dayLabel}</div>
                            ${isToday ? `<div class="today-label" title="ä»Šå¤©æ˜¯: ${today.toLocaleDateString()}">Today</div><div class="today-line"></div>` : ''}
                        </div>`;
                }

                // Dynamic Grid Template using CSS Variable
                const gridTemplate = `var(--name-width) 80px 80px 50px 70px ${this.showProgressCol ? '60px' : '0px'}`;

                if(!displayTasks.length) {
                    rowsHTML = `<div class="p-12 text-center text-gray-400 col-span-2 bg-white">æ²’æœ‰ç¬¦åˆçš„æ’ç¨‹ä»»å‹™</div>`;
                } else {
                    displayTasks.forEach(t => {
                        const start = new Date(t.start);
                        const dayDiff = Math.ceil((start - viewStart) / (1000 * 60 * 60 * 24));
                        
                        const endDateObj = new Date(t.endDate);
                        const calendarDuration = Math.ceil((endDateObj - start) / (1000 * 60 * 60 * 24)) + 1;
                        
                        const width = Math.max(1, calendarDuration) * this.zoom;
                        const left = dayDiff * this.zoom;
                        
                        const isOverdue = t.progress < 100 && new Date(t.endDate) < today && !t.isSummary;
                        let barClass = t.isSummary ? 'is-parent' : (t.progress == 100 ? 'bg-emerald-500' : (isOverdue ? 'bg-red-500' : 'bg-indigo-500'));
                        let rowClass = t.isSummary ? 'is-parent-row' : '';

                        rowsHTML += `
                        <div class="contents group hover:bg-gray-50">
                            <!-- Left Grid (Sticky) - Converted to GRID to match header alignment -->
                            <div class="gantt-row grid border-b border-r bg-white transition-colors items-center h-[40px] sticky-left cursor-pointer ${rowClass}" 
                                 style="grid-template-columns: ${gridTemplate};"
                                 onclick="window.app.handlers.edit('gantt', '${t.id}')">
                                <div class="px-3 text-sm font-medium truncate border-r border-gray-300 flex items-center h-full" title="${t.name}">
                                    <span style="width:${t.level * 16}px" class="flex-shrink-0 inline-block"></span>
                                    ${t.level > 0 ? '<span class="text-gray-400 mr-1">â†³</span>' : ''}
                                    <span class="${t.isSummary ? 'text-slate-800' : ''}">${t.name}</span>
                                </div>
                                <div class="px-2 text-xs text-center border-r border-gray-300 text-gray-600 h-full flex items-center justify-center">${t.start.slice(5)}</div>
                                <div class="px-2 text-xs text-center border-r border-gray-300 text-gray-600 h-full flex items-center justify-center">${t.endDate ? t.endDate.slice(5) : '-'}</div>
                                <div class="px-2 text-xs text-center border-r border-gray-300 text-gray-600 h-full flex items-center justify-center">${t.duration}å¤©</div>
                                <div class="px-2 text-xs text-center border-r border-gray-300 truncate text-gray-600 h-full flex items-center justify-center">${t.assignee||'-'}</div>
                                ${this.showProgressCol ? `
                                <div class="px-2 text-xs text-center flex items-center justify-center border-r border-gray-300 h-full">
                                    <span class="px-1.5 rounded ${t.progress==100?'bg-green-100 text-green-700':'bg-gray-100 text-gray-600'}">${t.progress}%</span>
                                </div>` : ''}
                            </div>
                            
                            <!-- Timeline Row -->
                            <div class="relative h-[40px] border-b bg-white group-hover:bg-indigo-50/20 gantt-timeline-row">
                                ${Array.from({length: this.daysToShow}).map((_, i) => {
                                    const d = new Date(viewStart); d.setDate(d.getDate() + i);
                                    const isWk = d.getDay() === 0 || d.getDay() === 6;
                                    const isT = d.toDateString() === today.toDateString();
                                    return `<div class="absolute top-0 bottom-0 border-r border-gray-100 ${isWk ? 'bg-gray-50/50' : ''} ${isT ? 'bg-red-50/30' : ''}" style="left:${i * this.zoom}px; width:${this.zoom}px; z-index: 0;"></div>`
                                }).join('')}
                                
                                <div class="gantt-bar ${barClass} shadow-sm"
                                     style="left:${left}px; width:${width}px;"
                                     onclick="window.app.handlers.edit('gantt', '${t.id}')">
                                    ${!t.isSummary ? `<span class="truncate pr-1 drop-shadow-md">${t.progress}%</span>` : ''}
                                    ${isOverdue ? '<span class="absolute right-1 top-1 w-2 h-2 bg-white rounded-full animate-ping"></span>' : ''}
                                </div>
                            </div>
                        </div>`;
                    });
                }

                container.innerHTML = `
                    <div class="flex flex-col h-full bg-white rounded-lg shadow-sm border border-gray-200">
                        <!-- Toolbar -->
                        <div class="p-3 border-b bg-white flex flex-wrap gap-3 items-center justify-between no-print flex-shrink-0">
                            <div class="flex items-center gap-4">
                                <div class="flex bg-gray-100 rounded-lg p-1">
                                    <button onclick="window.app.gantt.setView('prev')" class="px-3 py-1 text-sm text-gray-600 hover:bg-white hover:shadow rounded transition-all">â—€</button>
                                    <button onclick="window.app.gantt.setView('today')" class="px-3 py-1 text-sm text-indigo-600 font-medium hover:bg-white hover:shadow rounded transition-all">ä»Šå¤©</button>
                                    <button onclick="window.app.gantt.setView('next')" class="px-3 py-1 text-sm text-gray-600 hover:bg-white hover:shadow rounded transition-all">â–¶</button>
                                </div>
                                <div class="flex items-center gap-1 text-sm text-gray-600 border px-2 py-1 rounded bg-gray-50">
                                    <span>ğŸ”</span>
                                    <button onclick="window.app.gantt.setZoom(-10)" class="w-6 h-6 flex items-center justify-center rounded hover:bg-gray-200 font-bold" title="ç¸®å°">-</button>
                                    <button onclick="window.app.gantt.setZoom(10)" class="w-6 h-6 flex items-center justify-center rounded hover:bg-gray-200 font-bold" title="æ”¾å¤§">+</button>
                                </div>
                                <div class="flex items-center gap-3 text-sm text-gray-700">
                                    <label class="flex items-center gap-1 cursor-pointer select-none">
                                        <input type="checkbox" onchange="window.app.gantt.toggleCompleted(this.checked)" ${this.hideCompleted?'checked':''} class="rounded text-indigo-600 focus:ring-indigo-500">
                                        éš±è—å·²å®Œæˆ
                                    </label>
                                    <label class="flex items-center gap-1 cursor-pointer select-none">
                                        <input type="checkbox" onchange="window.app.gantt.toggleProgressCol(this.checked)" ${this.showProgressCol?'checked':''} class="rounded text-indigo-600 focus:ring-indigo-500">
                                        é¡¯ç¤ºé€²åº¦æ¬„
                                    </label>
                                </div>
                            </div>
                            
                            <div class="flex items-center gap-3">
                                <select onchange="window.app.gantt.setFilter(this.value)" class="text-sm border rounded-md px-2 py-1.5 bg-gray-50 focus:ring-2 focus:ring-indigo-500 outline-none">
                                    <option value="">ğŸ‘¤ æ‰€æœ‰äººå“¡</option>
                                    ${assignees.map(p => `<option value="${p}" ${this.filterAssignee===p?'selected':''}>${p}</option>`).join('')}
                                </select>
                                <button onclick="window.print()" class="flex items-center gap-1 bg-gray-800 text-white px-3 py-1.5 rounded-md text-sm hover:bg-gray-700 transition-colors shadow">
                                    ğŸ–¨ï¸ åˆ—å°
                                </button>
                            </div>
                        </div>

                        <!-- Gantt Content Scrollable Area -->
                        <div class="gantt-container bg-gray-50">
                            <div class="gantt-grid-layout">
                                <!-- Sticky Header Corner -->
                                <div class="sticky-corner h-14 grid divide-x divide-gray-200 bg-gray-100 z-40" style="grid-template-columns: ${gridTemplate};">
                                    <div class="flex items-center justify-center text-xs font-bold text-gray-500 header-cell-resizable relative">
                                        ä»»å‹™åç¨±
                                        <div class="col-resizer" onmousedown="window.app.gantt.startResize(event)"></div>
                                    </div>
                                    <div class="flex items-center justify-center text-xs font-bold text-gray-500">é–‹å§‹</div>
                                    <div class="flex items-center justify-center text-xs font-bold text-gray-500">çµæŸ</div>
                                    <div class="flex items-center justify-center text-xs font-bold text-gray-500">å·¥æœŸ</div>
                                    <div class="flex items-center justify-center text-xs font-bold text-gray-500">è² è²¬äºº</div>
                                    ${this.showProgressCol ? '<div class="flex items-center justify-center text-xs font-bold text-gray-500">é€²åº¦</div>' : ''}
                                </div>
                                
                                <!-- Sticky Header Timeline -->
                                <div class="sticky-header h-14 flex relative overflow-hidden bg-white z-30">
                                    ${headerTimeline}
                                </div>
                                
                                <!-- Rows (Dynamic) -->
                                ${rowsHTML}
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        // --- Application Logic ---
        const app = {
            data: [],
            currentTab: 'todo',
            gantt: new GanttManager(),
            
            init() {
                db.init().then(() => {
                    db.sub(data => {
                        this.data = data;
                        utils.$('#loading').classList.add('hidden');
                        this.render();
                    });
                });
                
                window.app = this;
                this.handlers = {
                    del: (id) => db.del(id),
                    edit: (type, id) => this.openEditModal(type, id),
                    toGantt: (id) => this.addToGantt(id),
                    save: async (id, type) => {
                        const form = utils.$('#edit-form');
                        const payload = Object.fromEntries(new FormData(form));
                        
                        if(type === 'gantt') {
                            payload.duration = parseInt(payload.duration) || 1;
                            payload.progress = parseInt(payload.progress) || 0;
                            payload.order = parseInt(payload.order) || 0;
                            if (payload.parentId === "") payload.parentId = null;
                        }
                        
                        if(type==='todo') { 
                            const el = form.querySelector('[name=completed]');
                            payload.completed = el ? el.checked : false; 
                        }
                        if(type==='event') { 
                            const el = form.querySelector('[name=closed]');
                            payload.closed = el ? el.checked : false; 
                        }
                        
                        id ? await db.update(id, payload) : await db.add({ type, ...payload });
                        window.modal.close();
                    }
                };
            },

            switchTab(tab) {
                this.currentTab = tab;
                document.querySelectorAll('.nav-btn').forEach(b => {
                    b.classList.remove('bg-slate-700', 'shadow-inner');
                    b.classList.add('hover:bg-slate-700');
                });
                const activeBtn = utils.$(`button[data-tab="${tab}"]`);
                activeBtn.classList.add('bg-slate-700', 'shadow-inner');
                
                utils.$('#page-title').textContent = activeBtn.textContent.slice(2);
                
                const actions = utils.$('#header-actions');
                actions.innerHTML = tab === 'gantt' 
                    ? `<button onclick="window.app.openEditModal('gantt')" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 shadow-md transform hover:scale-105 transition-all flex items-center gap-2 font-medium"><span>ï¼‹</span> æ–°å¢ä»»å‹™</button>`
                    : `<button onclick="window.app.openEditModal('${tab}')" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 shadow-md transform hover:scale-105 transition-all flex items-center gap-2 font-medium"><span>ï¼‹</span> æ–°å¢é …ç›®</button>`;

                this.render();
            },

            render() {
                document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
                const view = utils.$(`#view-${this.currentTab}`);
                view.classList.remove('hidden');

                const items = this.data.filter(i => i.type === this.currentTab);
                
                if (['todo', 'event', 'feedback'].includes(this.currentTab)) {
                    view.innerHTML = renderer.table(items, CONFIG.cols[this.currentTab], this.currentTab);
                } else if (this.currentTab === 'gantt') {
                    this.gantt.render(items);
                }
            },

            openEditModal(type, id = null) {
                const item = id ? this.data.find(i => i.id === id) : {};
                let fields = [];
                
                if (type === 'todo') fields = [
                    { label: 'ç”Ÿç”¢ç·¨è™Ÿ', name: 'productionId', val: item.productionId, placeholder: 'ä¾‹å¦‚: P-2023001' },
                    { label: 'æ–™è™Ÿ', name: 'partNumber', val: item.partNumber, placeholder: 'ä¾‹å¦‚: M-5566' },
                    { label: 'ä¿®æ”¹å…§å®¹', name: 'content', type: 'textarea', val: item.content },
                    { label: 'å»ºç«‹æ—¥æœŸ', name: 'date', type: 'date', val: item.date || utils.date() }
                ];
                if (type === 'event') fields = [
                    { label: 'äº‹ä»¶æ—¥æœŸ', name: 'date', type: 'date', val: item.date || utils.date() },
                    { label: 'äº‹é …å…§å®¹', name: 'matter', val: item.matter, placeholder: 'ä¾‹å¦‚: æ©Ÿå™¨ç¶­ä¿®' },
                    { label: 'ç›¸é—œäººå“¡', name: 'personnel', val: item.personnel, placeholder: 'ä¾‹å¦‚: ç‹å°æ˜, æå¤§è¯' },
                    { label: 'å„ªå…ˆç¨‹åº¦', name: 'priority', type: 'select', opts: ['high','medium','low'], val: item.priority || 'medium' }
                ];
                if (type === 'feedback') fields = [
                    { label: 'åé¥‹é¡å‹', name: 'feedbackType', type: 'select', opts: ['ç¡¬é«”','è»Ÿé«”','å…¶ä»–'], val: item.feedbackType },
                    { label: 'å•é¡Œæè¿°', name: 'problem', type: 'textarea', val: item.problem },
                    { label: 'è§£æ±ºæ–¹æ¡ˆ (é¸å¡«)', name: 'solution', type: 'textarea', val: item.solution }
                ];
                if (type === 'gantt') {
                    const potentialParents = this.data.filter(i => i.type === 'gantt' && i.id !== id);
                    const parentOpts = [{v: '', l: 'ç„¡ (è¨­ç‚ºé ‚å±¤ä»»å‹™)'}, ...potentialParents.map(p => ({v: p.id, l: p.name}))];

                    fields = [
                        { label: 'ä»»å‹™åç¨±', name: 'name', val: item.name, placeholder: 'ä¾‹å¦‚: å°ˆæ¡ˆå•Ÿå‹•æœƒè­°' },
                        { label: 'çˆ¶ä»»å‹™', name: 'parentId', type: 'select', opts: parentOpts, val: item.parentId || '' },
                        { label: 'è² è²¬äºº', name: 'assignee', val: item.assignee, placeholder: 'ä¾‹å¦‚: å¼µç¶“ç†' },
                        { label: 'é–‹å§‹æ—¥æœŸ', name: 'start', type: 'date', val: item.start || utils.date() },
                        { label: 'å·¥æœŸ (å¤©)', name: 'duration', type: 'number', val: item.duration || 1 },
                        { label: 'ç•¶å‰é€²åº¦ (%)', name: 'progress', type: 'number', val: item.progress || 0 },
                        { label: 'æ’åºæ¬Šé‡', name: 'order', type: 'number', val: item.order || 0, placeholder: 'æ•¸å­—è¶Šå°è¶Šé å‰' }
                    ];
                }

                const extraHtml = (type === 'todo' && id) ? `<div class="mt-4 p-3 bg-gray-50 rounded border"><label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" name="completed" ${item.completed?'checked':''} class="w-5 h-5 text-indigo-600 rounded"> <span class="font-bold text-gray-700">å·²å®Œæˆæ­¤é …ç›®</span></label></div>` : 
                                  (type === 'event' && id) ? `<div class="mt-4 p-3 bg-gray-50 rounded border"><label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" name="closed" ${item.closed?'checked':''} class="w-5 h-5 text-indigo-600 rounded"> <span class="font-bold text-gray-700">æ¨™è¨˜ç‚ºå·²çµæ¡ˆ</span></label></div>` : '';

                window.modal.open(
                    id ? `âœï¸ ç·¨è¼¯${this.getTypeName(type)}` : `â• æ–°å¢${this.getTypeName(type)}`,
                    `<form id="edit-form">${renderer.form(fields, type)}${extraHtml}</form>`,
                    `<button onclick="window.modal.close()" class="px-5 py-2.5 text-gray-600 font-medium hover:bg-gray-100 rounded-lg transition-colors">å–æ¶ˆ</button>
                     <button onclick="window.app.handlers.save('${id||''}', '${type}')" class="px-5 py-2.5 bg-indigo-600 text-white font-medium rounded-lg hover:bg-indigo-700 shadow-lg hover:shadow-xl transition-all">å„²å­˜è®Šæ›´</button>`
                );
            },
            
            getTypeName(type) {
                return { 'todo': 'å¾…è¾¦', 'event': 'äº‹ä»¶', 'feedback': 'åé¥‹', 'gantt': 'æ’ç¨‹' }[type] || 'é …ç›®';
            },

            async addToGantt(eventId) {
                const event = this.data.find(i => i.id === eventId);
                const duration = event.priority === 'high' ? 3 : (event.priority === 'medium' ? 5 : 7);
                await db.add({
                    type: 'gantt', 
                    name: `[${event.priority === 'high' ? 'æ€¥' : 'ä¸€èˆ¬'}] ${event.matter}`, 
                    assignee: event.personnel,
                    start: event.date, 
                    duration: duration, 
                    progress: 0, 
                    order: 99
                });
                utils.toast('âœ… å·²å°‡äº‹ä»¶åŠ å…¥æ’ç¨‹è¡¨');
                this.switchTab('gantt');
            }
        };

        app.init();
    </script>
</body>
</html>
